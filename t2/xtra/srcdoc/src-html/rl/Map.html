<!DOCTYPE HTML PUBLIC "-//IETF//DTD HTML//EN">
<html>
<head>
<meta http-equiv="Content-Type"
content="text/html; charset=iso-8859-1">
<meta name="GENERATOR" content="GNU source-highlight 1.4
by Lorenzo Bettini, bettini@gnu.org
http://w3.newnet.it/bettini
http://www.gnu.org/software/src-highlite">
<title>.\rl\Map.java</title>
</head>
<body bgcolor="#FFFFFF" text="#000000" link="#0000EE" vlink="#551A8B" alink="#FF0000">
<pre>
<tt>
0001: <b><font color=#009900>// The root class for all maps in the tyrant universe</font></b><a name='line.1'></a>
0002: <b><font color=#009900>//</font></b><a name='line.2'></a>
0003: <b><font color=#009900>// Map contains a wide variety of functions for creating and drawing</font></b><a name='line.3'></a>
0004: <b><font color=#009900>// map elements, and also for managing the set of all objects placed</font></b><a name='line.4'></a>
0005: <b><font color=#009900>// on the map</font></b><a name='line.5'></a>
0006: <b><font color=#009900>//</font></b><a name='line.6'></a>
0007: <b><font color=#009900>// All specific types of map (dungeons, towns etc) should extend Map</font></b><a name='line.7'></a>
0008: <b><font color=#009900>//</font></b><a name='line.8'></a>
0009: <b><font color=#009900>// Some particularly useful Map creation functions:</font></b><a name='line.9'></a>
0010: <b><font color=#009900>//   setTile</font></b><a name='line.10'></a>
0011: <b><font color=#009900>//   copyArea</font></b><a name='line.11'></a>
0012: <b><font color=#009900>//   fillArea</font></b><a name='line.12'></a>
0013: <b><font color=#009900>//   fillBorder</font></b><a name='line.13'></a>
0014: <b><font color=#009900>//   rotateArea</font></b><a name='line.14'></a>
0015: <b><font color=#009900>//</font></b><a name='line.15'></a>
0016: <b><font color=#009900>// Particularly useful object management functions:</font></b><a name='line.16'></a>
0017: <b><font color=#009900>//   addThing</font></b><a name='line.17'></a>
0018: <b><font color=#009900>//   getThings</font></b><a name='line.18'></a>
0019: <b><font color=#009900>//</font></b><a name='line.19'></a>
0020: <b><font color=#009900>// Some useful AI helper functions</font></b><a name='line.20'></a>
0021: <b><font color=#009900>//   getMobile</font></b><a name='line.21'></a>
0022: <b><font color=#009900>//   getNearbyMobile</font></b><a name='line.22'></a>
0023: <b><font color=#009900>//   countNearbyMobiles</font></b><a name='line.23'></a>
0024: <b><font color=#009900>//   findNearestFoe</font></b><a name='line.24'></a>
0025: <a name='line.25'></a>
0026: <a name='line.26'></a>
0027: <b><font color=#0000FF>package</font></b> rl<font color=#FF0000>;</font><a name='line.27'></a>
0028: <a name='line.28'></a>
0029: <b><font color=#000080>import</font></b> java<font color=#FF0000>.</font>io<font color=#FF0000>.</font>Serializable<font color=#FF0000>;</font><a name='line.29'></a>
0030: <a name='line.30'></a>
0031: <b><font color=#0000FF>public</font></b> <b><font color=#0000FF>class</font></b> Map <b><font color=#0000FF>extends</font></b> Object <b><font color=#0000FF>implements</font></b> ThingOwner<font color=#FF0000>,</font> Serializable <font color=#000000>{</font><a name='line.31'></a>
0032:   <b><font color=#009900>// Map storage  </font></b><a name='line.32'></a>
0033:   <b><font color=#0000FF>protected</font></b> <font color=#0000FF>int</font><font color=#FF0000>[</font><font color=#FF0000>]</font> tiles<font color=#FF0000>;</font><a name='line.33'></a>
0034:   <b><font color=#0000FF>protected</font></b> Thing<font color=#FF0000>[</font><font color=#FF0000>]</font> objects<font color=#FF0000>;</font><a name='line.34'></a>
0035:   <b><font color=#0000FF>protected</font></b> <font color=#0000FF>int</font> width<font color=#FF0000>;</font><a name='line.35'></a>
0036:   <b><font color=#0000FF>protected</font></b> <font color=#0000FF>int</font> height<font color=#FF0000>;</font><a name='line.36'></a>
0037:   <b><font color=#0000FF>protected</font></b> <font color=#0000FF>int</font> size<font color=#FF0000>;</font><a name='line.37'></a>
0038:   <b><font color=#0000FF>protected</font></b> <font color=#0000FF>boolean</font> constructed<font color=#FF0000>=</font>false<font color=#FF0000>;</font><a name='line.38'></a>
0039:   <b><font color=#0000FF>private</font></b> <font color=#0000FF>int</font> level<font color=#FF0000>;</font><a name='line.39'></a>
0040:   <a name='line.40'></a>
0041:   <b><font color=#0000FF>public</font></b> Portal entrance<font color=#FF0000>;</font> <b><font color=#009900>// starting point</font></b><a name='line.41'></a>
0042:   <b><font color=#0000FF>public</font></b> Portal exit<font color=#FF0000>;</font>     <b><font color=#009900>// ending point</font></b><a name='line.42'></a>
0043:  <a name='line.43'></a>
0044:   <b><font color=#009900>// create the default theme</font></b><a name='line.44'></a>
0045:   <b><font color=#0000FF>public</font></b> Theme theme<font color=#FF0000>=</font><b><font color=#0000FF>new</font></b> <b><font color=#000000>Theme</font></b><font color=#FF0000>(</font><font color=#808080>"standard"</font><font color=#FF0000>)</font><font color=#FF0000>;</font><a name='line.45'></a>
0046:   <a name='line.46'></a>
0047:   <b><font color=#009900>// special state flag</font></b><a name='line.47'></a>
0048:   <b><font color=#009900>// used when dungeons switch mode</font></b><a name='line.48'></a>
0049:   <b><font color=#009900>// e.g. Emerald Dungeon super-spawn rate</font></b><a name='line.49'></a>
0050:   <b><font color=#0000FF>protected</font></b> <font color=#0000FF>int</font> mapstate<font color=#FF0000>=</font><font color=#9A1900>0</font><font color=#FF0000>;</font><a name='line.50'></a>
0051:   <a name='line.51'></a>
0052:   <b><font color=#009900>// zero is friendly</font></b><a name='line.52'></a>
0053:   <b><font color=#009900>// negative irreperable</font></b><a name='line.53'></a>
0054:   <b><font color=#009900>// postive will forget eventually</font></b><a name='line.54'></a>
0055:   <b><font color=#0000FF>public</font></b> <font color=#0000FF>int</font> angryinhabitants<font color=#FF0000>=</font><font color=#9A1900>0</font><font color=#FF0000>;</font><a name='line.55'></a>
0056: <a name='line.56'></a>
0057:   <b><font color=#009900>// pathfinding temporary sorage</font></b><a name='line.57'></a>
0058:   <b><font color=#009900>// low byte = dist to hero</font></b><a name='line.58'></a>
0059:   <b><font color=#0000FF>public</font></b> <b><font color=#0000FF>transient</font></b> <font color=#0000FF>int</font><font color=#FF0000>[</font><font color=#FF0000>]</font> path<font color=#FF0000>;</font><a name='line.59'></a>
0060: <a name='line.60'></a>
0061:   <b><font color=#009900>// default floor+wall tiles</font></b><a name='line.61'></a>
0062:   <b><font color=#0000FF>public</font></b> <font color=#0000FF>int</font> walltile<font color=#FF0000>=</font>Tile<font color=#FF0000>.</font>WALL<font color=#FF0000>;</font><a name='line.62'></a>
0063:   <b><font color=#0000FF>public</font></b> <font color=#0000FF>int</font> floortile<font color=#FF0000>=</font>Tile<font color=#FF0000>.</font>FLOOR<font color=#FF0000>;</font><a name='line.63'></a>
0064:   <a name='line.64'></a>
0065:   <a name='line.65'></a>
0066:   <b><font color=#009900>// Internal constants</font></b><a name='line.66'></a>
0067:   <b><font color=#0000FF>public</font></b> <b><font color=#0000FF>static</font></b> <b><font color=#0000FF>final</font></b> <font color=#0000FF>int</font> LOS_DETAIL<font color=#FF0000>=</font><font color=#9A1900>26</font><font color=#FF0000>;</font><a name='line.67'></a>
0068:   <a name='line.68'></a>
0069:   <a name='line.69'></a>
0070:   <b><font color=#009900>//Direction stuff</font></b><a name='line.70'></a>
0071:   <b><font color=#0000FF>public</font></b> <b><font color=#0000FF>static</font></b> <b><font color=#0000FF>final</font></b> <font color=#0000FF>int</font> DIR_NONE<font color=#FF0000>=</font><font color=#9A1900>0</font><font color=#FF0000>;</font><a name='line.71'></a>
0072:   <b><font color=#0000FF>public</font></b> <b><font color=#0000FF>static</font></b> <b><font color=#0000FF>final</font></b> <font color=#0000FF>int</font> DIR_N<font color=#FF0000>=</font><font color=#9A1900>1</font><font color=#FF0000>;</font><a name='line.72'></a>
0073:   <b><font color=#0000FF>public</font></b> <b><font color=#0000FF>static</font></b> <b><font color=#0000FF>final</font></b> <font color=#0000FF>int</font> DIR_NE<font color=#FF0000>=</font><font color=#9A1900>2</font><font color=#FF0000>;</font><a name='line.73'></a>
0074:   <b><font color=#0000FF>public</font></b> <b><font color=#0000FF>static</font></b> <b><font color=#0000FF>final</font></b> <font color=#0000FF>int</font> DIR_E<font color=#FF0000>=</font><font color=#9A1900>3</font><font color=#FF0000>;</font><a name='line.74'></a>
0075:   <b><font color=#0000FF>public</font></b> <b><font color=#0000FF>static</font></b> <b><font color=#0000FF>final</font></b> <font color=#0000FF>int</font> DIR_SE<font color=#FF0000>=</font><font color=#9A1900>4</font><font color=#FF0000>;</font><a name='line.75'></a>
0076:   <b><font color=#0000FF>public</font></b> <b><font color=#0000FF>static</font></b> <b><font color=#0000FF>final</font></b> <font color=#0000FF>int</font> DIR_S<font color=#FF0000>=</font><font color=#9A1900>5</font><font color=#FF0000>;</font><a name='line.76'></a>
0077:   <b><font color=#0000FF>public</font></b> <b><font color=#0000FF>static</font></b> <b><font color=#0000FF>final</font></b> <font color=#0000FF>int</font> DIR_SW<font color=#FF0000>=</font><font color=#9A1900>6</font><font color=#FF0000>;</font><a name='line.77'></a>
0078:   <b><font color=#0000FF>public</font></b> <b><font color=#0000FF>static</font></b> <b><font color=#0000FF>final</font></b> <font color=#0000FF>int</font> DIR_W<font color=#FF0000>=</font><font color=#9A1900>7</font><font color=#FF0000>;</font><a name='line.78'></a>
0079:   <b><font color=#0000FF>public</font></b> <b><font color=#0000FF>static</font></b> <b><font color=#0000FF>final</font></b> <font color=#0000FF>int</font> DIR_NW<font color=#FF0000>=</font><font color=#9A1900>8</font><font color=#FF0000>;</font><a name='line.79'></a>
0080:   <a name='line.80'></a>
0081:   <b><font color=#0000FF>public</font></b> <b><font color=#0000FF>static</font></b> <b><font color=#0000FF>final</font></b> <font color=#0000FF>int</font><font color=#FF0000>[</font><font color=#FF0000>]</font> DX<font color=#FF0000>=</font><font color=#000000>{</font><font color=#9A1900>0</font><font color=#FF0000>,</font><font color=#9A1900>0</font><font color=#FF0000>,</font><font color=#9A1900>1</font><font color=#FF0000>,</font><font color=#9A1900>1</font><font color=#FF0000>,</font><font color=#9A1900>1</font><font color=#FF0000>,</font><font color=#9A1900>0</font><font color=#FF0000>,</font><font color=#FF0000>-</font><font color=#9A1900>1</font><font color=#FF0000>,</font><font color=#FF0000>-</font><font color=#9A1900>1</font><font color=#FF0000>,</font><font color=#FF0000>-</font><font color=#9A1900>1</font><font color=#000000>}</font><font color=#FF0000>;</font><a name='line.81'></a>
0082:   <b><font color=#0000FF>public</font></b> <b><font color=#0000FF>static</font></b> <b><font color=#0000FF>final</font></b> <font color=#0000FF>int</font><font color=#FF0000>[</font><font color=#FF0000>]</font> DY<font color=#FF0000>=</font><font color=#000000>{</font><font color=#9A1900>0</font><font color=#FF0000>,</font><font color=#FF0000>-</font><font color=#9A1900>1</font><font color=#FF0000>,</font><font color=#FF0000>-</font><font color=#9A1900>1</font><font color=#FF0000>,</font><font color=#9A1900>0</font><font color=#FF0000>,</font><font color=#9A1900>1</font><font color=#FF0000>,</font><font color=#9A1900>1</font><font color=#FF0000>,</font><font color=#9A1900>1</font><font color=#FF0000>,</font><font color=#9A1900>0</font><font color=#FF0000>,</font><font color=#FF0000>-</font><font color=#9A1900>1</font><font color=#000000>}</font><font color=#FF0000>;</font><a name='line.82'></a>
0083:   <a name='line.83'></a>
0084:   <b><font color=#0000FF>public</font></b> <b><font color=#000000>Map</font></b><font color=#FF0000>(</font><font color=#0000FF>int</font> w<font color=#FF0000>,</font> <font color=#0000FF>int</font> h<font color=#FF0000>)</font> <font color=#000000>{</font><a name='line.84'></a>
0085:     <b><font color=#009900>// allocate arrays</font></b><a name='line.85'></a>
0086:     size<font color=#FF0000>=</font>w<font color=#FF0000>*</font>h<font color=#FF0000>;</font><a name='line.86'></a>
0087:     tiles<font color=#FF0000>=</font><b><font color=#0000FF>new</font></b> <font color=#0000FF>int</font><font color=#FF0000>[</font>size<font color=#FF0000>]</font><font color=#FF0000>;</font><a name='line.87'></a>
0088:     path<font color=#FF0000>=</font><b><font color=#0000FF>new</font></b> <font color=#0000FF>int</font><font color=#FF0000>[</font>size<font color=#FF0000>]</font><font color=#FF0000>;</font><a name='line.88'></a>
0089:     objects<font color=#FF0000>=</font><b><font color=#0000FF>new</font></b> Thing<font color=#FF0000>[</font>size<font color=#FF0000>]</font><font color=#FF0000>;</font><a name='line.89'></a>
0090:     width<font color=#FF0000>=</font>w<font color=#FF0000>;</font><a name='line.90'></a>
0091:     height<font color=#FF0000>=</font>h<font color=#FF0000>;</font><a name='line.91'></a>
0092:     entrance<font color=#FF0000>=</font><b><font color=#0000FF>null</font></b><font color=#FF0000>;</font><a name='line.92'></a>
0093:   <font color=#000000>}</font><a name='line.93'></a>
0094:   <a name='line.94'></a>
0095:   <b><font color=#0000FF>public</font></b> <font color=#0000FF>void</font> <b><font color=#000000>setTheme</font></b><font color=#FF0000>(</font>String s<font color=#FF0000>)</font> <font color=#000000>{</font><a name='line.95'></a>
0096:     <b><font color=#000000>setTheme</font></b><font color=#FF0000>(</font><b><font color=#0000FF>new</font></b> <b><font color=#000000>Theme</font></b><font color=#FF0000>(</font>s<font color=#FF0000>)</font><font color=#FF0000>)</font><font color=#FF0000>;</font> <a name='line.96'></a>
0097:   <font color=#000000>}</font><a name='line.97'></a>
0098:   <a name='line.98'></a>
0099:   <b><font color=#009900>// set the theme for the map</font></b><a name='line.99'></a>
0100:   <b><font color=#0000FF>public</font></b> <font color=#0000FF>void</font> <b><font color=#000000>setTheme</font></b><font color=#FF0000>(</font>Theme t<font color=#FF0000>)</font> <font color=#000000>{</font><a name='line.100'></a>
0101:     theme<font color=#FF0000>=</font>t<font color=#FF0000>;</font><a name='line.101'></a>
0102:     floortile<font color=#FF0000>=</font>theme<font color=#FF0000>.</font>floor<font color=#FF0000>;</font><a name='line.102'></a>
0103:     walltile<font color=#FF0000>=</font>theme<font color=#FF0000>.</font>wall<font color=#FF0000>;</font><a name='line.103'></a>
0104:   <font color=#000000>}</font><a name='line.104'></a>
0105:   <a name='line.105'></a>
0106:   <b><font color=#009900>// set the theme for the map and keep original theme for later</font></b><a name='line.106'></a>
0107:   <b><font color=#0000FF>public</font></b> <font color=#0000FF>void</font> <b><font color=#000000>newTheme</font></b><font color=#FF0000>(</font>Theme t<font color=#FF0000>)</font> <font color=#000000>{</font><a name='line.107'></a>
0108:     t<font color=#FF0000>.</font>next<font color=#FF0000>=</font>theme<font color=#FF0000>;</font><a name='line.108'></a>
0109:     <b><font color=#000000>setTheme</font></b><font color=#FF0000>(</font>t<font color=#FF0000>)</font><font color=#FF0000>;</font><a name='line.109'></a>
0110:   <font color=#000000>}</font><a name='line.110'></a>
0111:   <a name='line.111'></a>
0112:   <b><font color=#009900>// return to the original theme</font></b><a name='line.112'></a>
0113:   <b><font color=#009900>// only use after corresponding newTheme()</font></b><a name='line.113'></a>
0114:   <b><font color=#0000FF>public</font></b> <font color=#0000FF>void</font> <b><font color=#000000>oldTheme</font></b><font color=#FF0000>(</font><font color=#FF0000>)</font> <font color=#000000>{</font><a name='line.114'></a>
0115:     <b><font color=#000000>setTheme</font></b><font color=#FF0000>(</font>theme<font color=#FF0000>.</font>next<font color=#FF0000>)</font><font color=#FF0000>;</font><a name='line.115'></a>
0116:   <font color=#000000>}</font><a name='line.116'></a>
0117:   <a name='line.117'></a>
0118:   <b><font color=#009900>// set size (resets everything to blank)</font></b><a name='line.118'></a>
0119:   <b><font color=#0000FF>public</font></b> <font color=#0000FF>void</font> <b><font color=#000000>setSize</font></b><font color=#FF0000>(</font><font color=#0000FF>int</font> w<font color=#FF0000>,</font> <font color=#0000FF>int</font> h<font color=#FF0000>)</font> <font color=#000000>{</font><a name='line.119'></a>
0120:     size<font color=#FF0000>=</font>w<font color=#FF0000>*</font>h<font color=#FF0000>;</font><a name='line.120'></a>
0121:     tiles<font color=#FF0000>=</font><b><font color=#0000FF>new</font></b> <font color=#0000FF>int</font><font color=#FF0000>[</font>size<font color=#FF0000>]</font><font color=#FF0000>;</font><a name='line.121'></a>
0122:     path<font color=#FF0000>=</font><b><font color=#0000FF>new</font></b> <font color=#0000FF>int</font><font color=#FF0000>[</font>size<font color=#FF0000>]</font><font color=#FF0000>;</font><a name='line.122'></a>
0123:     objects<font color=#FF0000>=</font><b><font color=#0000FF>new</font></b> Thing<font color=#FF0000>[</font>size<font color=#FF0000>]</font><font color=#FF0000>;</font><a name='line.123'></a>
0124:     width<font color=#FF0000>=</font>w<font color=#FF0000>;</font><a name='line.124'></a>
0125:     height<font color=#FF0000>=</font>h<font color=#FF0000>;</font><a name='line.125'></a>
0126:   <font color=#000000>}</font><a name='line.126'></a>
0127:   <a name='line.127'></a>
0128:   <b><font color=#009900>// checks if hero can exit from current location</font></b><a name='line.128'></a>
0129:   <b><font color=#0000FF>public</font></b> <font color=#0000FF>boolean</font> <b><font color=#000000>canExit</font></b><font color=#FF0000>(</font><font color=#FF0000>)</font> <font color=#000000>{</font><a name='line.129'></a>
0130:     Hero h<font color=#FF0000>=</font>Game<font color=#FF0000>.</font>hero<font color=#FF0000>;</font><a name='line.130'></a>
0131:     <b><font color=#0000FF>if</font></b> <font color=#FF0000>(</font><font color=#FF0000>(</font>h<font color=#FF0000>.</font>x<font color=#FF0000>=</font><font color=#FF0000>=</font><font color=#9A1900>0</font><font color=#FF0000>)</font><font color=#FF0000>|</font><font color=#FF0000>|</font><font color=#FF0000>(</font>h<font color=#FF0000>.</font>y<font color=#FF0000>=</font><font color=#FF0000>=</font><font color=#9A1900>0</font><font color=#FF0000>)</font><font color=#FF0000>|</font><font color=#FF0000>|</font><font color=#FF0000>(</font>h<font color=#FF0000>.</font>x<font color=#FF0000>=</font><font color=#FF0000>=</font><font color=#FF0000>(</font>width<font color=#FF0000>-</font><font color=#9A1900>1</font><font color=#FF0000>)</font><font color=#FF0000>)</font><font color=#FF0000>|</font><font color=#FF0000>|</font><font color=#FF0000>(</font>h<font color=#FF0000>.</font>y<font color=#FF0000>=</font><font color=#FF0000>=</font>height<font color=#FF0000>-</font><font color=#9A1900>1</font><font color=#FF0000>)</font><font color=#FF0000>)</font> <font color=#000000>{</font><a name='line.131'></a>
0132:       <b><font color=#0000FF>return</font></b> true<font color=#FF0000>;</font> <a name='line.132'></a>
0133:     <font color=#000000>}</font> <b><font color=#0000FF>else</font></b> <font color=#000000>{</font><a name='line.133'></a>
0134:       Game<font color=#FF0000>.</font><b><font color=#000000>message</font></b><font color=#FF0000>(</font><font color=#808080>"There is no way to exit here"</font><font color=#FF0000>)</font><font color=#FF0000>;</font><a name='line.134'></a>
0135:       <b><font color=#0000FF>return</font></b> false<font color=#FF0000>;</font> <a name='line.135'></a>
0136:     <font color=#000000>}</font><a name='line.136'></a>
0137:   <font color=#000000>}</font><a name='line.137'></a>
0138:   <a name='line.138'></a>
0139:   <b><font color=#0000FF>public</font></b> <font color=#0000FF>void</font> <b><font color=#000000>setAngry</font></b><font color=#FF0000>(</font><font color=#0000FF>int</font> a<font color=#FF0000>)</font> <font color=#000000>{</font><a name='line.139'></a>
0140:     angryinhabitants<font color=#FF0000>=</font>a<font color=#FF0000>;</font> <a name='line.140'></a>
0141:   <font color=#000000>}</font><a name='line.141'></a>
0142:   <a name='line.142'></a>
0143:   <b><font color=#0000FF>public</font></b> <font color=#0000FF>boolean</font> <b><font color=#000000>isAngry</font></b><font color=#FF0000>(</font><font color=#FF0000>)</font> <font color=#000000>{</font><a name='line.143'></a>
0144:     <b><font color=#0000FF>return</font></b> <font color=#FF0000>(</font>angryinhabitants<font color=#FF0000>!</font><font color=#FF0000>=</font><font color=#9A1900>0</font><font color=#FF0000>)</font><font color=#FF0000>;</font> <a name='line.144'></a>
0145:   <font color=#000000>}</font><a name='line.145'></a>
0146:   <a name='line.146'></a>
0147:   <b><font color=#009900>// min of eight values</font></b><a name='line.147'></a>
0148:   <b><font color=#0000FF>private</font></b> <b><font color=#0000FF>static</font></b> <b><font color=#0000FF>final</font></b> <font color=#0000FF>int</font> <b><font color=#000000>min8</font></b><font color=#FF0000>(</font><font color=#0000FF>int</font> a1<font color=#FF0000>,</font><font color=#0000FF>int</font> a2<font color=#FF0000>,</font><font color=#0000FF>int</font> a3<font color=#FF0000>,</font><font color=#0000FF>int</font> a4<font color=#FF0000>,</font><font color=#0000FF>int</font> a5<font color=#FF0000>,</font><font color=#0000FF>int</font> a6<font color=#FF0000>,</font><font color=#0000FF>int</font> a7<font color=#FF0000>,</font><font color=#0000FF>int</font> a8<font color=#FF0000>)</font> <font color=#000000>{</font><a name='line.148'></a>
0149:     <b><font color=#0000FF>if</font></b> <font color=#FF0000>(</font>a2<font color=#FF0000>&lt;</font>a1<font color=#FF0000>)</font> a1<font color=#FF0000>=</font>a2<font color=#FF0000>;</font><a name='line.149'></a>
0150:     <b><font color=#0000FF>if</font></b> <font color=#FF0000>(</font>a3<font color=#FF0000>&lt;</font>a1<font color=#FF0000>)</font> a1<font color=#FF0000>=</font>a3<font color=#FF0000>;</font><a name='line.150'></a>
0151:     <b><font color=#0000FF>if</font></b> <font color=#FF0000>(</font>a4<font color=#FF0000>&lt;</font>a1<font color=#FF0000>)</font> a1<font color=#FF0000>=</font>a4<font color=#FF0000>;</font><a name='line.151'></a>
0152:     <b><font color=#0000FF>if</font></b> <font color=#FF0000>(</font>a5<font color=#FF0000>&lt;</font>a1<font color=#FF0000>)</font> a1<font color=#FF0000>=</font>a5<font color=#FF0000>;</font><a name='line.152'></a>
0153:     <b><font color=#0000FF>if</font></b> <font color=#FF0000>(</font>a6<font color=#FF0000>&lt;</font>a1<font color=#FF0000>)</font> a1<font color=#FF0000>=</font>a6<font color=#FF0000>;</font><a name='line.153'></a>
0154:     <b><font color=#0000FF>if</font></b> <font color=#FF0000>(</font>a7<font color=#FF0000>&lt;</font>a1<font color=#FF0000>)</font> a1<font color=#FF0000>=</font>a7<font color=#FF0000>;</font><a name='line.154'></a>
0155:     <b><font color=#0000FF>if</font></b> <font color=#FF0000>(</font>a8<font color=#FF0000>&lt;</font>a1<font color=#FF0000>)</font> a1<font color=#FF0000>=</font>a8<font color=#FF0000>;</font><a name='line.155'></a>
0156:     <b><font color=#0000FF>return</font></b> a1<font color=#FF0000>;</font><a name='line.156'></a>
0157:   <font color=#000000>}</font><a name='line.157'></a>
0158:   <a name='line.158'></a>
0159:   <b><font color=#009900>// calculate local paths to target square</font></b><a name='line.159'></a>
0160:   <b><font color=#009900>// i.e. creatures get fully accurate route to hero</font></b><a name='line.160'></a>
0161:   <b><font color=#009900>//   resulting path[] array contains:</font></b><a name='line.161'></a>
0162:   <b><font color=#009900>//                       0 at (px,py)</font></b><a name='line.162'></a>
0163:   <b><font color=#009900>//     distance to (px,py) at all reachable squares</font></b><a name='line.163'></a>
0164:   <b><font color=#009900>//                      -1 everywhere else</font></b><a name='line.164'></a>
0165:   <a name='line.165'></a>
0166:   <b><font color=#0000FF>public</font></b> <font color=#0000FF>void</font> <b><font color=#000000>calcPath</font></b><font color=#FF0000>(</font><font color=#0000FF>int</font> px<font color=#FF0000>,</font> <font color=#0000FF>int</font> py<font color=#FF0000>,</font> <font color=#0000FF>int</font> distance<font color=#FF0000>)</font> <font color=#000000>{</font><a name='line.166'></a>
0167:     <b><font color=#009900>// clear the path grid</font></b><a name='line.167'></a>
0168:     <b><font color=#0000FF>for</font></b> <font color=#FF0000>(</font><font color=#0000FF>int</font> x<font color=#FF0000>=</font><font color=#9A1900>0</font><font color=#FF0000>;</font> x<font color=#FF0000>&lt;</font>width<font color=#FF0000>;</font> x<font color=#FF0000>+</font><font color=#FF0000>+</font><font color=#FF0000>)</font> <b><font color=#0000FF>for</font></b> <font color=#FF0000>(</font><font color=#0000FF>int</font> y<font color=#FF0000>=</font><font color=#9A1900>0</font><font color=#FF0000>;</font> y<font color=#FF0000>&lt;</font>height<font color=#FF0000>;</font> y<font color=#FF0000>+</font><font color=#FF0000>+</font><font color=#FF0000>)</font> path<font color=#FF0000>[</font>x<font color=#FF0000>+</font>y<font color=#FF0000>*</font>width<font color=#FF0000>]</font><font color=#FF0000>=</font><font color=#FF0000>-</font><font color=#9A1900>1</font><font color=#FF0000>;</font>  <a name='line.168'></a>
0169:   <a name='line.169'></a>
0170:     path<font color=#FF0000>[</font>px<font color=#FF0000>+</font>py<font color=#FF0000>*</font>height<font color=#FF0000>]</font><font color=#FF0000>=</font><font color=#9A1900>0</font><font color=#FF0000>;</font><a name='line.170'></a>
0171:     <a name='line.171'></a>
0172:     <b><font color=#009900>// calculate distance for all surrounding squares</font></b><a name='line.172'></a>
0173:     <b><font color=#0000FF>for</font></b> <font color=#FF0000>(</font><font color=#0000FF>int</font> i<font color=#FF0000>=</font><font color=#9A1900>1</font><font color=#FF0000>;</font> i<font color=#FF0000>&lt;</font>distance<font color=#FF0000>;</font> i<font color=#FF0000>+</font><font color=#FF0000>+</font><font color=#FF0000>)</font> <font color=#000000>{</font><a name='line.173'></a>
0174:       <font color=#0000FF>int</font> x1<font color=#FF0000>=</font>RPG<font color=#FF0000>.</font><b><font color=#000000>max</font></b><font color=#FF0000>(</font><font color=#9A1900>1</font><font color=#FF0000>,</font>px<font color=#FF0000>-</font>i<font color=#FF0000>)</font><font color=#FF0000>;</font><a name='line.174'></a>
0175:       <font color=#0000FF>int</font> y1<font color=#FF0000>=</font>RPG<font color=#FF0000>.</font><b><font color=#000000>max</font></b><font color=#FF0000>(</font><font color=#9A1900>1</font><font color=#FF0000>,</font>py<font color=#FF0000>-</font>i<font color=#FF0000>)</font><font color=#FF0000>;</font><a name='line.175'></a>
0176:       <font color=#0000FF>int</font> x2<font color=#FF0000>=</font>RPG<font color=#FF0000>.</font><b><font color=#000000>min</font></b><font color=#FF0000>(</font>width<font color=#FF0000>-</font><font color=#9A1900>2</font><font color=#FF0000>,</font>px<font color=#FF0000>+</font>i<font color=#FF0000>)</font><font color=#FF0000>;</font><a name='line.176'></a>
0177:       <font color=#0000FF>int</font> y2<font color=#FF0000>=</font>RPG<font color=#FF0000>.</font><b><font color=#000000>min</font></b><font color=#FF0000>(</font>width<font color=#FF0000>-</font><font color=#9A1900>2</font><font color=#FF0000>,</font>py<font color=#FF0000>+</font>i<font color=#FF0000>)</font><font color=#FF0000>;</font><a name='line.177'></a>
0178:       <a name='line.178'></a>
0179:       <b><font color=#0000FF>for</font></b> <font color=#FF0000>(</font><font color=#0000FF>int</font> x<font color=#FF0000>=</font>x1<font color=#FF0000>;</font> x<font color=#FF0000>&lt;</font><font color=#FF0000>=</font>x2<font color=#FF0000>;</font> x<font color=#FF0000>+</font><font color=#FF0000>+</font><font color=#FF0000>)</font> <b><font color=#0000FF>for</font></b> <font color=#FF0000>(</font><font color=#0000FF>int</font> y<font color=#FF0000>=</font>y1<font color=#FF0000>;</font> y<font color=#FF0000>&lt;</font><font color=#FF0000>=</font>y2<font color=#FF0000>;</font> y<font color=#FF0000>+</font><font color=#FF0000>+</font><font color=#FF0000>)</font> <font color=#000000>{</font><a name='line.179'></a>
0180:         <font color=#0000FF>int</font> pos<font color=#FF0000>=</font>x<font color=#FF0000>+</font>y<font color=#FF0000>*</font>width<font color=#FF0000>;</font><a name='line.180'></a>
0181:         <b><font color=#0000FF>if</font></b> <font color=#FF0000>(</font><a name='line.181'></a>
0182:          <a name='line.182'></a>
0183:          <font color=#FF0000>(</font>path<font color=#FF0000>[</font>pos<font color=#FF0000>]</font><font color=#FF0000>=</font><font color=#FF0000>=</font><font color=#FF0000>-</font><font color=#9A1900>1</font><font color=#FF0000>)</font> <a name='line.183'></a>
0184:              <a name='line.184'></a>
0185:          <font color=#FF0000>&amp;</font><font color=#FF0000>&amp;</font><font color=#FF0000>(</font> <font color=#FF0000>(</font><b><font color=#000000>getTile</font></b><font color=#FF0000>(</font>x<font color=#FF0000>,</font>y<font color=#FF0000>)</font><font color=#FF0000>&amp;</font>Tile<font color=#FF0000>.</font>TF_BLOCKED<font color=#FF0000>)</font><font color=#FF0000>=</font><font color=#FF0000>=</font><font color=#9A1900>0</font> <font color=#FF0000>)</font> <a name='line.185'></a>
0186:                 <b><font color=#009900>// note - don't use isBlocked(x,y) here</font></b><a name='line.186'></a>
0187:                 <b><font color=#009900>// since we are only concerned with PERMANENT obstructions</font></b><a name='line.187'></a>
0188:          <a name='line.188'></a>
0189:          <font color=#FF0000>&amp;</font><font color=#FF0000>&amp;</font><font color=#FF0000>(</font>   <font color=#FF0000>(</font>path<font color=#FF0000>[</font>pos<font color=#FF0000>-</font>width<font color=#FF0000>-</font><font color=#9A1900>1</font><font color=#FF0000>]</font><font color=#FF0000>=</font><font color=#FF0000>=</font>i<font color=#FF0000>)</font><a name='line.189'></a>
0190:              <font color=#FF0000>|</font><font color=#FF0000>|</font><font color=#FF0000>(</font>path<font color=#FF0000>[</font>pos<font color=#FF0000>-</font>width<font color=#FF0000>]</font><font color=#FF0000>=</font><font color=#FF0000>=</font>i<font color=#FF0000>)</font><a name='line.190'></a>
0191:              <font color=#FF0000>|</font><font color=#FF0000>|</font><font color=#FF0000>(</font>path<font color=#FF0000>[</font>pos<font color=#FF0000>-</font>width<font color=#FF0000>+</font><font color=#9A1900>1</font><font color=#FF0000>]</font><font color=#FF0000>=</font><font color=#FF0000>=</font>i<font color=#FF0000>)</font><a name='line.191'></a>
0192:              <font color=#FF0000>|</font><font color=#FF0000>|</font><font color=#FF0000>(</font>path<font color=#FF0000>[</font>pos<font color=#FF0000>-</font><font color=#9A1900>1</font><font color=#FF0000>]</font><font color=#FF0000>=</font><font color=#FF0000>=</font>i<font color=#FF0000>)</font><a name='line.192'></a>
0193:              <font color=#FF0000>|</font><font color=#FF0000>|</font><font color=#FF0000>(</font>path<font color=#FF0000>[</font>pos<font color=#FF0000>+</font><font color=#9A1900>1</font><font color=#FF0000>]</font><font color=#FF0000>=</font><font color=#FF0000>=</font>i<font color=#FF0000>)</font><a name='line.193'></a>
0194:              <font color=#FF0000>|</font><font color=#FF0000>|</font><font color=#FF0000>(</font>path<font color=#FF0000>[</font>pos<font color=#FF0000>+</font>width<font color=#FF0000>-</font><font color=#9A1900>1</font><font color=#FF0000>]</font><font color=#FF0000>=</font><font color=#FF0000>=</font>i<font color=#FF0000>)</font><a name='line.194'></a>
0195:              <font color=#FF0000>|</font><font color=#FF0000>|</font><font color=#FF0000>(</font>path<font color=#FF0000>[</font>pos<font color=#FF0000>+</font>width<font color=#FF0000>]</font><font color=#FF0000>=</font><font color=#FF0000>=</font>i<font color=#FF0000>)</font><a name='line.195'></a>
0196:              <font color=#FF0000>|</font><font color=#FF0000>|</font><font color=#FF0000>(</font>path<font color=#FF0000>[</font>pos<font color=#FF0000>+</font>width<font color=#FF0000>+</font><font color=#9A1900>1</font><font color=#FF0000>]</font><font color=#FF0000>=</font><font color=#FF0000>=</font>i<font color=#FF0000>)</font>    <font color=#FF0000>)</font><a name='line.196'></a>
0197:         <font color=#FF0000>)</font> <font color=#000000>{</font><a name='line.197'></a>
0198:           path<font color=#FF0000>[</font>pos<font color=#FF0000>]</font><font color=#FF0000>=</font>i<font color=#FF0000>+</font><font color=#9A1900>1</font><font color=#FF0000>;</font>  <a name='line.198'></a>
0199:         <font color=#000000>}</font>  <a name='line.199'></a>
0200:       <font color=#000000>}</font><a name='line.200'></a>
0201:     <font color=#000000>}</font><a name='line.201'></a>
0202:     <a name='line.202'></a>
0203:     <font color=#0000FF>int</font> x1<font color=#FF0000>=</font>RPG<font color=#FF0000>.</font><b><font color=#000000>max</font></b><font color=#FF0000>(</font><font color=#9A1900>1</font><font color=#FF0000>,</font>px<font color=#FF0000>-</font>distance<font color=#FF0000>)</font><font color=#FF0000>;</font><a name='line.203'></a>
0204:     <font color=#0000FF>int</font> y1<font color=#FF0000>=</font>RPG<font color=#FF0000>.</font><b><font color=#000000>max</font></b><font color=#FF0000>(</font><font color=#9A1900>1</font><font color=#FF0000>,</font>py<font color=#FF0000>-</font>distance<font color=#FF0000>)</font><font color=#FF0000>;</font><a name='line.204'></a>
0205:     <font color=#0000FF>int</font> x2<font color=#FF0000>=</font>RPG<font color=#FF0000>.</font><b><font color=#000000>min</font></b><font color=#FF0000>(</font>width<font color=#FF0000>-</font><font color=#9A1900>2</font><font color=#FF0000>,</font>px<font color=#FF0000>+</font>distance<font color=#FF0000>)</font><font color=#FF0000>;</font><a name='line.205'></a>
0206:     <font color=#0000FF>int</font> y2<font color=#FF0000>=</font>RPG<font color=#FF0000>.</font><b><font color=#000000>min</font></b><font color=#FF0000>(</font>width<font color=#FF0000>-</font><font color=#9A1900>2</font><font color=#FF0000>,</font>py<font color=#FF0000>+</font>distance<font color=#FF0000>)</font><font color=#FF0000>;</font><a name='line.206'></a>
0207:     <a name='line.207'></a>
0208:     <b><font color=#009900>// now fill in individual square direction pointers</font></b><a name='line.208'></a>
0209:     <b><font color=#0000FF>for</font></b> <font color=#FF0000>(</font><font color=#0000FF>int</font> x<font color=#FF0000>=</font>x1<font color=#FF0000>;</font> x<font color=#FF0000>&lt;</font><font color=#FF0000>=</font>x2<font color=#FF0000>;</font> x<font color=#FF0000>+</font><font color=#FF0000>+</font><font color=#FF0000>)</font> <b><font color=#0000FF>for</font></b> <font color=#FF0000>(</font><font color=#0000FF>int</font> y<font color=#FF0000>=</font>y1<font color=#FF0000>;</font> y<font color=#FF0000>&lt;</font><font color=#FF0000>=</font>y2<font color=#FF0000>;</font> y<font color=#FF0000>+</font><font color=#FF0000>+</font><font color=#FF0000>)</font> <font color=#000000>{</font><a name='line.209'></a>
0210:       <font color=#0000FF>int</font> pos<font color=#FF0000>=</font>x<font color=#FF0000>+</font>y<font color=#FF0000>*</font>width<font color=#FF0000>;</font><a name='line.210'></a>
0211:       <font color=#0000FF>int</font> v<font color=#FF0000>=</font>path<font color=#FF0000>[</font>pos<font color=#FF0000>]</font><font color=#FF0000>;</font><a name='line.211'></a>
0212:       <b><font color=#0000FF>if</font></b> <font color=#FF0000>(</font>v<font color=#FF0000>&gt;</font><font color=#9A1900>0</font><font color=#FF0000>)</font> <font color=#000000>{</font><a name='line.212'></a>
0213:         <b><font color=#0000FF>for</font></b> <font color=#FF0000>(</font><font color=#0000FF>int</font> i<font color=#FF0000>=</font><font color=#9A1900>1</font><font color=#FF0000>;</font> i<font color=#FF0000>&lt;</font><font color=#FF0000>=</font><font color=#9A1900>8</font><font color=#FF0000>;</font> i<font color=#FF0000>+</font><font color=#FF0000>+</font><font color=#FF0000>)</font> <font color=#000000>{</font><a name='line.213'></a>
0214:           <b><font color=#0000FF>if</font></b> <font color=#FF0000>(</font>path<font color=#FF0000>[</font>pos<font color=#FF0000>+</font>DX<font color=#FF0000>[</font>i<font color=#FF0000>]</font><font color=#FF0000>+</font>width<font color=#FF0000>*</font>DY<font color=#FF0000>[</font>i<font color=#FF0000>]</font><font color=#FF0000>]</font> <font color=#FF0000>=</font><font color=#FF0000>=</font> <font color=#FF0000>(</font>v<font color=#FF0000>-</font><font color=#9A1900>1</font><font color=#FF0000>)</font><font color=#FF0000>)</font> <font color=#000000>{</font><a name='line.214'></a>
0215:             <b><font color=#000000>setTile</font></b><font color=#FF0000>(</font>x<font color=#FF0000>,</font>y<font color=#FF0000>,</font><font color=#FF0000>(</font><b><font color=#000000>getTileFull</font></b><font color=#FF0000>(</font>x<font color=#FF0000>,</font>y<font color=#FF0000>)</font><font color=#FF0000>&amp;</font><font color=#FF0000>(</font><font color=#FF0000>~</font>Tile<font color=#FF0000>.</font>TF_DIRECTION<font color=#FF0000>)</font><font color=#FF0000>)</font><font color=#FF0000>|</font><font color=#FF0000>(</font>i<font color=#FF0000>*</font>Tile<font color=#FF0000>.</font>TF_DIRECTIONBASE<font color=#FF0000>)</font><font color=#FF0000>)</font><font color=#FF0000>;</font><a name='line.215'></a>
0216:             <b><font color=#0000FF>continue</font></b><font color=#FF0000>;</font> <a name='line.216'></a>
0217:           <font color=#000000>}</font><a name='line.217'></a>
0218:         <font color=#000000>}</font><a name='line.218'></a>
0219:       <font color=#000000>}</font><a name='line.219'></a>
0220:     <font color=#000000>}</font><a name='line.220'></a>
0221:   <font color=#000000>}</font><a name='line.221'></a>
0222:   <a name='line.222'></a>
0223:   <b><font color=#009900>// fractally builds an area - square technique</font></b><a name='line.223'></a>
0224:   <b><font color=#009900>// very cool algorithm!!</font></b><a name='line.224'></a>
0225:   <b><font color=#009900>// gran must be a power of 2</font></b><a name='line.225'></a>
0226:   <b><font color=#0000FF>public</font></b> <font color=#0000FF>void</font> <b><font color=#000000>fractalize</font></b><font color=#FF0000>(</font><font color=#0000FF>int</font> x1<font color=#FF0000>,</font> <font color=#0000FF>int</font> y1<font color=#FF0000>,</font> <font color=#0000FF>int</font> x2<font color=#FF0000>,</font> <font color=#0000FF>int</font> y2<font color=#FF0000>,</font> <font color=#0000FF>int</font> gran<font color=#FF0000>)</font> <font color=#000000>{</font><a name='line.226'></a>
0227:     <font color=#0000FF>int</font> g<font color=#FF0000>=</font>gran<font color=#FF0000>/</font><font color=#9A1900>2</font><font color=#FF0000>;</font><a name='line.227'></a>
0228:     <b><font color=#0000FF>if</font></b> <font color=#FF0000>(</font>g<font color=#FF0000>&lt;</font><font color=#9A1900>1</font><font color=#FF0000>)</font> <b><font color=#0000FF>return</font></b><font color=#FF0000>;</font><a name='line.228'></a>
0229:     <b><font color=#0000FF>for</font></b> <font color=#FF0000>(</font><font color=#0000FF>int</font> y<font color=#FF0000>=</font>y1<font color=#FF0000>;</font> y<font color=#FF0000>&lt;</font><font color=#FF0000>=</font>y2<font color=#FF0000>;</font> y<font color=#FF0000>+</font><font color=#FF0000>=</font>gran<font color=#FF0000>)</font> <b><font color=#0000FF>for</font></b> <font color=#FF0000>(</font><font color=#0000FF>int</font> x<font color=#FF0000>=</font>x1<font color=#FF0000>;</font> x<font color=#FF0000>&lt;</font><font color=#FF0000>=</font>x2<font color=#FF0000>;</font> x<font color=#FF0000>+</font><font color=#FF0000>=</font>gran<font color=#FF0000>)</font> <font color=#000000>{</font><a name='line.229'></a>
0230:       <b><font color=#0000FF>if</font></b> <font color=#FF0000>(</font>RPG<font color=#FF0000>.</font><b><font color=#000000>r</font></b><font color=#FF0000>(</font><font color=#9A1900>2</font><font color=#FF0000>)</font><font color=#FF0000>=</font><font color=#FF0000>=</font><font color=#9A1900>0</font><font color=#FF0000>)</font> <b><font color=#000000>setTile</font></b><font color=#FF0000>(</font>x<font color=#FF0000>+</font>g<font color=#FF0000>,</font>y<font color=#FF0000>,</font><b><font color=#000000>getTileFull</font></b><font color=#FF0000>(</font>x<font color=#FF0000>,</font>y<font color=#FF0000>)</font><font color=#FF0000>)</font><font color=#FF0000>;</font>       <a name='line.230'></a>
0231:       <b><font color=#0000FF>else</font></b> <b><font color=#000000>setTile</font></b><font color=#FF0000>(</font>x<font color=#FF0000>+</font>g<font color=#FF0000>,</font>y<font color=#FF0000>,</font><b><font color=#000000>getTileFull</font></b><font color=#FF0000>(</font>x<font color=#FF0000>+</font>gran<font color=#FF0000>,</font>y<font color=#FF0000>)</font><font color=#FF0000>)</font><font color=#FF0000>;</font><a name='line.231'></a>
0232:       <b><font color=#0000FF>if</font></b> <font color=#FF0000>(</font>RPG<font color=#FF0000>.</font><b><font color=#000000>r</font></b><font color=#FF0000>(</font><font color=#9A1900>2</font><font color=#FF0000>)</font><font color=#FF0000>=</font><font color=#FF0000>=</font><font color=#9A1900>0</font><font color=#FF0000>)</font> <b><font color=#000000>setTile</font></b><font color=#FF0000>(</font>x<font color=#FF0000>,</font>y<font color=#FF0000>+</font>g<font color=#FF0000>,</font><b><font color=#000000>getTileFull</font></b><font color=#FF0000>(</font>x<font color=#FF0000>,</font>y<font color=#FF0000>)</font><font color=#FF0000>)</font><font color=#FF0000>;</font>       <a name='line.232'></a>
0233:       <b><font color=#0000FF>else</font></b> <b><font color=#000000>setTile</font></b><font color=#FF0000>(</font>x<font color=#FF0000>,</font>y<font color=#FF0000>+</font>g<font color=#FF0000>,</font><b><font color=#000000>getTileFull</font></b><font color=#FF0000>(</font>x<font color=#FF0000>,</font>y<font color=#FF0000>+</font>gran<font color=#FF0000>)</font><font color=#FF0000>)</font><font color=#FF0000>;</font><a name='line.233'></a>
0234:     <font color=#000000>}</font><a name='line.234'></a>
0235:     <a name='line.235'></a>
0236:     <b><font color=#009900>// now do middle tile</font></b><a name='line.236'></a>
0237:     <b><font color=#0000FF>for</font></b> <font color=#FF0000>(</font><font color=#0000FF>int</font> y<font color=#FF0000>=</font>y1<font color=#FF0000>;</font> y<font color=#FF0000>&lt;</font><font color=#FF0000>=</font>y2<font color=#FF0000>;</font> y<font color=#FF0000>+</font><font color=#FF0000>=</font>gran<font color=#FF0000>)</font> <b><font color=#0000FF>for</font></b> <font color=#FF0000>(</font><font color=#0000FF>int</font> x<font color=#FF0000>=</font>x1<font color=#FF0000>;</font> x<font color=#FF0000>&lt;</font><font color=#FF0000>=</font>x2<font color=#FF0000>;</font> x<font color=#FF0000>+</font><font color=#FF0000>=</font>gran<font color=#FF0000>)</font> <font color=#000000>{</font><a name='line.237'></a>
0238:       <font color=#0000FF>int</font> c<font color=#FF0000>;</font><a name='line.238'></a>
0239:       <b><font color=#0000FF>switch</font></b><font color=#FF0000>(</font>RPG<font color=#FF0000>.</font><b><font color=#000000>d</font></b><font color=#FF0000>(</font><font color=#9A1900>4</font><font color=#FF0000>)</font><font color=#FF0000>)</font> <font color=#000000>{</font><a name='line.239'></a>
0240:         <b><font color=#0000FF>case</font></b> <font color=#9A1900>1</font><font color=#FF0000>:</font> c<font color=#FF0000>=</font><b><font color=#000000>getTileFull</font></b><font color=#FF0000>(</font>x<font color=#FF0000>+</font>g<font color=#FF0000>,</font>y<font color=#FF0000>)</font><font color=#FF0000>;</font> <b><font color=#0000FF>break</font></b><font color=#FF0000>;</font><a name='line.240'></a>
0241:         <b><font color=#0000FF>case</font></b> <font color=#9A1900>2</font><font color=#FF0000>:</font> c<font color=#FF0000>=</font><b><font color=#000000>getTileFull</font></b><font color=#FF0000>(</font>x<font color=#FF0000>+</font>g<font color=#FF0000>,</font>y<font color=#FF0000>+</font>gran<font color=#FF0000>)</font><font color=#FF0000>;</font> <b><font color=#0000FF>break</font></b><font color=#FF0000>;</font><a name='line.241'></a>
0242:         <b><font color=#0000FF>case</font></b> <font color=#9A1900>3</font><font color=#FF0000>:</font> c<font color=#FF0000>=</font><b><font color=#000000>getTileFull</font></b><font color=#FF0000>(</font>x<font color=#FF0000>,</font>y<font color=#FF0000>+</font>g<font color=#FF0000>)</font><font color=#FF0000>;</font> <b><font color=#0000FF>break</font></b><font color=#FF0000>;</font><a name='line.242'></a>
0243:         <b><font color=#0000FF>default</font></b><font color=#FF0000>:</font> c<font color=#FF0000>=</font><b><font color=#000000>getTileFull</font></b><font color=#FF0000>(</font>x<font color=#FF0000>+</font>gran<font color=#FF0000>,</font>y<font color=#FF0000>+</font>g<font color=#FF0000>)</font><font color=#FF0000>;</font> <b><font color=#0000FF>break</font></b><font color=#FF0000>;</font><a name='line.243'></a>
0244:       <font color=#000000>}</font><a name='line.244'></a>
0245:       <b><font color=#000000>setTile</font></b><font color=#FF0000>(</font>x<font color=#FF0000>+</font>g<font color=#FF0000>,</font>y<font color=#FF0000>+</font>g<font color=#FF0000>,</font>c<font color=#FF0000>)</font><font color=#FF0000>;</font><a name='line.245'></a>
0246:     <font color=#000000>}</font><a name='line.246'></a>
0247:     <a name='line.247'></a>
0248:     <b><font color=#009900>// continue down to next level of detail</font></b><a name='line.248'></a>
0249:     <b><font color=#0000FF>if</font></b> <font color=#FF0000>(</font>g<font color=#FF0000>&gt;</font><font color=#9A1900>1</font><font color=#FF0000>)</font> <b><font color=#000000>fractalize</font></b><font color=#FF0000>(</font>x1<font color=#FF0000>,</font>y1<font color=#FF0000>,</font>x2<font color=#FF0000>,</font>y2<font color=#FF0000>,</font>g<font color=#FF0000>)</font><font color=#FF0000>;</font><a name='line.249'></a>
0250:   <font color=#000000>}</font><a name='line.250'></a>
0251:  <a name='line.251'></a>
0252:   <b><font color=#009900>// fractally builds an area - wrapping block technique</font></b><a name='line.252'></a>
0253:   <b><font color=#009900>// areas are NOT guaranteed to be connected</font></b><a name='line.253'></a>
0254:   <b><font color=#009900>// but looks prettier than vanilla fractalize</font></b><a name='line.254'></a>
0255:   <b><font color=#009900>// gran must be a power of 2</font></b><a name='line.255'></a>
0256:   <b><font color=#0000FF>public</font></b> <font color=#0000FF>void</font> <b><font color=#000000>fractalizeBlock</font></b><font color=#FF0000>(</font><font color=#0000FF>int</font> x1<font color=#FF0000>,</font> <font color=#0000FF>int</font> y1<font color=#FF0000>,</font> <font color=#0000FF>int</font> x2<font color=#FF0000>,</font> <font color=#0000FF>int</font> y2<font color=#FF0000>,</font> <font color=#0000FF>int</font> gran<font color=#FF0000>)</font> <font color=#000000>{</font><a name='line.256'></a>
0257:     <font color=#0000FF>int</font> g<font color=#FF0000>=</font>gran<font color=#FF0000>/</font><font color=#9A1900>2</font><font color=#FF0000>;</font><a name='line.257'></a>
0258:     <font color=#0000FF>int</font> mask<font color=#FF0000>=</font><font color=#FF0000>~</font><font color=#FF0000>(</font>gran<font color=#FF0000>-</font><font color=#9A1900>1</font><font color=#FF0000>)</font><font color=#FF0000>;</font><a name='line.258'></a>
0259:     <b><font color=#0000FF>if</font></b> <font color=#FF0000>(</font>g<font color=#FF0000>&lt;</font><font color=#9A1900>1</font><font color=#FF0000>)</font> <b><font color=#0000FF>return</font></b><font color=#FF0000>;</font><a name='line.259'></a>
0260:     <b><font color=#0000FF>for</font></b> <font color=#FF0000>(</font><font color=#0000FF>int</font> y<font color=#FF0000>=</font>y1<font color=#FF0000>;</font> y<font color=#FF0000>&lt;</font><font color=#FF0000>=</font>y2<font color=#FF0000>;</font> y<font color=#FF0000>+</font><font color=#FF0000>=</font>g<font color=#FF0000>)</font> <b><font color=#0000FF>for</font></b> <font color=#FF0000>(</font><font color=#0000FF>int</font> x<font color=#FF0000>=</font>x1<font color=#FF0000>;</font> x<font color=#FF0000>&lt;</font><font color=#FF0000>=</font>x2<font color=#FF0000>;</font> x<font color=#FF0000>+</font><font color=#FF0000>=</font>g<font color=#FF0000>)</font> <font color=#000000>{</font><a name='line.260'></a>
0261:       <font color=#0000FF>int</font> tx<font color=#FF0000>=</font><font color=#FF0000>(</font>RPG<font color=#FF0000>.</font><b><font color=#000000>r</font></b><font color=#FF0000>(</font><font color=#9A1900>2</font><font color=#FF0000>)</font><font color=#FF0000>=</font><font color=#FF0000>=</font><font color=#9A1900>0</font><font color=#FF0000>)</font><font color=#FF0000>?</font>x<font color=#FF0000>:</font>x<font color=#FF0000>+</font>g<font color=#FF0000>;</font><a name='line.261'></a>
0262:       <font color=#0000FF>int</font> ty<font color=#FF0000>=</font><font color=#FF0000>(</font>RPG<font color=#FF0000>.</font><b><font color=#000000>r</font></b><font color=#FF0000>(</font><font color=#9A1900>2</font><font color=#FF0000>)</font><font color=#FF0000>=</font><font color=#FF0000>=</font><font color=#9A1900>0</font><font color=#FF0000>)</font><font color=#FF0000>?</font>y<font color=#FF0000>:</font>y<font color=#FF0000>+</font>g<font color=#FF0000>;</font>       <a name='line.262'></a>
0263:       tx<font color=#FF0000>=</font><font color=#FF0000>(</font><font color=#FF0000>(</font>tx<font color=#FF0000>-</font>x1<font color=#FF0000>)</font><font color=#FF0000>&amp;</font>mask<font color=#FF0000>)</font><font color=#FF0000>+</font>x1<font color=#FF0000>;</font><a name='line.263'></a>
0264:       ty<font color=#FF0000>=</font><font color=#FF0000>(</font><font color=#FF0000>(</font>ty<font color=#FF0000>-</font>y1<font color=#FF0000>)</font><font color=#FF0000>&amp;</font>mask<font color=#FF0000>)</font><font color=#FF0000>+</font>y1<font color=#FF0000>;</font><a name='line.264'></a>
0265:       <b><font color=#000000>setTile</font></b><font color=#FF0000>(</font>x<font color=#FF0000>,</font>y<font color=#FF0000>,</font><b><font color=#000000>getTileFull</font></b><font color=#FF0000>(</font>tx<font color=#FF0000>,</font>ty<font color=#FF0000>)</font><font color=#FF0000>)</font><font color=#FF0000>;</font><a name='line.265'></a>
0266:     <font color=#000000>}</font><a name='line.266'></a>
0267:     <b><font color=#0000FF>if</font></b> <font color=#FF0000>(</font>g<font color=#FF0000>&gt;</font><font color=#9A1900>1</font><font color=#FF0000>)</font> <b><font color=#000000>fractalizeBlock</font></b><font color=#FF0000>(</font>x1<font color=#FF0000>,</font>y1<font color=#FF0000>,</font>x2<font color=#FF0000>,</font>y2<font color=#FF0000>,</font>g<font color=#FF0000>)</font><font color=#FF0000>;</font><a name='line.267'></a>
0268:   <font color=#000000>}</font>  <a name='line.268'></a>
0269:   <a name='line.269'></a>
0270:   <b><font color=#0000FF>public</font></b> <font color=#0000FF>void</font> <b><font color=#000000>calcReachable</font></b><font color=#FF0000>(</font><font color=#0000FF>int</font> px<font color=#FF0000>,</font> <font color=#0000FF>int</font> py<font color=#FF0000>)</font> <font color=#000000>{</font><a name='line.270'></a>
0271:     <b><font color=#009900>// clear the path grid</font></b><a name='line.271'></a>
0272:     <b><font color=#0000FF>for</font></b> <font color=#FF0000>(</font><font color=#0000FF>int</font> x<font color=#FF0000>=</font><font color=#9A1900>0</font><font color=#FF0000>;</font> x<font color=#FF0000>&lt;</font>width<font color=#FF0000>;</font> x<font color=#FF0000>+</font><font color=#FF0000>+</font><font color=#FF0000>)</font> <b><font color=#0000FF>for</font></b> <font color=#FF0000>(</font><font color=#0000FF>int</font> y<font color=#FF0000>=</font><font color=#9A1900>0</font><font color=#FF0000>;</font> y<font color=#FF0000>&lt;</font>height<font color=#FF0000>;</font> y<font color=#FF0000>+</font><font color=#FF0000>+</font><font color=#FF0000>)</font> path<font color=#FF0000>[</font>x<font color=#FF0000>+</font>y<font color=#FF0000>*</font>width<font color=#FF0000>]</font><font color=#FF0000>=</font><font color=#9A1900>0</font><font color=#FF0000>;</font>  <a name='line.272'></a>
0273:   <a name='line.273'></a>
0274:     path<font color=#FF0000>[</font>px<font color=#FF0000>+</font>py<font color=#FF0000>*</font>height<font color=#FF0000>]</font><font color=#FF0000>=</font><font color=#9A1900>1</font><font color=#FF0000>;</font><a name='line.274'></a>
0275:     <a name='line.275'></a>
0276:     <font color=#0000FF>boolean</font> found<font color=#FF0000>=</font>true<font color=#FF0000>;</font><a name='line.276'></a>
0277:     <a name='line.277'></a>
0278:     <b><font color=#0000FF>while</font></b> <font color=#FF0000>(</font>found<font color=#FF0000>)</font> <font color=#000000>{</font><a name='line.278'></a>
0279:       found<font color=#FF0000>=</font>false<font color=#FF0000>;</font><a name='line.279'></a>
0280:       <b><font color=#0000FF>for</font></b> <font color=#FF0000>(</font><font color=#0000FF>int</font> x<font color=#FF0000>=</font><font color=#9A1900>1</font><font color=#FF0000>;</font> x<font color=#FF0000>&lt;</font><font color=#FF0000>(</font>width<font color=#FF0000>-</font><font color=#9A1900>1</font><font color=#FF0000>)</font><font color=#FF0000>;</font> x<font color=#FF0000>+</font><font color=#FF0000>+</font><font color=#FF0000>)</font> <b><font color=#0000FF>for</font></b> <font color=#FF0000>(</font><font color=#0000FF>int</font> y<font color=#FF0000>=</font><font color=#9A1900>1</font><font color=#FF0000>;</font> y<font color=#FF0000>&lt;</font><font color=#FF0000>(</font>height<font color=#FF0000>-</font><font color=#9A1900>1</font><font color=#FF0000>)</font><font color=#FF0000>;</font> y<font color=#FF0000>+</font><font color=#FF0000>+</font><font color=#FF0000>)</font> <font color=#000000>{</font><a name='line.280'></a>
0281:         <b><font color=#0000FF>if</font></b> <font color=#FF0000>(</font><a name='line.281'></a>
0282:          <font color=#FF0000>(</font>path<font color=#FF0000>[</font>x<font color=#FF0000>+</font>y<font color=#FF0000>*</font>width<font color=#FF0000>]</font><font color=#FF0000>=</font><font color=#FF0000>=</font><font color=#9A1900>0</font><font color=#FF0000>)</font> <a name='line.282'></a>
0283:            <a name='line.283'></a>
0284:          <font color=#FF0000>&amp;</font><font color=#FF0000>&amp;</font><font color=#FF0000>(</font> <font color=#FF0000>(</font><b><font color=#000000>getTile</font></b><font color=#FF0000>(</font>x<font color=#FF0000>,</font>y<font color=#FF0000>)</font><font color=#FF0000>&amp;</font>Tile<font color=#FF0000>.</font>TF_BLOCKED<font color=#FF0000>)</font><font color=#FF0000>=</font><font color=#FF0000>=</font><font color=#9A1900>0</font> <font color=#FF0000>)</font><a name='line.284'></a>
0285:          <a name='line.285'></a>
0286:          <font color=#FF0000>&amp;</font><font color=#FF0000>&amp;</font><font color=#FF0000>(</font>   <font color=#FF0000>(</font>path<font color=#FF0000>[</font>x<font color=#FF0000>+</font><font color=#FF0000>(</font>y<font color=#FF0000>-</font><font color=#9A1900>1</font><font color=#FF0000>)</font><font color=#FF0000>*</font>width<font color=#FF0000>]</font><font color=#FF0000>=</font><font color=#FF0000>=</font><font color=#9A1900>1</font><font color=#FF0000>)</font><a name='line.286'></a>
0287:              <font color=#FF0000>|</font><font color=#FF0000>|</font><font color=#FF0000>(</font>path<font color=#FF0000>[</font>x<font color=#FF0000>+</font><font color=#9A1900>1</font><font color=#FF0000>+</font><font color=#FF0000>(</font>y<font color=#FF0000>-</font><font color=#9A1900>1</font><font color=#FF0000>)</font><font color=#FF0000>*</font>width<font color=#FF0000>]</font><font color=#FF0000>=</font><font color=#FF0000>=</font><font color=#9A1900>1</font><font color=#FF0000>)</font><a name='line.287'></a>
0288:              <font color=#FF0000>|</font><font color=#FF0000>|</font><font color=#FF0000>(</font>path<font color=#FF0000>[</font>x<font color=#FF0000>+</font><font color=#9A1900>1</font><font color=#FF0000>+</font>y<font color=#FF0000>*</font>width<font color=#FF0000>]</font><font color=#FF0000>=</font><font color=#FF0000>=</font><font color=#9A1900>1</font><font color=#FF0000>)</font><a name='line.288'></a>
0289:              <font color=#FF0000>|</font><font color=#FF0000>|</font><font color=#FF0000>(</font>path<font color=#FF0000>[</font>x<font color=#FF0000>+</font><font color=#9A1900>1</font><font color=#FF0000>+</font><font color=#FF0000>(</font>y<font color=#FF0000>+</font><font color=#9A1900>1</font><font color=#FF0000>)</font><font color=#FF0000>*</font>width<font color=#FF0000>]</font><font color=#FF0000>=</font><font color=#FF0000>=</font><font color=#9A1900>1</font><font color=#FF0000>)</font><a name='line.289'></a>
0290:              <font color=#FF0000>|</font><font color=#FF0000>|</font><font color=#FF0000>(</font>path<font color=#FF0000>[</font>x<font color=#FF0000>+</font><font color=#FF0000>(</font>y<font color=#FF0000>+</font><font color=#9A1900>1</font><font color=#FF0000>)</font><font color=#FF0000>*</font>width<font color=#FF0000>]</font><font color=#FF0000>=</font><font color=#FF0000>=</font><font color=#9A1900>1</font><font color=#FF0000>)</font><a name='line.290'></a>
0291:              <font color=#FF0000>|</font><font color=#FF0000>|</font><font color=#FF0000>(</font>path<font color=#FF0000>[</font>x<font color=#FF0000>-</font><font color=#9A1900>1</font><font color=#FF0000>+</font><font color=#FF0000>(</font>y<font color=#FF0000>+</font><font color=#9A1900>1</font><font color=#FF0000>)</font><font color=#FF0000>*</font>width<font color=#FF0000>]</font><font color=#FF0000>=</font><font color=#FF0000>=</font><font color=#9A1900>1</font><font color=#FF0000>)</font><a name='line.291'></a>
0292:              <font color=#FF0000>|</font><font color=#FF0000>|</font><font color=#FF0000>(</font>path<font color=#FF0000>[</font>x<font color=#FF0000>-</font><font color=#9A1900>1</font><font color=#FF0000>+</font>y<font color=#FF0000>*</font>width<font color=#FF0000>]</font><font color=#FF0000>=</font><font color=#FF0000>=</font><font color=#9A1900>1</font><font color=#FF0000>)</font><a name='line.292'></a>
0293:              <font color=#FF0000>|</font><font color=#FF0000>|</font><font color=#FF0000>(</font>path<font color=#FF0000>[</font>x<font color=#FF0000>-</font><font color=#9A1900>1</font><font color=#FF0000>+</font><font color=#FF0000>(</font>y<font color=#FF0000>-</font><font color=#9A1900>1</font><font color=#FF0000>)</font><font color=#FF0000>*</font>width<font color=#FF0000>]</font><font color=#FF0000>=</font><font color=#FF0000>=</font><font color=#9A1900>1</font><font color=#FF0000>)</font>   <font color=#FF0000>)</font><a name='line.293'></a>
0294:         <font color=#FF0000>)</font> <font color=#000000>{</font><a name='line.294'></a>
0295:           path<font color=#FF0000>[</font>x<font color=#FF0000>+</font>y<font color=#FF0000>*</font>width<font color=#FF0000>]</font><font color=#FF0000>=</font><font color=#9A1900>1</font><font color=#FF0000>;</font><a name='line.295'></a>
0296:           found<font color=#FF0000>=</font>true<font color=#FF0000>;</font>  <a name='line.296'></a>
0297:         <font color=#000000>}</font>  <a name='line.297'></a>
0298:       <font color=#000000>}</font><a name='line.298'></a>
0299:     <font color=#000000>}</font><a name='line.299'></a>
0300:   <font color=#000000>}</font><a name='line.300'></a>
0301: <a name='line.301'></a>
0302:   <b><font color=#009900>// replace all tiles of a certain type</font></b><a name='line.302'></a>
0303:   <b><font color=#0000FF>public</font></b> <font color=#0000FF>void</font> <b><font color=#000000>replaceTiles</font></b><font color=#FF0000>(</font><font color=#0000FF>int</font> from<font color=#FF0000>,</font> <font color=#0000FF>int</font> to<font color=#FF0000>)</font> <font color=#000000>{</font><a name='line.303'></a>
0304:     <b><font color=#0000FF>for</font></b> <font color=#FF0000>(</font><font color=#0000FF>int</font> x<font color=#FF0000>=</font><font color=#9A1900>0</font><font color=#FF0000>;</font> x<font color=#FF0000>&lt;</font>width<font color=#FF0000>;</font> x<font color=#FF0000>+</font><font color=#FF0000>+</font><font color=#FF0000>)</font> <b><font color=#0000FF>for</font></b> <font color=#FF0000>(</font><font color=#0000FF>int</font> y<font color=#FF0000>=</font><font color=#9A1900>0</font><font color=#FF0000>;</font> y<font color=#FF0000>&lt;</font>height<font color=#FF0000>;</font> y<font color=#FF0000>+</font><font color=#FF0000>+</font><font color=#FF0000>)</font> <font color=#000000>{</font><a name='line.304'></a>
0305:       <b><font color=#0000FF>if</font></b> <font color=#FF0000>(</font><b><font color=#000000>getTile</font></b><font color=#FF0000>(</font>x<font color=#FF0000>,</font>y<font color=#FF0000>)</font><font color=#FF0000>=</font><font color=#FF0000>=</font>from<font color=#FF0000>)</font> <b><font color=#000000>setTile</font></b><font color=#FF0000>(</font>x<font color=#FF0000>,</font>y<font color=#FF0000>,</font>to<font color=#FF0000>)</font><font color=#FF0000>;</font><a name='line.305'></a>
0306:     <font color=#000000>}</font>  <a name='line.306'></a>
0307:   <font color=#000000>}</font><a name='line.307'></a>
0308: <a name='line.308'></a>
0309:   <b><font color=#009900>// check if area is completely empty </font></b><a name='line.309'></a>
0310:   <b><font color=#0000FF>public</font></b> <font color=#0000FF>boolean</font> <b><font color=#000000>isBlank</font></b><font color=#FF0000>(</font><font color=#0000FF>int</font> x1<font color=#FF0000>,</font><font color=#0000FF>int</font> y1<font color=#FF0000>,</font><font color=#0000FF>int</font> x2<font color=#FF0000>,</font><font color=#0000FF>int</font> y2<font color=#FF0000>)</font> <font color=#000000>{</font><a name='line.310'></a>
0311:     <b><font color=#009900>// get right order for co-ordinates</font></b><a name='line.311'></a>
0312:     <b><font color=#0000FF>if</font></b> <font color=#FF0000>(</font>x1<font color=#FF0000>&gt;</font>x2<font color=#FF0000>)</font> <font color=#000000>{</font><font color=#0000FF>int</font> t<font color=#FF0000>=</font>x1<font color=#FF0000>;</font> x1<font color=#FF0000>=</font>x2<font color=#FF0000>;</font> x2<font color=#FF0000>=</font>t<font color=#FF0000>;</font><font color=#000000>}</font><a name='line.312'></a>
0313:     <b><font color=#0000FF>if</font></b> <font color=#FF0000>(</font>y1<font color=#FF0000>&gt;</font>y2<font color=#FF0000>)</font> <font color=#000000>{</font><font color=#0000FF>int</font> t<font color=#FF0000>=</font>y1<font color=#FF0000>;</font> y1<font color=#FF0000>=</font>y2<font color=#FF0000>;</font> y2<font color=#FF0000>=</font>t<font color=#FF0000>;</font><font color=#000000>}</font><a name='line.313'></a>
0314: <a name='line.314'></a>
0315:     <b><font color=#0000FF>for</font></b> <font color=#FF0000>(</font><font color=#0000FF>int</font> x<font color=#FF0000>=</font>x1<font color=#FF0000>;</font> x<font color=#FF0000>&lt;</font><font color=#FF0000>=</font>x2<font color=#FF0000>;</font> x<font color=#FF0000>+</font><font color=#FF0000>+</font><font color=#FF0000>)</font> <b><font color=#0000FF>for</font></b> <font color=#FF0000>(</font><font color=#0000FF>int</font> y<font color=#FF0000>=</font>y1<font color=#FF0000>;</font> y<font color=#FF0000>&lt;</font><font color=#FF0000>=</font>y2<font color=#FF0000>;</font> y<font color=#FF0000>+</font><font color=#FF0000>+</font><font color=#FF0000>)</font> <font color=#000000>{</font><a name='line.315'></a>
0316:       <b><font color=#0000FF>if</font></b> <font color=#FF0000>(</font><b><font color=#000000>getTile</font></b><font color=#FF0000>(</font>x<font color=#FF0000>,</font>y<font color=#FF0000>)</font><font color=#FF0000>!</font><font color=#FF0000>=</font><font color=#9A1900>0</font><font color=#FF0000>)</font> <b><font color=#0000FF>return</font></b> false<font color=#FF0000>;</font><a name='line.316'></a>
0317:     <font color=#000000>}</font>  <a name='line.317'></a>
0318:     <b><font color=#0000FF>return</font></b> true<font color=#FF0000>;</font>  <a name='line.318'></a>
0319:   <font color=#000000>}</font><a name='line.319'></a>
0320:   <a name='line.320'></a>
0321:   <b><font color=#0000FF>public</font></b> <font color=#0000FF>void</font> <b><font color=#000000>setLevel</font></b><font color=#FF0000>(</font><font color=#0000FF>int</font> l<font color=#FF0000>)</font> <font color=#000000>{</font><a name='line.321'></a>
0322:     level<font color=#FF0000>=</font>l<font color=#FF0000>;</font> <a name='line.322'></a>
0323:   <font color=#000000>}</font><a name='line.323'></a>
0324:   <a name='line.324'></a>
0325:   <b><font color=#009900>// get level, if not set then use hero's current level</font></b><a name='line.325'></a>
0326:   <b><font color=#0000FF>public</font></b> <font color=#0000FF>int</font> <b><font color=#000000>getLevel</font></b><font color=#FF0000>(</font><font color=#FF0000>)</font> <font color=#000000>{</font><a name='line.326'></a>
0327:     <b><font color=#0000FF>if</font></b> <font color=#FF0000>(</font>level<font color=#FF0000>&gt;</font><font color=#9A1900>0</font><font color=#FF0000>)</font> <b><font color=#0000FF>return</font></b> level<font color=#FF0000>;</font><a name='line.327'></a>
0328:     <b><font color=#000000>setLevel</font></b><font color=#FF0000>(</font><font color=#FF0000>(</font>Game<font color=#FF0000>.</font>hero<font color=#FF0000>=</font><font color=#FF0000>=</font><b><font color=#0000FF>null</font></b><font color=#FF0000>)</font><font color=#FF0000>?</font><font color=#9A1900>1</font><font color=#FF0000>:</font>Game<font color=#FF0000>.</font>hero<font color=#FF0000>.</font><b><font color=#000000>getStat</font></b><font color=#FF0000>(</font>RPG<font color=#FF0000>.</font>ST_LEVEL<font color=#FF0000>)</font><font color=#FF0000>)</font><font color=#FF0000>;</font><a name='line.328'></a>
0329:     <b><font color=#0000FF>return</font></b> level<font color=#FF0000>;</font> <a name='line.329'></a>
0330:   <font color=#000000>}</font><a name='line.330'></a>
0331:   <a name='line.331'></a>
0332:   <b><font color=#009900>// count tiles of particular type in rectangular area</font></b><a name='line.332'></a>
0333:   <b><font color=#0000FF>public</font></b> <font color=#0000FF>int</font> <b><font color=#000000>countTiles</font></b><font color=#FF0000>(</font><font color=#0000FF>int</font> x1<font color=#FF0000>,</font><font color=#0000FF>int</font> y1<font color=#FF0000>,</font><font color=#0000FF>int</font> x2<font color=#FF0000>,</font><font color=#0000FF>int</font> y2<font color=#FF0000>,</font> <font color=#0000FF>int</font> c<font color=#FF0000>)</font> <font color=#000000>{</font><a name='line.333'></a>
0334:     <font color=#0000FF>int</font> count<font color=#FF0000>=</font><font color=#9A1900>0</font><font color=#FF0000>;</font><a name='line.334'></a>
0335:     <b><font color=#0000FF>for</font></b> <font color=#FF0000>(</font><font color=#0000FF>int</font> x<font color=#FF0000>=</font>x1<font color=#FF0000>;</font> x<font color=#FF0000>&lt;</font><font color=#FF0000>=</font>x2<font color=#FF0000>;</font> x<font color=#FF0000>+</font><font color=#FF0000>+</font><font color=#FF0000>)</font> <b><font color=#0000FF>for</font></b> <font color=#FF0000>(</font><font color=#0000FF>int</font> y<font color=#FF0000>=</font>y1<font color=#FF0000>;</font> y<font color=#FF0000>&lt;</font><font color=#FF0000>=</font>y2<font color=#FF0000>;</font> y<font color=#FF0000>+</font><font color=#FF0000>+</font><font color=#FF0000>)</font> <font color=#000000>{</font><a name='line.335'></a>
0336:       <b><font color=#0000FF>if</font></b> <font color=#FF0000>(</font><b><font color=#000000>getTile</font></b><font color=#FF0000>(</font>x<font color=#FF0000>,</font>y<font color=#FF0000>)</font><font color=#FF0000>=</font><font color=#FF0000>=</font>c<font color=#FF0000>)</font> count<font color=#FF0000>+</font><font color=#FF0000>+</font><font color=#FF0000>;</font><a name='line.336'></a>
0337:     <font color=#000000>}</font>  <a name='line.337'></a>
0338:     <b><font color=#0000FF>return</font></b> count<font color=#FF0000>;</font><a name='line.338'></a>
0339:   <font color=#000000>}</font><a name='line.339'></a>
0340:   <a name='line.340'></a>
0341:   <b><font color=#009900>// fills rectangular map area with specified tile</font></b><a name='line.341'></a>
0342:   <b><font color=#0000FF>public</font></b> <font color=#0000FF>void</font> <b><font color=#000000>fillArea</font></b><font color=#FF0000>(</font><font color=#0000FF>int</font> x1<font color=#FF0000>,</font><font color=#0000FF>int</font> y1<font color=#FF0000>,</font><font color=#0000FF>int</font> x2<font color=#FF0000>,</font><font color=#0000FF>int</font> y2<font color=#FF0000>,</font> <font color=#0000FF>int</font> c<font color=#FF0000>)</font> <font color=#000000>{</font><a name='line.342'></a>
0343:     <b><font color=#0000FF>if</font></b> <font color=#FF0000>(</font>x1<font color=#FF0000>&gt;</font>x2<font color=#FF0000>)</font> <font color=#000000>{</font><font color=#0000FF>int</font> t<font color=#FF0000>=</font>x1<font color=#FF0000>;</font> x1<font color=#FF0000>=</font>x2<font color=#FF0000>;</font> x2<font color=#FF0000>=</font>t<font color=#FF0000>;</font><font color=#000000>}</font><a name='line.343'></a>
0344:     <b><font color=#0000FF>if</font></b> <font color=#FF0000>(</font>y1<font color=#FF0000>&gt;</font>y2<font color=#FF0000>)</font> <font color=#000000>{</font><font color=#0000FF>int</font> t<font color=#FF0000>=</font>y1<font color=#FF0000>;</font> y1<font color=#FF0000>=</font>y2<font color=#FF0000>;</font> y2<font color=#FF0000>=</font>t<font color=#FF0000>;</font><font color=#000000>}</font><a name='line.344'></a>
0345:     <b><font color=#0000FF>for</font></b> <font color=#FF0000>(</font><font color=#0000FF>int</font> x<font color=#FF0000>=</font>x1<font color=#FF0000>;</font> x<font color=#FF0000>&lt;</font><font color=#FF0000>=</font>x2<font color=#FF0000>;</font> x<font color=#FF0000>+</font><font color=#FF0000>+</font><font color=#FF0000>)</font> <b><font color=#0000FF>for</font></b> <font color=#FF0000>(</font><font color=#0000FF>int</font> y<font color=#FF0000>=</font>y1<font color=#FF0000>;</font> y<font color=#FF0000>&lt;</font><font color=#FF0000>=</font>y2<font color=#FF0000>;</font> y<font color=#FF0000>+</font><font color=#FF0000>+</font><font color=#FF0000>)</font> <font color=#000000>{</font><a name='line.345'></a>
0346:       <b><font color=#000000>setTile</font></b><font color=#FF0000>(</font>x<font color=#FF0000>,</font>y<font color=#FF0000>,</font>c<font color=#FF0000>)</font><font color=#FF0000>;</font>  <a name='line.346'></a>
0347:     <font color=#000000>}</font>  <a name='line.347'></a>
0348:   <font color=#000000>}</font><a name='line.348'></a>
0349:   <a name='line.349'></a>
0350:   <b><font color=#0000FF>public</font></b> <font color=#0000FF>void</font> <b><font color=#000000>fillRoom</font></b><font color=#FF0000>(</font><font color=#0000FF>int</font> x1<font color=#FF0000>,</font> <font color=#0000FF>int</font> y1<font color=#FF0000>,</font><font color=#0000FF>int</font> x2<font color=#FF0000>,</font><font color=#0000FF>int</font> y2<font color=#FF0000>,</font> <font color=#0000FF>int</font> wall<font color=#FF0000>,</font> <font color=#0000FF>int</font> floor<font color=#FF0000>)</font> <font color=#000000>{</font><a name='line.350'></a>
0351:     <b><font color=#000000>fillArea</font></b><font color=#FF0000>(</font>x1<font color=#FF0000>+</font><font color=#9A1900>1</font><font color=#FF0000>,</font>y1<font color=#FF0000>+</font><font color=#9A1900>1</font><font color=#FF0000>,</font>x2<font color=#FF0000>-</font><font color=#9A1900>1</font><font color=#FF0000>,</font>y2<font color=#FF0000>-</font><font color=#9A1900>1</font><font color=#FF0000>,</font>floor<font color=#FF0000>)</font><font color=#FF0000>;</font><a name='line.351'></a>
0352:     <b><font color=#000000>fillBorder</font></b><font color=#FF0000>(</font>x1<font color=#FF0000>,</font>y1<font color=#FF0000>,</font>x2<font color=#FF0000>,</font>y2<font color=#FF0000>,</font>wall<font color=#FF0000>)</font><font color=#FF0000>;</font> <a name='line.352'></a>
0353:   <font color=#000000>}</font><a name='line.353'></a>
0354:   <a name='line.354'></a>
0355:   <b><font color=#009900>// clears all objects from area</font></b><a name='line.355'></a>
0356:   <b><font color=#009900>// use with EXTREME caution</font></b><a name='line.356'></a>
0357:   <b><font color=#009900>// don't kill portals, secret doors, artifacts etc!!!</font></b><a name='line.357'></a>
0358:   <b><font color=#0000FF>public</font></b> <font color=#0000FF>void</font> <b><font color=#000000>clearArea</font></b><font color=#FF0000>(</font><font color=#0000FF>int</font> x1<font color=#FF0000>,</font> <font color=#0000FF>int</font> y1<font color=#FF0000>,</font> <font color=#0000FF>int</font> x2<font color=#FF0000>,</font> <font color=#0000FF>int</font> y2<font color=#FF0000>)</font> <font color=#000000>{</font><a name='line.358'></a>
0359:     Thing<font color=#FF0000>[</font><font color=#FF0000>]</font> things<font color=#FF0000>=</font><b><font color=#000000>getThings</font></b><font color=#FF0000>(</font>x1<font color=#FF0000>,</font>y1<font color=#FF0000>,</font>x2<font color=#FF0000>,</font>y2<font color=#FF0000>)</font><font color=#FF0000>;</font><a name='line.359'></a>
0360:     <b><font color=#0000FF>for</font></b> <font color=#FF0000>(</font><font color=#0000FF>int</font> i<font color=#FF0000>=</font><font color=#9A1900>0</font><font color=#FF0000>;</font> i<font color=#FF0000>&lt;</font>things<font color=#FF0000>.</font>length<font color=#FF0000>;</font> i<font color=#FF0000>+</font><font color=#FF0000>+</font><font color=#FF0000>)</font> <font color=#000000>{</font><a name='line.360'></a>
0361:       things<font color=#FF0000>[</font>i<font color=#FF0000>]</font><font color=#FF0000>.</font><b><font color=#000000>remove</font></b><font color=#FF0000>(</font><font color=#FF0000>)</font><font color=#FF0000>;</font> <a name='line.361'></a>
0362:     <font color=#000000>}</font><a name='line.362'></a>
0363:   <font color=#000000>}</font><a name='line.363'></a>
0364: <a name='line.364'></a>
0365:   <b><font color=#009900>// clear area and fill with specified tile</font></b><a name='line.365'></a>
0366:   <b><font color=#0000FF>public</font></b> <font color=#0000FF>void</font> <b><font color=#000000>clearArea</font></b><font color=#FF0000>(</font><font color=#0000FF>int</font> x1<font color=#FF0000>,</font> <font color=#0000FF>int</font> y1<font color=#FF0000>,</font> <font color=#0000FF>int</font> x2<font color=#FF0000>,</font> <font color=#0000FF>int</font> y2<font color=#FF0000>,</font><font color=#0000FF>int</font> c<font color=#FF0000>)</font> <font color=#000000>{</font><a name='line.366'></a>
0367:     <b><font color=#000000>clearArea</font></b><font color=#FF0000>(</font>x1<font color=#FF0000>,</font>y1<font color=#FF0000>,</font>x2<font color=#FF0000>,</font>y2<font color=#FF0000>)</font><font color=#FF0000>;</font><a name='line.367'></a>
0368:     <b><font color=#000000>fillArea</font></b><font color=#FF0000>(</font>x1<font color=#FF0000>,</font>y1<font color=#FF0000>,</font>x2<font color=#FF0000>,</font>y2<font color=#FF0000>,</font>c<font color=#FF0000>)</font><font color=#FF0000>;</font><a name='line.368'></a>
0369:   <font color=#000000>}</font>  <a name='line.369'></a>
0370:   <a name='line.370'></a>
0371:   <b><font color=#009900>// spread src tiles over dst tiles</font></b><a name='line.371'></a>
0372:   <b><font color=#009900>// do this by filling adjacent squares</font></b><a name='line.372'></a>
0373:   <b><font color=#0000FF>public</font></b> <font color=#0000FF>void</font> <b><font color=#000000>spreadTiles</font></b><font color=#FF0000>(</font><font color=#0000FF>int</font> x1<font color=#FF0000>,</font><font color=#0000FF>int</font> y1<font color=#FF0000>,</font><font color=#0000FF>int</font> x2<font color=#FF0000>,</font><font color=#0000FF>int</font> y2<font color=#FF0000>,</font> <font color=#0000FF>int</font> src<font color=#FF0000>,</font> <font color=#0000FF>int</font> des<font color=#FF0000>)</font> <font color=#000000>{</font><a name='line.373'></a>
0374:     <b><font color=#0000FF>for</font></b> <font color=#FF0000>(</font><font color=#0000FF>int</font> x<font color=#FF0000>=</font>x1<font color=#FF0000>;</font> x<font color=#FF0000>&lt;</font><font color=#FF0000>=</font>x2<font color=#FF0000>;</font> x<font color=#FF0000>+</font><font color=#FF0000>+</font><font color=#FF0000>)</font> <b><font color=#0000FF>for</font></b> <font color=#FF0000>(</font><font color=#0000FF>int</font> y<font color=#FF0000>=</font>y1<font color=#FF0000>;</font> y<font color=#FF0000>&lt;</font><font color=#FF0000>=</font>y2<font color=#FF0000>;</font> y<font color=#FF0000>+</font><font color=#FF0000>+</font><font color=#FF0000>)</font> <font color=#000000>{</font><a name='line.374'></a>
0375:       <b><font color=#0000FF>if</font></b> <font color=#FF0000>(</font><b><font color=#000000>getTile</font></b><font color=#FF0000>(</font>x<font color=#FF0000>,</font>y<font color=#FF0000>)</font><font color=#FF0000>=</font><font color=#FF0000>=</font>des<font color=#FF0000>)</font> <font color=#000000>{</font><a name='line.375'></a>
0376:         <b><font color=#0000FF>for</font></b> <font color=#FF0000>(</font><font color=#0000FF>int</font> dx<font color=#FF0000>=</font><font color=#FF0000>-</font><font color=#9A1900>1</font><font color=#FF0000>;</font> dx<font color=#FF0000>&lt;</font><font color=#FF0000>=</font><font color=#9A1900>1</font><font color=#FF0000>;</font> dx<font color=#FF0000>+</font><font color=#FF0000>+</font><font color=#FF0000>)</font> <b><font color=#0000FF>for</font></b> <font color=#FF0000>(</font><font color=#0000FF>int</font> dy<font color=#FF0000>=</font><font color=#FF0000>-</font><font color=#9A1900>1</font><font color=#FF0000>;</font> dy<font color=#FF0000>&lt;</font><font color=#FF0000>=</font><font color=#9A1900>1</font><font color=#FF0000>;</font> dy<font color=#FF0000>+</font><font color=#FF0000>+</font><font color=#FF0000>)</font> <font color=#000000>{</font><a name='line.376'></a>
0377:           <b><font color=#0000FF>if</font></b> <font color=#FF0000>(</font><b><font color=#000000>getTile</font></b><font color=#FF0000>(</font>x<font color=#FF0000>+</font>dx<font color=#FF0000>,</font>y<font color=#FF0000>+</font>dy<font color=#FF0000>)</font><font color=#FF0000>=</font><font color=#FF0000>=</font>src<font color=#FF0000>)</font> <b><font color=#000000>setTile</font></b><font color=#FF0000>(</font>x<font color=#FF0000>,</font>y<font color=#FF0000>,</font><font color=#9A1900>65535</font><font color=#FF0000>)</font><font color=#FF0000>;</font><a name='line.377'></a>
0378:         <font color=#000000>}</font>  <a name='line.378'></a>
0379:       <font color=#000000>}</font>  <a name='line.379'></a>
0380:     <font color=#000000>}</font><a name='line.380'></a>
0381:     <b><font color=#000000>replaceTiles</font></b><font color=#FF0000>(</font><font color=#9A1900>65535</font><font color=#FF0000>,</font>src<font color=#FF0000>)</font><font color=#FF0000>;</font>  <a name='line.381'></a>
0382:   <font color=#000000>}</font><a name='line.382'></a>
0383:  <a name='line.383'></a>
0384:   <b><font color=#009900>// randomly shakes tiles in area to blur outlines</font></b><a name='line.384'></a>
0385:   <b><font color=#009900>// useful to create irregular patterns</font></b><a name='line.385'></a>
0386:   <b><font color=#0000FF>public</font></b> <font color=#0000FF>void</font> <b><font color=#000000>blurArea</font></b><font color=#FF0000>(</font><font color=#0000FF>int</font> x1<font color=#FF0000>,</font> <font color=#0000FF>int</font> y1<font color=#FF0000>,</font> <font color=#0000FF>int</font> x2<font color=#FF0000>,</font> <font color=#0000FF>int</font> y2<font color=#FF0000>)</font> <font color=#000000>{</font><a name='line.386'></a>
0387:     <b><font color=#0000FF>for</font></b> <font color=#FF0000>(</font><font color=#0000FF>int</font> i<font color=#FF0000>=</font><font color=#9A1900>0</font><font color=#FF0000>;</font> i<font color=#FF0000>&lt;</font><font color=#FF0000>(</font><font color=#FF0000>(</font>x2<font color=#FF0000>-</font>x1<font color=#FF0000>+</font><font color=#9A1900>1</font><font color=#FF0000>)</font><font color=#FF0000>*</font><font color=#FF0000>(</font>y2<font color=#FF0000>-</font>y1<font color=#FF0000>+</font><font color=#9A1900>1</font><font color=#FF0000>)</font><font color=#FF0000>/</font><font color=#9A1900>4</font><font color=#FF0000>)</font><font color=#FF0000>;</font> i<font color=#FF0000>+</font><font color=#FF0000>+</font><font color=#FF0000>)</font> <font color=#000000>{</font><a name='line.387'></a>
0388:       <font color=#0000FF>int</font> sx<font color=#FF0000>=</font>RPG<font color=#FF0000>.</font><b><font color=#000000>rspread</font></b><font color=#FF0000>(</font>x1<font color=#FF0000>+</font><font color=#9A1900>1</font><font color=#FF0000>,</font>x2<font color=#FF0000>-</font><font color=#9A1900>1</font><font color=#FF0000>)</font><font color=#FF0000>;</font> <a name='line.388'></a>
0389:       <font color=#0000FF>int</font> sy<font color=#FF0000>=</font>RPG<font color=#FF0000>.</font><b><font color=#000000>rspread</font></b><font color=#FF0000>(</font>y1<font color=#FF0000>+</font><font color=#9A1900>1</font><font color=#FF0000>,</font>y2<font color=#FF0000>-</font><font color=#9A1900>1</font><font color=#FF0000>)</font><font color=#FF0000>;</font> <a name='line.389'></a>
0390:       <font color=#0000FF>int</font> dx<font color=#FF0000>=</font>sx<font color=#FF0000>+</font>RPG<font color=#FF0000>.</font><b><font color=#000000>r</font></b><font color=#FF0000>(</font><font color=#9A1900>3</font><font color=#FF0000>)</font><font color=#FF0000>-</font><font color=#9A1900>1</font><font color=#FF0000>;</font><a name='line.390'></a>
0391:       <font color=#0000FF>int</font> dy<font color=#FF0000>=</font>sy<font color=#FF0000>+</font>RPG<font color=#FF0000>.</font><b><font color=#000000>r</font></b><font color=#FF0000>(</font><font color=#9A1900>3</font><font color=#FF0000>)</font><font color=#FF0000>-</font><font color=#9A1900>1</font><font color=#FF0000>;</font><a name='line.391'></a>
0392:       <font color=#0000FF>int</font> t<font color=#FF0000>=</font><b><font color=#000000>getTileFull</font></b><font color=#FF0000>(</font>sx<font color=#FF0000>,</font>sy<font color=#FF0000>)</font><font color=#FF0000>;</font><a name='line.392'></a>
0393:       <b><font color=#000000>setTile</font></b><font color=#FF0000>(</font>sx<font color=#FF0000>,</font>sx<font color=#FF0000>,</font><b><font color=#000000>getTileFull</font></b><font color=#FF0000>(</font>dx<font color=#FF0000>,</font>dy<font color=#FF0000>)</font><font color=#FF0000>)</font><font color=#FF0000>;</font><a name='line.393'></a>
0394:       <b><font color=#000000>setTile</font></b><font color=#FF0000>(</font>dx<font color=#FF0000>,</font>dy<font color=#FF0000>,</font>t<font color=#FF0000>)</font><font color=#FF0000>;</font><a name='line.394'></a>
0395:     <font color=#000000>}</font><a name='line.395'></a>
0396:   <font color=#000000>}</font><a name='line.396'></a>
0397: <a name='line.397'></a>
0398:   <b><font color=#009900>// rotates a square map region by &lt;count&gt; right angles</font></b><a name='line.398'></a>
0399:   <b><font color=#009900>// rotates in a clockwize direction</font></b><a name='line.399'></a>
0400:   <b><font color=#0000FF>public</font></b> <font color=#0000FF>void</font> <b><font color=#000000>rotateArea</font></b><font color=#FF0000>(</font><font color=#0000FF>int</font> x<font color=#FF0000>,</font> <font color=#0000FF>int</font> y<font color=#FF0000>,</font> <font color=#0000FF>int</font> size<font color=#FF0000>,</font> <font color=#0000FF>int</font> count<font color=#FF0000>)</font> <font color=#000000>{</font><a name='line.400'></a>
0401:     <b><font color=#009900>// make rotation in range 0-3</font></b><a name='line.401'></a>
0402:     count<font color=#FF0000>&amp;</font><font color=#FF0000>=</font><font color=#9A1900>3</font><font color=#FF0000>;</font><a name='line.402'></a>
0403:     <a name='line.403'></a>
0404:     <b><font color=#009900>// bail out or recurse as needed</font></b><a name='line.404'></a>
0405:     <b><font color=#0000FF>if</font></b> <font color=#FF0000>(</font>count<font color=#FF0000>=</font><font color=#FF0000>=</font><font color=#9A1900>0</font><font color=#FF0000>)</font> <b><font color=#0000FF>return</font></b><font color=#FF0000>;</font><a name='line.405'></a>
0406:     <b><font color=#0000FF>if</font></b> <font color=#FF0000>(</font>count<font color=#FF0000>&gt;</font><font color=#9A1900>1</font><font color=#FF0000>)</font> <b><font color=#000000>rotateArea</font></b><font color=#FF0000>(</font>x<font color=#FF0000>,</font>y<font color=#FF0000>,</font>size<font color=#FF0000>,</font>count<font color=#FF0000>-</font><font color=#9A1900>1</font><font color=#FF0000>)</font><font color=#FF0000>;</font><a name='line.406'></a>
0407:     <a name='line.407'></a>
0408:     <b><font color=#009900>// rotate map objects</font></b><a name='line.408'></a>
0409:     Thing<font color=#FF0000>[</font><font color=#FF0000>]</font> things<font color=#FF0000>=</font><b><font color=#000000>getThings</font></b><font color=#FF0000>(</font>x<font color=#FF0000>,</font>y<font color=#FF0000>,</font>x<font color=#FF0000>+</font>size<font color=#FF0000>-</font><font color=#9A1900>1</font><font color=#FF0000>,</font>y<font color=#FF0000>+</font>size<font color=#FF0000>-</font><font color=#9A1900>1</font><font color=#FF0000>)</font><font color=#FF0000>;</font><a name='line.409'></a>
0410:     <b><font color=#0000FF>for</font></b> <font color=#FF0000>(</font><font color=#0000FF>int</font> i<font color=#FF0000>=</font><font color=#9A1900>0</font><font color=#FF0000>;</font> i<font color=#FF0000>&lt;</font>things<font color=#FF0000>.</font>length<font color=#FF0000>;</font> i<font color=#FF0000>+</font><font color=#FF0000>+</font><font color=#FF0000>)</font> <font color=#000000>{</font><a name='line.410'></a>
0411:       Thing t<font color=#FF0000>=</font>things<font color=#FF0000>[</font>i<font color=#FF0000>]</font><font color=#FF0000>;</font><a name='line.411'></a>
0412:       <font color=#0000FF>int</font> nx<font color=#FF0000>=</font>x<font color=#FF0000>+</font>size<font color=#FF0000>-</font><font color=#9A1900>1</font><font color=#FF0000>-</font><font color=#FF0000>(</font>t<font color=#FF0000>.</font>y<font color=#FF0000>-</font>y<font color=#FF0000>)</font><font color=#FF0000>;</font><a name='line.412'></a>
0413:       <font color=#0000FF>int</font> ny<font color=#FF0000>=</font>y<font color=#FF0000>+</font><font color=#FF0000>(</font>t<font color=#FF0000>.</font>x<font color=#FF0000>-</font>x<font color=#FF0000>)</font><font color=#FF0000>;</font><a name='line.413'></a>
0414:       <b><font color=#000000>addThing</font></b><font color=#FF0000>(</font>t<font color=#FF0000>,</font>nx<font color=#FF0000>,</font>ny<font color=#FF0000>)</font><font color=#FF0000>;</font> <a name='line.414'></a>
0415:     <font color=#000000>}</font><a name='line.415'></a>
0416:     <a name='line.416'></a>
0417:     <b><font color=#009900>// rotate tiles</font></b><a name='line.417'></a>
0418:     <b><font color=#0000FF>for</font></b> <font color=#FF0000>(</font><font color=#0000FF>int</font> p<font color=#FF0000>=</font><font color=#9A1900>0</font><font color=#FF0000>;</font> p<font color=#FF0000>&lt;</font><font color=#FF0000>(</font><font color=#FF0000>(</font>size<font color=#FF0000>+</font><font color=#9A1900>1</font><font color=#FF0000>)</font><font color=#FF0000>/</font><font color=#9A1900>2</font><font color=#FF0000>)</font><font color=#FF0000>;</font> p<font color=#FF0000>+</font><font color=#FF0000>+</font><font color=#FF0000>)</font> <b><font color=#0000FF>for</font></b> <font color=#FF0000>(</font><font color=#0000FF>int</font> q<font color=#FF0000>=</font><font color=#9A1900>0</font><font color=#FF0000>;</font> q<font color=#FF0000>&lt;</font><font color=#FF0000>(</font>size<font color=#FF0000>/</font><font color=#9A1900>2</font><font color=#FF0000>)</font><font color=#FF0000>;</font> q<font color=#FF0000>+</font><font color=#FF0000>+</font><font color=#FF0000>)</font> <font color=#000000>{</font><a name='line.418'></a>
0419:       <font color=#0000FF>int</font> temp<font color=#FF0000>=</font><b><font color=#000000>getTileFull</font></b><font color=#FF0000>(</font>x<font color=#FF0000>+</font>p<font color=#FF0000>,</font>y<font color=#FF0000>+</font>q<font color=#FF0000>)</font><font color=#FF0000>;</font><a name='line.419'></a>
0420:       <b><font color=#000000>setTile</font></b><font color=#FF0000>(</font>x<font color=#FF0000>+</font>p<font color=#FF0000>,</font>y<font color=#FF0000>+</font>q<font color=#FF0000>,</font><b><font color=#000000>getTileFull</font></b><font color=#FF0000>(</font>x<font color=#FF0000>+</font>q<font color=#FF0000>,</font>y<font color=#FF0000>+</font>size<font color=#FF0000>-</font><font color=#9A1900>1</font><font color=#FF0000>-</font>p<font color=#FF0000>)</font><font color=#FF0000>)</font><font color=#FF0000>;</font> <a name='line.420'></a>
0421:       <b><font color=#000000>setTile</font></b><font color=#FF0000>(</font>x<font color=#FF0000>+</font>q<font color=#FF0000>,</font>y<font color=#FF0000>+</font>size<font color=#FF0000>-</font><font color=#9A1900>1</font><font color=#FF0000>-</font>p<font color=#FF0000>,</font><b><font color=#000000>getTileFull</font></b><font color=#FF0000>(</font>x<font color=#FF0000>+</font>size<font color=#FF0000>-</font><font color=#9A1900>1</font><font color=#FF0000>-</font>p<font color=#FF0000>,</font>y<font color=#FF0000>+</font>size<font color=#FF0000>-</font><font color=#9A1900>1</font><font color=#FF0000>-</font>q<font color=#FF0000>)</font><font color=#FF0000>)</font><font color=#FF0000>;</font> <a name='line.421'></a>
0422:       <b><font color=#000000>setTile</font></b><font color=#FF0000>(</font>x<font color=#FF0000>+</font>size<font color=#FF0000>-</font><font color=#9A1900>1</font><font color=#FF0000>-</font>p<font color=#FF0000>,</font>y<font color=#FF0000>+</font>size<font color=#FF0000>-</font><font color=#9A1900>1</font><font color=#FF0000>-</font>q<font color=#FF0000>,</font><b><font color=#000000>getTileFull</font></b><font color=#FF0000>(</font>x<font color=#FF0000>+</font>size<font color=#FF0000>-</font><font color=#9A1900>1</font><font color=#FF0000>-</font>q<font color=#FF0000>,</font>y<font color=#FF0000>+</font>p<font color=#FF0000>)</font><font color=#FF0000>)</font><font color=#FF0000>;</font> <a name='line.422'></a>
0423:       <b><font color=#000000>setTile</font></b><font color=#FF0000>(</font>x<font color=#FF0000>+</font>size<font color=#FF0000>-</font><font color=#9A1900>1</font><font color=#FF0000>-</font>q<font color=#FF0000>,</font>y<font color=#FF0000>+</font>p<font color=#FF0000>,</font>temp<font color=#FF0000>)</font><font color=#FF0000>;</font> <a name='line.423'></a>
0424:     <font color=#000000>}</font> <a name='line.424'></a>
0425:   <font color=#000000>}</font> <a name='line.425'></a>
0426: <a name='line.426'></a>
0427:   <b><font color=#009900>// copy a complte map template</font></b><a name='line.427'></a>
0428:   <b><font color=#0000FF>public</font></b> <font color=#0000FF>void</font> <b><font color=#000000>copyArea</font></b><font color=#FF0000>(</font><font color=#0000FF>int</font> tx<font color=#FF0000>,</font> <font color=#0000FF>int</font> ty<font color=#FF0000>,</font> Map src<font color=#FF0000>)</font> <font color=#000000>{</font><a name='line.428'></a>
0429:     <b><font color=#000000>copyArea</font></b><font color=#FF0000>(</font>tx<font color=#FF0000>,</font>ty<font color=#FF0000>,</font>src<font color=#FF0000>,</font><font color=#9A1900>0</font><font color=#FF0000>,</font><font color=#9A1900>0</font><font color=#FF0000>,</font>src<font color=#FF0000>.</font>width<font color=#FF0000>,</font>src<font color=#FF0000>.</font>height<font color=#FF0000>)</font><font color=#FF0000>;</font><a name='line.429'></a>
0430:   <font color=#000000>}</font><a name='line.430'></a>
0431:  <a name='line.431'></a>
0432:   <b><font color=#009900>// copy map contents to specified position</font></b><a name='line.432'></a>
0433:   <b><font color=#0000FF>public</font></b> <font color=#0000FF>void</font> <b><font color=#000000>copyArea</font></b><font color=#FF0000>(</font><font color=#0000FF>int</font> tx<font color=#FF0000>,</font> <font color=#0000FF>int</font> ty<font color=#FF0000>,</font> Map src<font color=#FF0000>,</font> <font color=#0000FF>int</font> sx<font color=#FF0000>,</font> <font color=#0000FF>int</font> sy<font color=#FF0000>,</font> <font color=#0000FF>int</font> sw<font color=#FF0000>,</font> <font color=#0000FF>int</font> sh<font color=#FF0000>)</font> <font color=#000000>{</font><a name='line.433'></a>
0434:     <b><font color=#009900>// delete original contents</font></b><a name='line.434'></a>
0435:     <b><font color=#000000>clearArea</font></b><font color=#FF0000>(</font>tx<font color=#FF0000>,</font>ty<font color=#FF0000>,</font>tx<font color=#FF0000>+</font>sx<font color=#FF0000>,</font>ty<font color=#FF0000>+</font>sy<font color=#FF0000>)</font><font color=#FF0000>;</font><a name='line.435'></a>
0436:     <a name='line.436'></a>
0437:     <b><font color=#009900>// square-by-square copy</font></b><a name='line.437'></a>
0438:     <b><font color=#0000FF>for</font></b> <font color=#FF0000>(</font><font color=#0000FF>int</font> x<font color=#FF0000>=</font>tx<font color=#FF0000>;</font> x<font color=#FF0000>&lt;</font>tx<font color=#FF0000>+</font>sw<font color=#FF0000>;</font> x<font color=#FF0000>+</font><font color=#FF0000>+</font><font color=#FF0000>)</font> <b><font color=#0000FF>for</font></b> <font color=#FF0000>(</font><font color=#0000FF>int</font> y<font color=#FF0000>=</font>ty<font color=#FF0000>;</font> y<font color=#FF0000>&lt;</font>ty<font color=#FF0000>+</font>sh<font color=#FF0000>;</font> y<font color=#FF0000>+</font><font color=#FF0000>+</font><font color=#FF0000>)</font> <font color=#000000>{</font><a name='line.438'></a>
0439:       <b><font color=#000000>setTile</font></b><font color=#FF0000>(</font>x<font color=#FF0000>,</font>y<font color=#FF0000>,</font>src<font color=#FF0000>.</font><b><font color=#000000>getTileFull</font></b><font color=#FF0000>(</font>x<font color=#FF0000>-</font>tx<font color=#FF0000>+</font>sx<font color=#FF0000>,</font>y<font color=#FF0000>-</font>ty<font color=#FF0000>+</font>sy<font color=#FF0000>)</font><font color=#FF0000>)</font><font color=#FF0000>;</font><a name='line.439'></a>
0440:       Thing<font color=#FF0000>[</font><font color=#FF0000>]</font> things<font color=#FF0000>=</font>src<font color=#FF0000>.</font><b><font color=#000000>getThings</font></b><font color=#FF0000>(</font>x<font color=#FF0000>-</font>tx<font color=#FF0000>+</font>sx<font color=#FF0000>,</font>y<font color=#FF0000>-</font>ty<font color=#FF0000>+</font>sy<font color=#FF0000>)</font><font color=#FF0000>;</font><a name='line.440'></a>
0441:       <b><font color=#0000FF>for</font></b> <font color=#FF0000>(</font><font color=#0000FF>int</font> i<font color=#FF0000>=</font><font color=#9A1900>0</font><font color=#FF0000>;</font> i<font color=#FF0000>&lt;</font>things<font color=#FF0000>.</font>length<font color=#FF0000>;</font> i<font color=#FF0000>+</font><font color=#FF0000>+</font><font color=#FF0000>)</font> <font color=#000000>{</font><a name='line.441'></a>
0442:         <b><font color=#000000>addThing</font></b><font color=#FF0000>(</font><font color=#FF0000>(</font>Thing<font color=#FF0000>)</font>things<font color=#FF0000>[</font>i<font color=#FF0000>]</font><font color=#FF0000>.</font><b><font color=#000000>clone</font></b><font color=#FF0000>(</font><font color=#FF0000>)</font><font color=#FF0000>,</font>x<font color=#FF0000>,</font>y<font color=#FF0000>)</font><font color=#FF0000>;</font> <a name='line.442'></a>
0443:       <font color=#000000>}</font> <a name='line.443'></a>
0444:     <font color=#000000>}</font><a name='line.444'></a>
0445:   <font color=#000000>}</font><a name='line.445'></a>
0446:   <a name='line.446'></a>
0447:   <b><font color=#009900>// creates a border around specified rectangular area</font></b><a name='line.447'></a>
0448:   <b><font color=#0000FF>public</font></b> <font color=#0000FF>void</font> <b><font color=#000000>fillBorder</font></b><font color=#FF0000>(</font><font color=#0000FF>int</font> x1<font color=#FF0000>,</font><font color=#0000FF>int</font> y1<font color=#FF0000>,</font><font color=#0000FF>int</font> x2<font color=#FF0000>,</font><font color=#0000FF>int</font> y2<font color=#FF0000>,</font> <font color=#0000FF>int</font> c<font color=#FF0000>)</font> <font color=#000000>{</font><a name='line.448'></a>
0449:     <b><font color=#0000FF>if</font></b> <font color=#FF0000>(</font>x1<font color=#FF0000>&gt;</font>x2<font color=#FF0000>)</font> <font color=#000000>{</font><font color=#0000FF>int</font> t<font color=#FF0000>=</font>x1<font color=#FF0000>;</font> x1<font color=#FF0000>=</font>x2<font color=#FF0000>;</font> x2<font color=#FF0000>=</font>t<font color=#FF0000>;</font><font color=#000000>}</font><a name='line.449'></a>
0450:     <b><font color=#0000FF>if</font></b> <font color=#FF0000>(</font>y1<font color=#FF0000>&gt;</font>y2<font color=#FF0000>)</font> <font color=#000000>{</font><font color=#0000FF>int</font> t<font color=#FF0000>=</font>y1<font color=#FF0000>;</font> x1<font color=#FF0000>=</font>y2<font color=#FF0000>;</font> y2<font color=#FF0000>=</font>t<font color=#FF0000>;</font><font color=#000000>}</font><a name='line.450'></a>
0451:     <b><font color=#0000FF>for</font></b> <font color=#FF0000>(</font><font color=#0000FF>int</font> x<font color=#FF0000>=</font>x1<font color=#FF0000>;</font> x<font color=#FF0000>&lt;</font><font color=#FF0000>=</font>x2<font color=#FF0000>;</font> x<font color=#FF0000>+</font><font color=#FF0000>+</font><font color=#FF0000>)</font> <font color=#000000>{</font><a name='line.451'></a>
0452:       <b><font color=#000000>setTile</font></b><font color=#FF0000>(</font>x<font color=#FF0000>,</font>y1<font color=#FF0000>,</font>c<font color=#FF0000>)</font><font color=#FF0000>;</font> <a name='line.452'></a>
0453:       <b><font color=#000000>setTile</font></b><font color=#FF0000>(</font>x<font color=#FF0000>,</font>y2<font color=#FF0000>,</font>c<font color=#FF0000>)</font><font color=#FF0000>;</font> <a name='line.453'></a>
0454:     <font color=#000000>}</font><a name='line.454'></a>
0455:     <b><font color=#0000FF>for</font></b> <font color=#FF0000>(</font><font color=#0000FF>int</font> y<font color=#FF0000>=</font>y1<font color=#FF0000>;</font> y<font color=#FF0000>&lt;</font><font color=#FF0000>=</font>y2<font color=#FF0000>;</font> y<font color=#FF0000>+</font><font color=#FF0000>+</font><font color=#FF0000>)</font> <font color=#000000>{</font><a name='line.455'></a>
0456:       <b><font color=#000000>setTile</font></b><font color=#FF0000>(</font>x1<font color=#FF0000>,</font>y<font color=#FF0000>,</font>c<font color=#FF0000>)</font><font color=#FF0000>;</font> <a name='line.456'></a>
0457:       <b><font color=#000000>setTile</font></b><font color=#FF0000>(</font>x2<font color=#FF0000>,</font>y<font color=#FF0000>,</font>c<font color=#FF0000>)</font><font color=#FF0000>;</font> <a name='line.457'></a>
0458:     <font color=#000000>}</font><a name='line.458'></a>
0459:   <font color=#000000>}</font><a name='line.459'></a>
0460: <a name='line.460'></a>
0461:   <b><font color=#009900>// fill all blank squares in area with specified tile</font></b><a name='line.461'></a>
0462:   <b><font color=#0000FF>public</font></b> <font color=#0000FF>void</font> <b><font color=#000000>completeArea</font></b><font color=#FF0000>(</font><font color=#0000FF>int</font> x1<font color=#FF0000>,</font><font color=#0000FF>int</font> y1<font color=#FF0000>,</font><font color=#0000FF>int</font> x2<font color=#FF0000>,</font><font color=#0000FF>int</font> y2<font color=#FF0000>,</font> <font color=#0000FF>int</font> c<font color=#FF0000>)</font> <font color=#000000>{</font><a name='line.462'></a>
0463:     <b><font color=#0000FF>if</font></b> <font color=#FF0000>(</font>x1<font color=#FF0000>&gt;</font>x2<font color=#FF0000>)</font> <font color=#000000>{</font><font color=#0000FF>int</font> t<font color=#FF0000>=</font>x1<font color=#FF0000>;</font> x1<font color=#FF0000>=</font>x2<font color=#FF0000>;</font> x2<font color=#FF0000>=</font>t<font color=#FF0000>;</font><font color=#000000>}</font><a name='line.463'></a>
0464:     <b><font color=#0000FF>if</font></b> <font color=#FF0000>(</font>y1<font color=#FF0000>&gt;</font>y2<font color=#FF0000>)</font> <font color=#000000>{</font><font color=#0000FF>int</font> t<font color=#FF0000>=</font>y1<font color=#FF0000>;</font> x1<font color=#FF0000>=</font>y2<font color=#FF0000>;</font> y2<font color=#FF0000>=</font>t<font color=#FF0000>;</font><font color=#000000>}</font><a name='line.464'></a>
0465:     <b><font color=#0000FF>for</font></b> <font color=#FF0000>(</font><font color=#0000FF>int</font> x<font color=#FF0000>=</font>x1<font color=#FF0000>;</font> x<font color=#FF0000>&lt;</font><font color=#FF0000>=</font>x2<font color=#FF0000>;</font> x<font color=#FF0000>+</font><font color=#FF0000>+</font><font color=#FF0000>)</font> <b><font color=#0000FF>for</font></b> <font color=#FF0000>(</font><font color=#0000FF>int</font> y<font color=#FF0000>=</font>y1<font color=#FF0000>;</font> y<font color=#FF0000>&lt;</font><font color=#FF0000>=</font>y2<font color=#FF0000>;</font> y<font color=#FF0000>+</font><font color=#FF0000>+</font><font color=#FF0000>)</font> <font color=#000000>{</font><a name='line.465'></a>
0466:       <b><font color=#0000FF>if</font></b> <font color=#FF0000>(</font><b><font color=#000000>getTile</font></b><font color=#FF0000>(</font>x<font color=#FF0000>,</font>y<font color=#FF0000>)</font><font color=#FF0000>=</font><font color=#FF0000>=</font><font color=#9A1900>0</font><font color=#FF0000>)</font> <b><font color=#000000>setTile</font></b><font color=#FF0000>(</font>x<font color=#FF0000>,</font>y<font color=#FF0000>,</font>c<font color=#FF0000>)</font><font color=#FF0000>;</font>  <a name='line.466'></a>
0467:     <font color=#000000>}</font>  <a name='line.467'></a>
0468:   <font color=#000000>}</font><a name='line.468'></a>
0469:   <a name='line.469'></a>
0470:   <b><font color=#009900>//set tile and return true if currently blank</font></b><a name='line.470'></a>
0471:   <b><font color=#0000FF>public</font></b> <font color=#0000FF>boolean</font> <b><font color=#000000>completeTile</font></b><font color=#FF0000>(</font><font color=#0000FF>int</font> x<font color=#FF0000>,</font> <font color=#0000FF>int</font> y<font color=#FF0000>,</font> <font color=#0000FF>int</font> c<font color=#FF0000>)</font> <font color=#000000>{</font><a name='line.471'></a>
0472:     <b><font color=#0000FF>if</font></b> <font color=#FF0000>(</font><b><font color=#000000>getTile</font></b><font color=#FF0000>(</font>x<font color=#FF0000>,</font>y<font color=#FF0000>)</font><font color=#FF0000>=</font><font color=#FF0000>=</font><font color=#9A1900>0</font><font color=#FF0000>)</font> <font color=#000000>{</font><a name='line.472'></a>
0473:       <b><font color=#000000>setTile</font></b><font color=#FF0000>(</font>x<font color=#FF0000>,</font>y<font color=#FF0000>,</font>c<font color=#FF0000>)</font><font color=#FF0000>;</font> <b><font color=#0000FF>return</font></b> true<font color=#FF0000>;</font><a name='line.473'></a>
0474:     <font color=#000000>}</font> <b><font color=#0000FF>else</font></b> <font color=#000000>{</font><a name='line.474'></a>
0475:       <b><font color=#0000FF>return</font></b> false<font color=#FF0000>;</font>     <a name='line.475'></a>
0476:     <font color=#000000>}</font><a name='line.476'></a>
0477:   <font color=#000000>}</font><a name='line.477'></a>
0478:   <a name='line.478'></a>
0479:   <b><font color=#009900>// make a random path</font></b><a name='line.479'></a>
0480:   <b><font color=#009900>//   from (x1,y1) to (x2,y2)</font></b><a name='line.480'></a>
0481:   <b><font color=#009900>//   staying within region (x3,y3,x4,y4);</font></b><a name='line.481'></a>
0482:   <b><font color=#0000FF>public</font></b> <font color=#0000FF>void</font> <b><font color=#000000>makeRandomPath</font></b><font color=#FF0000>(</font><font color=#0000FF>int</font> x1<font color=#FF0000>,</font><font color=#0000FF>int</font> y1<font color=#FF0000>,</font> <font color=#0000FF>int</font> x2<font color=#FF0000>,</font> <font color=#0000FF>int</font> y2<font color=#FF0000>,</font> <font color=#0000FF>int</font> x3<font color=#FF0000>,</font> <font color=#0000FF>int</font> y3<font color=#FF0000>,</font> <font color=#0000FF>int</font> x4<font color=#FF0000>,</font> <font color=#0000FF>int</font> y4<font color=#FF0000>,</font> <font color=#0000FF>int</font> c<font color=#FF0000>,</font> <font color=#0000FF>boolean</font> diagonals<font color=#FF0000>)</font> <font color=#000000>{</font><a name='line.482'></a>
0483:     <font color=#0000FF>int</font> dx<font color=#FF0000>;</font> <font color=#0000FF>int</font> dy<font color=#FF0000>;</font><a name='line.483'></a>
0484:     <b><font color=#0000FF>while</font></b> <font color=#FF0000>(</font><font color=#FF0000>(</font>x1<font color=#FF0000>!</font><font color=#FF0000>=</font>x2<font color=#FF0000>)</font><font color=#FF0000>|</font><font color=#FF0000>|</font><font color=#FF0000>(</font>y1<font color=#FF0000>!</font><font color=#FF0000>=</font>y2<font color=#FF0000>)</font><font color=#FF0000>)</font> <font color=#000000>{</font><a name='line.484'></a>
0485:       <b><font color=#000000>setTile</font></b><font color=#FF0000>(</font>x1<font color=#FF0000>,</font>y1<font color=#FF0000>,</font>c<font color=#FF0000>)</font><font color=#FF0000>;</font><a name='line.485'></a>
0486:       <b><font color=#0000FF>if</font></b> <font color=#FF0000>(</font>RPG<font color=#FF0000>.</font><b><font color=#000000>d</font></b><font color=#FF0000>(</font><font color=#9A1900>3</font><font color=#FF0000>)</font><font color=#FF0000>=</font><font color=#FF0000>=</font><font color=#9A1900>1</font><font color=#FF0000>)</font> <font color=#000000>{</font><a name='line.486'></a>
0487:         dx<font color=#FF0000>=</font>RPG<font color=#FF0000>.</font><b><font color=#000000>sign</font></b><font color=#FF0000>(</font>x2<font color=#FF0000>-</font>x1<font color=#FF0000>)</font><font color=#FF0000>;</font>  <a name='line.487'></a>
0488:         dy<font color=#FF0000>=</font>RPG<font color=#FF0000>.</font><b><font color=#000000>sign</font></b><font color=#FF0000>(</font>y2<font color=#FF0000>-</font>y1<font color=#FF0000>)</font><font color=#FF0000>;</font>  <a name='line.488'></a>
0489:       <font color=#000000>}</font> <b><font color=#0000FF>else</font></b> <font color=#000000>{</font><a name='line.489'></a>
0490:         dx<font color=#FF0000>=</font>RPG<font color=#FF0000>.</font><b><font color=#000000>r</font></b><font color=#FF0000>(</font><font color=#9A1900>3</font><font color=#FF0000>)</font><font color=#FF0000>-</font><font color=#9A1900>1</font><font color=#FF0000>;</font>  <a name='line.490'></a>
0491:         dy<font color=#FF0000>=</font>RPG<font color=#FF0000>.</font><b><font color=#000000>r</font></b><font color=#FF0000>(</font><font color=#9A1900>3</font><font color=#FF0000>)</font><font color=#FF0000>-</font><font color=#9A1900>1</font><font color=#FF0000>;</font>  <a name='line.491'></a>
0492:       <font color=#000000>}</font><a name='line.492'></a>
0493:       <b><font color=#0000FF>switch</font></b> <font color=#FF0000>(</font>RPG<font color=#FF0000>.</font><b><font color=#000000>d</font></b><font color=#FF0000>(</font>diagonals<font color=#FF0000>?</font><font color=#9A1900>3</font><font color=#FF0000>:</font><font color=#9A1900>2</font><font color=#FF0000>)</font><font color=#FF0000>)</font> <font color=#000000>{</font><a name='line.493'></a>
0494:         <b><font color=#0000FF>case</font></b> <font color=#9A1900>1</font><font color=#FF0000>:</font> dx<font color=#FF0000>=</font><font color=#9A1900>0</font><font color=#FF0000>;</font> <b><font color=#0000FF>break</font></b><font color=#FF0000>;</font><a name='line.494'></a>
0495:         <b><font color=#0000FF>case</font></b> <font color=#9A1900>2</font><font color=#FF0000>:</font> dy<font color=#FF0000>=</font><font color=#9A1900>0</font><font color=#FF0000>;</font> <b><font color=#0000FF>break</font></b><font color=#FF0000>;</font>  <a name='line.495'></a>
0496:       <font color=#000000>}</font><a name='line.496'></a>
0497:       x1<font color=#FF0000>+</font><font color=#FF0000>=</font>dx<font color=#FF0000>;</font><a name='line.497'></a>
0498:       y1<font color=#FF0000>+</font><font color=#FF0000>=</font>dy<font color=#FF0000>;</font><a name='line.498'></a>
0499:       x1<font color=#FF0000>=</font>RPG<font color=#FF0000>.</font><b><font color=#000000>middle</font></b><font color=#FF0000>(</font>x3<font color=#FF0000>,</font>x1<font color=#FF0000>,</font>x4<font color=#FF0000>)</font><font color=#FF0000>;</font><a name='line.499'></a>
0500:       y1<font color=#FF0000>=</font>RPG<font color=#FF0000>.</font><b><font color=#000000>middle</font></b><font color=#FF0000>(</font>y3<font color=#FF0000>,</font>y1<font color=#FF0000>,</font>y4<font color=#FF0000>)</font><font color=#FF0000>;</font><a name='line.500'></a>
0501:     <font color=#000000>}</font><a name='line.501'></a>
0502:     <b><font color=#000000>setTile</font></b><font color=#FF0000>(</font>x2<font color=#FF0000>,</font>y2<font color=#FF0000>,</font>c<font color=#FF0000>)</font><font color=#FF0000>;</font>  <a name='line.502'></a>
0503:   <font color=#000000>}</font><a name='line.503'></a>
0504:   <a name='line.504'></a>
0505:   <b><font color=#0000FF>public</font></b> Point <b><font color=#000000>findClearTile</font></b><font color=#FF0000>(</font><font color=#FF0000>)</font> <font color=#000000>{</font><a name='line.505'></a>
0506:     <font color=#0000FF>int</font> x<font color=#FF0000>;</font><a name='line.506'></a>
0507:     <font color=#0000FF>int</font> y<font color=#FF0000>;</font><a name='line.507'></a>
0508:     <b><font color=#0000FF>for</font></b> <font color=#FF0000>(</font><font color=#0000FF>int</font> i<font color=#FF0000>=</font><font color=#9A1900>0</font><font color=#FF0000>;</font> i<font color=#FF0000>&lt;</font><font color=#FF0000>(</font>width<font color=#FF0000>*</font>height<font color=#FF0000>)</font><font color=#FF0000>;</font> i<font color=#FF0000>+</font><font color=#FF0000>+</font><font color=#FF0000>)</font> <font color=#000000>{</font><a name='line.508'></a>
0509:       x<font color=#FF0000>=</font>RPG<font color=#FF0000>.</font><b><font color=#000000>r</font></b><font color=#FF0000>(</font>width<font color=#FF0000>)</font><font color=#FF0000>;</font><a name='line.509'></a>
0510:       y<font color=#FF0000>=</font>RPG<font color=#FF0000>.</font><b><font color=#000000>r</font></b><font color=#FF0000>(</font>height<font color=#FF0000>)</font><font color=#FF0000>;</font><a name='line.510'></a>
0511:       <b><font color=#0000FF>if</font></b> <font color=#FF0000>(</font><b><font color=#000000>isClear</font></b><font color=#FF0000>(</font>x<font color=#FF0000>,</font>y<font color=#FF0000>)</font><font color=#FF0000>)</font> <b><font color=#0000FF>return</font></b> <b><font color=#0000FF>new</font></b> <b><font color=#000000>Point</font></b><font color=#FF0000>(</font>x<font color=#FF0000>,</font>y<font color=#FF0000>)</font><font color=#FF0000>;</font><a name='line.511'></a>
0512:     <font color=#000000>}</font>  <a name='line.512'></a>
0513:     <b><font color=#0000FF>return</font></b> <b><font color=#0000FF>null</font></b><font color=#FF0000>;</font><a name='line.513'></a>
0514:   <font color=#000000>}</font> <a name='line.514'></a>
0515:   <a name='line.515'></a>
0516:   <b><font color=#0000FF>public</font></b> Point <b><font color=#000000>findTile</font></b><font color=#FF0000>(</font><font color=#0000FF>int</font> c<font color=#FF0000>)</font> <font color=#000000>{</font><a name='line.516'></a>
0517:     <font color=#0000FF>int</font> x<font color=#FF0000>;</font><a name='line.517'></a>
0518:     <font color=#0000FF>int</font> y<font color=#FF0000>;</font><a name='line.518'></a>
0519:     c<font color=#FF0000>=</font>c<font color=#FF0000>&amp;</font>Tile<font color=#FF0000>.</font>TF_TYPE<font color=#FF0000>;</font> <b><font color=#009900>//use tile type for comparison</font></b><a name='line.519'></a>
0520:     <b><font color=#0000FF>for</font></b> <font color=#FF0000>(</font><font color=#0000FF>int</font> i<font color=#FF0000>=</font><font color=#9A1900>0</font><font color=#FF0000>;</font> i<font color=#FF0000>&lt;</font><font color=#FF0000>(</font><font color=#9A1900>10</font><font color=#FF0000>*</font>width<font color=#FF0000>*</font>height<font color=#FF0000>)</font><font color=#FF0000>;</font> i<font color=#FF0000>+</font><font color=#FF0000>+</font><font color=#FF0000>)</font> <font color=#000000>{</font><a name='line.520'></a>
0521:       x<font color=#FF0000>=</font>RPG<font color=#FF0000>.</font><b><font color=#000000>r</font></b><font color=#FF0000>(</font>width<font color=#FF0000>)</font><font color=#FF0000>;</font><a name='line.521'></a>
0522:       y<font color=#FF0000>=</font>RPG<font color=#FF0000>.</font><b><font color=#000000>r</font></b><font color=#FF0000>(</font>height<font color=#FF0000>)</font><font color=#FF0000>;</font><a name='line.522'></a>
0523:       <b><font color=#0000FF>if</font></b> <font color=#FF0000>(</font><font color=#FF0000>(</font><b><font color=#000000>getTile</font></b><font color=#FF0000>(</font>x<font color=#FF0000>,</font>y<font color=#FF0000>)</font><font color=#FF0000>&amp;</font>Tile<font color=#FF0000>.</font>TF_TYPE<font color=#FF0000>)</font><font color=#FF0000>=</font><font color=#FF0000>=</font>c<font color=#FF0000>)</font> <b><font color=#0000FF>return</font></b> <b><font color=#0000FF>new</font></b> <b><font color=#000000>Point</font></b><font color=#FF0000>(</font>x<font color=#FF0000>,</font>y<font color=#FF0000>)</font><font color=#FF0000>;</font><a name='line.523'></a>
0524:     <font color=#000000>}</font>  <a name='line.524'></a>
0525:     <b><font color=#0000FF>return</font></b> <b><font color=#0000FF>null</font></b><font color=#FF0000>;</font><a name='line.525'></a>
0526:   <font color=#000000>}</font><a name='line.526'></a>
0527:   <a name='line.527'></a>
0528:   <b><font color=#009900>// find a free area, returning top left point</font></b><a name='line.528'></a>
0529:   <b><font color=#0000FF>public</font></b> Point <b><font color=#000000>findFreeArea</font></b><font color=#FF0000>(</font><font color=#0000FF>int</font> x1<font color=#FF0000>,</font><font color=#0000FF>int</font> y1<font color=#FF0000>,</font> <font color=#0000FF>int</font> x2<font color=#FF0000>,</font><font color=#0000FF>int</font> y2<font color=#FF0000>,</font><font color=#0000FF>int</font> w<font color=#FF0000>,</font><font color=#0000FF>int</font> h<font color=#FF0000>)</font> <font color=#000000>{</font><a name='line.529'></a>
0530:     <font color=#0000FF>int</font> px<font color=#FF0000>=</font>x1<font color=#FF0000>;</font> <font color=#0000FF>int</font> py<font color=#FF0000>=</font>y1<font color=#FF0000>;</font><a name='line.530'></a>
0531:     <b><font color=#0000FF>for</font></b> <font color=#FF0000>(</font><font color=#0000FF>int</font> i<font color=#FF0000>=</font><font color=#FF0000>(</font>x2<font color=#FF0000>-</font>x1<font color=#FF0000>)</font><font color=#FF0000>*</font><font color=#FF0000>(</font>y2<font color=#FF0000>-</font>y1<font color=#FF0000>)</font><font color=#FF0000>;</font> i<font color=#FF0000>&gt;</font><font color=#9A1900>0</font><font color=#FF0000>;</font> i<font color=#FF0000>-</font><font color=#FF0000>-</font><font color=#FF0000>)</font> <font color=#000000>{</font><a name='line.531'></a>
0532:       px<font color=#FF0000>=</font>RPG<font color=#FF0000>.</font><b><font color=#000000>rspread</font></b><font color=#FF0000>(</font>x1<font color=#FF0000>,</font>x2<font color=#FF0000>-</font>w<font color=#FF0000>+</font><font color=#9A1900>1</font><font color=#FF0000>)</font><font color=#FF0000>;</font><a name='line.532'></a>
0533:       py<font color=#FF0000>=</font>RPG<font color=#FF0000>.</font><b><font color=#000000>rspread</font></b><font color=#FF0000>(</font>y1<font color=#FF0000>,</font>y2<font color=#FF0000>-</font>h<font color=#FF0000>+</font><font color=#9A1900>1</font><font color=#FF0000>)</font><font color=#FF0000>;</font><a name='line.533'></a>
0534:       <a name='line.534'></a>
0535:       <b><font color=#0000FF>for</font></b> <font color=#FF0000>(</font><font color=#0000FF>int</font> lx<font color=#FF0000>=</font>px<font color=#FF0000>;</font> lx<font color=#FF0000>&lt;</font>px<font color=#FF0000>+</font>w<font color=#FF0000>;</font> lx<font color=#FF0000>+</font><font color=#FF0000>+</font><font color=#FF0000>)</font> <b><font color=#0000FF>for</font></b> <font color=#FF0000>(</font><font color=#0000FF>int</font> ly<font color=#FF0000>=</font>py<font color=#FF0000>;</font> ly<font color=#FF0000>&lt;</font>py<font color=#FF0000>+</font>h<font color=#FF0000>;</font> ly<font color=#FF0000>+</font><font color=#FF0000>+</font><font color=#FF0000>)</font> <font color=#000000>{</font><a name='line.535'></a>
0536:         <b><font color=#0000FF>if</font></b> <font color=#FF0000>(</font><font color=#FF0000>!</font><b><font color=#000000>isClear</font></b><font color=#FF0000>(</font>lx<font color=#FF0000>,</font>ly<font color=#FF0000>)</font><font color=#FF0000>)</font> <b><font color=#0000FF>continue</font></b><font color=#FF0000>;</font> <a name='line.536'></a>
0537:       <font color=#000000>}</font> <a name='line.537'></a>
0538:       <b><font color=#0000FF>return</font></b> <b><font color=#0000FF>new</font></b> <b><font color=#000000>Point</font></b><font color=#FF0000>(</font>px<font color=#FF0000>,</font>py<font color=#FF0000>)</font><font color=#FF0000>;</font><a name='line.538'></a>
0539:     <font color=#000000>}</font> <a name='line.539'></a>
0540:     <b><font color=#0000FF>return</font></b> <b><font color=#0000FF>null</font></b><font color=#FF0000>;</font><a name='line.540'></a>
0541:   <font color=#000000>}</font><a name='line.541'></a>
0542:   <a name='line.542'></a>
0543:   <b><font color=#009900>// find a random square in rectangular area which is:</font></b><a name='line.543'></a>
0544:   <b><font color=#009900>// a) not 0</font></b><a name='line.544'></a>
0545:   <b><font color=#009900>// b) not blocked</font></b><a name='line.545'></a>
0546:   <b><font color=#009900>// c) contains no stuff </font></b><a name='line.546'></a>
0547:   <b><font color=#0000FF>public</font></b> Point <b><font color=#000000>findFreeSquare</font></b><font color=#FF0000>(</font><font color=#0000FF>int</font> x1<font color=#FF0000>,</font> <font color=#0000FF>int</font> y1<font color=#FF0000>,</font> <font color=#0000FF>int</font> x2<font color=#FF0000>,</font> <font color=#0000FF>int</font> y2<font color=#FF0000>)</font> <font color=#000000>{</font><a name='line.547'></a>
0548:     <font color=#0000FF>int</font> x<font color=#FF0000>;</font><a name='line.548'></a>
0549:     <font color=#0000FF>int</font> y<font color=#FF0000>;</font><a name='line.549'></a>
0550:     <b><font color=#009900>// prefer completely free squares</font></b><a name='line.550'></a>
0551:     <b><font color=#0000FF>for</font></b> <font color=#FF0000>(</font><font color=#0000FF>int</font> i<font color=#FF0000>=</font><font color=#FF0000>(</font><font color=#9A1900>2</font><font color=#FF0000>*</font><font color=#FF0000>(</font>x2<font color=#FF0000>-</font>x1<font color=#FF0000>+</font><font color=#9A1900>2</font><font color=#FF0000>)</font><font color=#FF0000>*</font><font color=#FF0000>(</font>y2<font color=#FF0000>-</font>y1<font color=#FF0000>+</font><font color=#9A1900>2</font><font color=#FF0000>)</font><font color=#FF0000>)</font><font color=#FF0000>;</font> i<font color=#FF0000>&gt;</font><font color=#9A1900>0</font><font color=#FF0000>;</font> i<font color=#FF0000>-</font><font color=#FF0000>-</font><font color=#FF0000>)</font> <font color=#000000>{</font><a name='line.551'></a>
0552:       x<font color=#FF0000>=</font>RPG<font color=#FF0000>.</font><b><font color=#000000>rspread</font></b><font color=#FF0000>(</font>x1<font color=#FF0000>,</font>x2<font color=#FF0000>)</font><font color=#FF0000>;</font><a name='line.552'></a>
0553:       y<font color=#FF0000>=</font>RPG<font color=#FF0000>.</font><b><font color=#000000>rspread</font></b><font color=#FF0000>(</font>y1<font color=#FF0000>,</font>y2<font color=#FF0000>)</font><font color=#FF0000>;</font><a name='line.553'></a>
0554:       <b><font color=#0000FF>if</font></b> <font color=#FF0000>(</font><b><font color=#000000>getTile</font></b><font color=#FF0000>(</font>x<font color=#FF0000>,</font>y<font color=#FF0000>)</font><font color=#FF0000>=</font><font color=#FF0000>=</font><font color=#9A1900>0</font><font color=#FF0000>)</font> <b><font color=#0000FF>continue</font></b><font color=#FF0000>;</font><a name='line.554'></a>
0555:       <b><font color=#0000FF>if</font></b> <font color=#FF0000>(</font><font color=#FF0000>(</font><b><font color=#000000>getObjects</font></b><font color=#FF0000>(</font>x<font color=#FF0000>,</font>y<font color=#FF0000>)</font><font color=#FF0000>=</font><font color=#FF0000>=</font><b><font color=#0000FF>null</font></b><font color=#FF0000>)</font><font color=#FF0000>&amp;</font><font color=#FF0000>&amp;</font><font color=#FF0000>(</font><font color=#FF0000>!</font><b><font color=#000000>isBlocked</font></b><font color=#FF0000>(</font>x<font color=#FF0000>,</font>y<font color=#FF0000>)</font><font color=#FF0000>)</font><font color=#FF0000>)</font> <b><font color=#0000FF>return</font></b> <b><font color=#0000FF>new</font></b> <b><font color=#000000>Point</font></b><font color=#FF0000>(</font>x<font color=#FF0000>,</font>y<font color=#FF0000>)</font><font color=#FF0000>;</font><a name='line.555'></a>
0556:     <font color=#000000>}</font>  <a name='line.556'></a>
0557:     <b><font color=#009900>// make do with unblocked squares</font></b><a name='line.557'></a>
0558:     <b><font color=#0000FF>for</font></b> <font color=#FF0000>(</font><font color=#0000FF>int</font> i<font color=#FF0000>=</font><font color=#FF0000>(</font><font color=#9A1900>2</font><font color=#FF0000>*</font><font color=#FF0000>(</font>x2<font color=#FF0000>-</font>x1<font color=#FF0000>+</font><font color=#9A1900>2</font><font color=#FF0000>)</font><font color=#FF0000>*</font><font color=#FF0000>(</font>y2<font color=#FF0000>-</font>y1<font color=#FF0000>+</font><font color=#9A1900>2</font><font color=#FF0000>)</font><font color=#FF0000>)</font><font color=#FF0000>;</font> i<font color=#FF0000>&gt;</font><font color=#9A1900>0</font><font color=#FF0000>;</font> i<font color=#FF0000>-</font><font color=#FF0000>-</font><font color=#FF0000>)</font> <font color=#000000>{</font><a name='line.558'></a>
0559:       x<font color=#FF0000>=</font>RPG<font color=#FF0000>.</font><b><font color=#000000>rspread</font></b><font color=#FF0000>(</font>x1<font color=#FF0000>,</font>x2<font color=#FF0000>)</font><font color=#FF0000>;</font><a name='line.559'></a>
0560:       y<font color=#FF0000>=</font>RPG<font color=#FF0000>.</font><b><font color=#000000>rspread</font></b><font color=#FF0000>(</font>y1<font color=#FF0000>,</font>y2<font color=#FF0000>)</font><font color=#FF0000>;</font><a name='line.560'></a>
0561:       <b><font color=#0000FF>if</font></b> <font color=#FF0000>(</font><b><font color=#000000>getTile</font></b><font color=#FF0000>(</font>x<font color=#FF0000>,</font>y<font color=#FF0000>)</font><font color=#FF0000>=</font><font color=#FF0000>=</font><font color=#9A1900>0</font><font color=#FF0000>)</font> <b><font color=#0000FF>continue</font></b><font color=#FF0000>;</font><a name='line.561'></a>
0562:       <b><font color=#0000FF>if</font></b> <font color=#FF0000>(</font><font color=#FF0000>!</font><b><font color=#000000>isBlocked</font></b><font color=#FF0000>(</font>x<font color=#FF0000>,</font>y<font color=#FF0000>)</font><font color=#FF0000>)</font> <b><font color=#0000FF>return</font></b> <b><font color=#0000FF>new</font></b> <b><font color=#000000>Point</font></b><font color=#FF0000>(</font>x<font color=#FF0000>,</font>y<font color=#FF0000>)</font><font color=#FF0000>;</font><a name='line.562'></a>
0563:     <font color=#000000>}</font>  <a name='line.563'></a>
0564:     <b><font color=#0000FF>return</font></b> <b><font color=#0000FF>null</font></b><font color=#FF0000>;</font><a name='line.564'></a>
0565:   <font color=#000000>}</font><a name='line.565'></a>
0566: <a name='line.566'></a>
0567:   <b><font color=#009900>// find free square on entire map</font></b><a name='line.567'></a>
0568:   <b><font color=#0000FF>public</font></b> Point <b><font color=#000000>findFreeSquare</font></b><font color=#FF0000>(</font><font color=#FF0000>)</font> <font color=#000000>{</font><a name='line.568'></a>
0569:     <b><font color=#0000FF>return</font></b> <b><font color=#000000>findFreeSquare</font></b><font color=#FF0000>(</font><font color=#9A1900>0</font><font color=#FF0000>,</font><font color=#9A1900>0</font><font color=#FF0000>,</font>width<font color=#FF0000>-</font><font color=#9A1900>1</font><font color=#FF0000>,</font>height<font color=#FF0000>-</font><font color=#9A1900>1</font><font color=#FF0000>)</font><font color=#FF0000>;</font><a name='line.569'></a>
0570:   <font color=#000000>}</font><a name='line.570'></a>
0571: <a name='line.571'></a>
0572:   <b><font color=#009900>// find unblocked square with tile type c adjacent in specified direction</font></b><a name='line.572'></a>
0573:   <b><font color=#0000FF>public</font></b> Point <b><font color=#000000>findEdgeSquare</font></b><font color=#FF0000>(</font><font color=#0000FF>int</font> dx<font color=#FF0000>,</font> <font color=#0000FF>int</font> dy<font color=#FF0000>,</font> <font color=#0000FF>int</font> c<font color=#FF0000>)</font> <font color=#000000>{</font><a name='line.573'></a>
0574:     <font color=#0000FF>int</font> x<font color=#FF0000>;</font><a name='line.574'></a>
0575:     <font color=#0000FF>int</font> y<font color=#FF0000>;</font><a name='line.575'></a>
0576:     <b><font color=#0000FF>for</font></b> <font color=#FF0000>(</font><font color=#0000FF>int</font> i<font color=#FF0000>=</font><font color=#9A1900>0</font><font color=#FF0000>;</font> i<font color=#FF0000>&lt;</font><font color=#FF0000>(</font><font color=#9A1900>10</font><font color=#FF0000>*</font>width<font color=#FF0000>*</font>height<font color=#FF0000>)</font><font color=#FF0000>;</font> i<font color=#FF0000>+</font><font color=#FF0000>+</font><font color=#FF0000>)</font> <font color=#000000>{</font><a name='line.576'></a>
0577:       x<font color=#FF0000>=</font>RPG<font color=#FF0000>.</font><b><font color=#000000>r</font></b><font color=#FF0000>(</font>width<font color=#FF0000>-</font><font color=#9A1900>2</font><font color=#FF0000>)</font><font color=#FF0000>+</font><font color=#9A1900>1</font><font color=#FF0000>;</font><a name='line.577'></a>
0578:       y<font color=#FF0000>=</font>RPG<font color=#FF0000>.</font><b><font color=#000000>r</font></b><font color=#FF0000>(</font>height<font color=#FF0000>-</font><font color=#9A1900>2</font><font color=#FF0000>)</font><font color=#FF0000>+</font><font color=#9A1900>1</font><font color=#FF0000>;</font><a name='line.578'></a>
0579:       <b><font color=#0000FF>if</font></b> <font color=#FF0000>(</font><font color=#FF0000>(</font><b><font color=#000000>getTile</font></b><font color=#FF0000>(</font>x<font color=#FF0000>,</font>y<font color=#FF0000>)</font><font color=#FF0000>=</font><font color=#FF0000>=</font><font color=#9A1900>0</font><font color=#FF0000>)</font><font color=#FF0000>|</font><font color=#FF0000>|</font><b><font color=#000000>isBlocked</font></b><font color=#FF0000>(</font>x<font color=#FF0000>,</font>y<font color=#FF0000>)</font><font color=#FF0000>)</font> <b><font color=#0000FF>continue</font></b><font color=#FF0000>;</font><a name='line.579'></a>
0580:       <b><font color=#0000FF>if</font></b> <font color=#FF0000>(</font><b><font color=#000000>getTile</font></b><font color=#FF0000>(</font>x<font color=#FF0000>+</font>dx<font color=#FF0000>,</font>y<font color=#FF0000>+</font>dy<font color=#FF0000>)</font><font color=#FF0000>=</font><font color=#FF0000>=</font>c<font color=#FF0000>)</font> <b><font color=#0000FF>return</font></b> <b><font color=#0000FF>new</font></b> <b><font color=#000000>Point</font></b><font color=#FF0000>(</font>x<font color=#FF0000>,</font>y<font color=#FF0000>)</font><font color=#FF0000>;</font><a name='line.580'></a>
0581:     <font color=#000000>}</font>  <a name='line.581'></a>
0582:     <b><font color=#0000FF>return</font></b> <b><font color=#0000FF>null</font></b><font color=#FF0000>;</font><a name='line.582'></a>
0583:   <font color=#000000>}</font><a name='line.583'></a>
0584: <a name='line.584'></a>
0585:   <b><font color=#009900>// find nearest enemy for a given mobile</font></b><a name='line.585'></a>
0586:   <b><font color=#0000FF>public</font></b> Thing <b><font color=#000000>findNearestFoe</font></b><font color=#FF0000>(</font>Mobile b<font color=#FF0000>)</font> <font color=#000000>{</font><a name='line.586'></a>
0587:     <b><font color=#0000FF>if</font></b> <font color=#FF0000>(</font>b<font color=#FF0000>.</font>place<font color=#FF0000>!</font><font color=#FF0000>=</font><b><font color=#0000FF>this</font></b><font color=#FF0000>)</font> <b><font color=#0000FF>return</font></b> <b><font color=#0000FF>null</font></b><font color=#FF0000>;</font><a name='line.587'></a>
0588:     <font color=#0000FF>int</font> sx<font color=#FF0000>=</font>b<font color=#FF0000>.</font>x<font color=#FF0000>;</font> <a name='line.588'></a>
0589:     <font color=#0000FF>int</font> sy<font color=#FF0000>=</font>b<font color=#FF0000>.</font>y<font color=#FF0000>;</font><a name='line.589'></a>
0590:     Mobile mob<font color=#FF0000>;</font><a name='line.590'></a>
0591:     <a name='line.591'></a>
0592:     <b><font color=#0000FF>for</font></b> <font color=#FF0000>(</font><font color=#0000FF>int</font> i<font color=#FF0000>=</font><font color=#9A1900>1</font><font color=#FF0000>;</font> i<font color=#FF0000>&lt;</font><font color=#FF0000>=</font><font color=#9A1900>7</font><font color=#FF0000>;</font> i<font color=#FF0000>+</font><font color=#FF0000>+</font><font color=#FF0000>)</font> <font color=#000000>{</font><a name='line.592'></a>
0593:       <b><font color=#0000FF>for</font></b> <font color=#FF0000>(</font><font color=#0000FF>int</font> p<font color=#FF0000>=</font><font color=#FF0000>-</font>i<font color=#FF0000>;</font> p<font color=#FF0000>&lt;</font>i<font color=#FF0000>;</font> p<font color=#FF0000>+</font><font color=#FF0000>+</font><font color=#FF0000>)</font> <font color=#000000>{</font><a name='line.593'></a>
0594:         mob<font color=#FF0000>=</font><b><font color=#000000>getMobile</font></b><font color=#FF0000>(</font>sx<font color=#FF0000>+</font>p<font color=#FF0000>,</font>sy<font color=#FF0000>+</font>i<font color=#FF0000>)</font><font color=#FF0000>;</font><a name='line.594'></a>
0595:         <b><font color=#0000FF>if</font></b> <font color=#FF0000>(</font><font color=#FF0000>(</font>mob<font color=#FF0000>!</font><font color=#FF0000>=</font><b><font color=#0000FF>null</font></b><font color=#FF0000>)</font><font color=#FF0000>&amp;</font><font color=#FF0000>&amp;</font>b<font color=#FF0000>.</font><b><font color=#000000>isHostile</font></b><font color=#FF0000>(</font>mob<font color=#FF0000>)</font><font color=#FF0000>)</font> <b><font color=#0000FF>return</font></b> mob<font color=#FF0000>;</font><a name='line.595'></a>
0596:         mob<font color=#FF0000>=</font><b><font color=#000000>getMobile</font></b><font color=#FF0000>(</font>sx<font color=#FF0000>-</font>p<font color=#FF0000>,</font>sy<font color=#FF0000>-</font>i<font color=#FF0000>)</font><font color=#FF0000>;</font><a name='line.596'></a>
0597:         <b><font color=#0000FF>if</font></b> <font color=#FF0000>(</font><font color=#FF0000>(</font>mob<font color=#FF0000>!</font><font color=#FF0000>=</font><b><font color=#0000FF>null</font></b><font color=#FF0000>)</font><font color=#FF0000>&amp;</font><font color=#FF0000>&amp;</font>b<font color=#FF0000>.</font><b><font color=#000000>isHostile</font></b><font color=#FF0000>(</font>mob<font color=#FF0000>)</font><font color=#FF0000>)</font> <b><font color=#0000FF>return</font></b> mob<font color=#FF0000>;</font><a name='line.597'></a>
0598:         mob<font color=#FF0000>=</font><b><font color=#000000>getMobile</font></b><font color=#FF0000>(</font>sx<font color=#FF0000>+</font>i<font color=#FF0000>,</font>sy<font color=#FF0000>+</font>p<font color=#FF0000>)</font><font color=#FF0000>;</font><a name='line.598'></a>
0599:         <b><font color=#0000FF>if</font></b> <font color=#FF0000>(</font><font color=#FF0000>(</font>mob<font color=#FF0000>!</font><font color=#FF0000>=</font><b><font color=#0000FF>null</font></b><font color=#FF0000>)</font><font color=#FF0000>&amp;</font><font color=#FF0000>&amp;</font>b<font color=#FF0000>.</font><b><font color=#000000>isHostile</font></b><font color=#FF0000>(</font>mob<font color=#FF0000>)</font><font color=#FF0000>)</font> <b><font color=#0000FF>return</font></b> mob<font color=#FF0000>;</font><a name='line.599'></a>
0600:         mob<font color=#FF0000>=</font><b><font color=#000000>getMobile</font></b><font color=#FF0000>(</font>sx<font color=#FF0000>-</font>i<font color=#FF0000>,</font>sy<font color=#FF0000>-</font>p<font color=#FF0000>)</font><font color=#FF0000>;</font><a name='line.600'></a>
0601:         <b><font color=#0000FF>if</font></b> <font color=#FF0000>(</font><font color=#FF0000>(</font>mob<font color=#FF0000>!</font><font color=#FF0000>=</font><b><font color=#0000FF>null</font></b><font color=#FF0000>)</font><font color=#FF0000>&amp;</font><font color=#FF0000>&amp;</font>b<font color=#FF0000>.</font><b><font color=#000000>isHostile</font></b><font color=#FF0000>(</font>mob<font color=#FF0000>)</font><font color=#FF0000>)</font> <b><font color=#0000FF>return</font></b> mob<font color=#FF0000>;</font><a name='line.601'></a>
0602:       <font color=#000000>}</font><a name='line.602'></a>
0603:     <font color=#000000>}</font> <a name='line.603'></a>
0604:     <b><font color=#0000FF>return</font></b> <b><font color=#0000FF>null</font></b><font color=#FF0000>;</font><a name='line.604'></a>
0605:   <font color=#000000>}</font><a name='line.605'></a>
0606:   <a name='line.606'></a>
0607:   <b><font color=#009900>// return movement cost for entering square</font></b><a name='line.607'></a>
0608:   <b><font color=#009900>// 100=normal, 150=slowed, 300=difficult</font></b><a name='line.608'></a>
0609:   <b><font color=#0000FF>public</font></b> <font color=#0000FF>int</font> <b><font color=#000000>getMoveCost</font></b><font color=#FF0000>(</font>Thing mover<font color=#FF0000>,</font> <font color=#0000FF>int</font> x<font color=#FF0000>,</font> <font color=#0000FF>int</font> y<font color=#FF0000>)</font> <font color=#000000>{</font><a name='line.609'></a>
0610:     <b><font color=#0000FF>return</font></b> Tile<font color=#FF0000>.</font><b><font color=#000000>getMoveCost</font></b><font color=#FF0000>(</font>mover<font color=#FF0000>,</font><b><font color=#000000>getTileFull</font></b><font color=#FF0000>(</font>x<font color=#FF0000>,</font>y<font color=#FF0000>)</font><font color=#FF0000>)</font><font color=#FF0000>;</font> <a name='line.610'></a>
0611:   <font color=#000000>}</font><a name='line.611'></a>
0612:   <a name='line.612'></a>
0613:   <b><font color=#0000FF>public</font></b> String <b><font color=#000000>getName</font></b><font color=#FF0000>(</font><font color=#0000FF>int</font> idlevel<font color=#FF0000>)</font> <font color=#000000>{</font> <b><font color=#0000FF>return</font></b> <font color=#808080>"Special Map"</font><font color=#FF0000>;</font><font color=#000000>}</font><a name='line.613'></a>
0614: <a name='line.614'></a>
0615:   <b><font color=#009900>// add thing to map at given location</font></b><a name='line.615'></a>
0616:   <b><font color=#009900>// make this final for performance reasons.....</font></b><a name='line.616'></a>
0617:   <b><font color=#0000FF>public</font></b> <b><font color=#0000FF>final</font></b> <font color=#0000FF>void</font> <b><font color=#000000>addThing</font></b><font color=#FF0000>(</font>Thing thing<font color=#FF0000>,</font><font color=#0000FF>int</font> x<font color=#FF0000>,</font> <font color=#0000FF>int</font> y<font color=#FF0000>)</font> <font color=#000000>{</font><a name='line.617'></a>
0618:     <b><font color=#0000FF>if</font></b> <font color=#FF0000>(</font>thing<font color=#FF0000>=</font><font color=#FF0000>=</font><b><font color=#0000FF>null</font></b><font color=#FF0000>)</font> <b><font color=#0000FF>return</font></b><font color=#FF0000>;</font><a name='line.618'></a>
0619:     thing<font color=#FF0000>.</font><b><font color=#000000>remove</font></b><font color=#FF0000>(</font><font color=#FF0000>)</font><font color=#FF0000>;</font><a name='line.619'></a>
0620:     <b><font color=#000000>addObject</font></b><font color=#FF0000>(</font>thing<font color=#FF0000>,</font>x<font color=#FF0000>,</font>y<font color=#FF0000>)</font><font color=#FF0000>;</font> <a name='line.620'></a>
0621:   <font color=#000000>}</font><a name='line.621'></a>
0622:   <a name='line.622'></a>
0623:   <b><font color=#009900>// add thing to map in random location</font></b><a name='line.623'></a>
0624:   <b><font color=#0000FF>public</font></b> <b><font color=#0000FF>final</font></b> <font color=#0000FF>void</font> <b><font color=#000000>addThing</font></b><font color=#FF0000>(</font>Thing thing<font color=#FF0000>)</font> <font color=#000000>{</font><a name='line.624'></a>
0625:     <b><font color=#0000FF>for</font></b> <font color=#FF0000>(</font><font color=#0000FF>int</font> i<font color=#FF0000>=</font><font color=#9A1900>0</font><font color=#FF0000>;</font> i<font color=#FF0000>&lt;</font>width<font color=#FF0000>*</font>height<font color=#FF0000>;</font> i<font color=#FF0000>+</font><font color=#FF0000>+</font><font color=#FF0000>)</font> <font color=#000000>{</font><a name='line.625'></a>
0626:       <font color=#0000FF>int</font> x<font color=#FF0000>=</font>RPG<font color=#FF0000>.</font><b><font color=#000000>r</font></b><font color=#FF0000>(</font>width<font color=#FF0000>)</font><font color=#FF0000>;</font><a name='line.626'></a>
0627:       <font color=#0000FF>int</font> y<font color=#FF0000>=</font>RPG<font color=#FF0000>.</font><b><font color=#000000>r</font></b><font color=#FF0000>(</font>height<font color=#FF0000>)</font><font color=#FF0000>;</font><a name='line.627'></a>
0628:       <b><font color=#0000FF>if</font></b> <font color=#FF0000>(</font><font color=#FF0000>!</font><b><font color=#000000>isBlocked</font></b><font color=#FF0000>(</font>x<font color=#FF0000>,</font>y<font color=#FF0000>)</font><font color=#FF0000>)</font> <font color=#000000>{</font><a name='line.628'></a>
0629:         <b><font color=#000000>addThing</font></b><font color=#FF0000>(</font>thing<font color=#FF0000>,</font>x<font color=#FF0000>,</font>y<font color=#FF0000>)</font><font color=#FF0000>;</font> <a name='line.629'></a>
0630:         <b><font color=#0000FF>return</font></b><font color=#FF0000>;</font><a name='line.630'></a>
0631:       <font color=#000000>}</font><a name='line.631'></a>
0632:     <font color=#000000>}</font><a name='line.632'></a>
0633:     <b><font color=#0000FF>throw</font></b> <b><font color=#0000FF>new</font></b> <b><font color=#000000>Error</font></b><font color=#FF0000>(</font><font color=#808080>"Can't add thing to map"</font><font color=#FF0000>)</font><font color=#FF0000>;</font><a name='line.633'></a>
0634:   <font color=#000000>}</font><a name='line.634'></a>
0635:   <a name='line.635'></a>
0636:   <b><font color=#009900>// add thing in random location in given area</font></b><a name='line.636'></a>
0637:   <b><font color=#0000FF>public</font></b> <b><font color=#0000FF>final</font></b> <font color=#0000FF>void</font> <b><font color=#000000>addThing</font></b><font color=#FF0000>(</font>Thing thing<font color=#FF0000>,</font><font color=#0000FF>int</font> x1<font color=#FF0000>,</font> <font color=#0000FF>int</font> y1<font color=#FF0000>,</font> <font color=#0000FF>int</font> x2<font color=#FF0000>,</font> <font color=#0000FF>int</font> y2<font color=#FF0000>)</font> <font color=#000000>{</font><a name='line.637'></a>
0638:     Point p<font color=#FF0000>=</font><b><font color=#000000>findFreeSquare</font></b><font color=#FF0000>(</font>x1<font color=#FF0000>,</font>y1<font color=#FF0000>,</font>x2<font color=#FF0000>,</font>y2<font color=#FF0000>)</font><font color=#FF0000>;</font><a name='line.638'></a>
0639:     <b><font color=#0000FF>if</font></b> <font color=#FF0000>(</font>p<font color=#FF0000>!</font><font color=#FF0000>=</font><b><font color=#0000FF>null</font></b><font color=#FF0000>)</font> <b><font color=#000000>addThing</font></b><font color=#FF0000>(</font>thing<font color=#FF0000>,</font>p<font color=#FF0000>.</font>x<font color=#FF0000>,</font>p<font color=#FF0000>.</font>y<font color=#FF0000>)</font><font color=#FF0000>;</font>  <a name='line.639'></a>
0640:     <b><font color=#0000FF>else</font></b> <b><font color=#000000>addThing</font></b><font color=#FF0000>(</font>thing<font color=#FF0000>,</font>x1<font color=#FF0000>,</font>y1<font color=#FF0000>)</font><font color=#FF0000>;</font><a name='line.640'></a>
0641:   <font color=#000000>}</font><a name='line.641'></a>
0642:   <a name='line.642'></a>
0643:   <b><font color=#009900>//move thing to location. basically same as addThing</font></b><a name='line.643'></a>
0644:   <b><font color=#0000FF>public</font></b> <font color=#0000FF>void</font> <b><font color=#000000>moveThing</font></b><font color=#FF0000>(</font>Thing thing<font color=#FF0000>,</font><font color=#0000FF>int</font> x<font color=#FF0000>,</font> <font color=#0000FF>int</font> y<font color=#FF0000>)</font> <font color=#000000>{</font><a name='line.644'></a>
0645:     <b><font color=#000000>addThing</font></b><font color=#FF0000>(</font>thing<font color=#FF0000>,</font>x<font color=#FF0000>,</font>y<font color=#FF0000>)</font><font color=#FF0000>;</font><a name='line.645'></a>
0646:   <font color=#000000>}</font><a name='line.646'></a>
0647:   <a name='line.647'></a>
0648:   <b><font color=#009900>// removes thing from map, returns thing if found, null otherwise</font></b><a name='line.648'></a>
0649:   <b><font color=#0000FF>public</font></b> <font color=#0000FF>void</font> <b><font color=#000000>removeThing</font></b><font color=#FF0000>(</font>Thing thing<font color=#FF0000>)</font> <font color=#000000>{</font><a name='line.649'></a>
0650:     <b><font color=#0000FF>if</font></b> <font color=#FF0000>(</font>thing<font color=#FF0000>.</font>place<font color=#FF0000>!</font><font color=#FF0000>=</font><b><font color=#0000FF>this</font></b><font color=#FF0000>)</font> <b><font color=#0000FF>throw</font></b> <b><font color=#0000FF>new</font></b> <b><font color=#000000>Error</font></b><font color=#FF0000>(</font><font color=#808080>"Thing in wrong place!"</font><font color=#FF0000>)</font><font color=#FF0000>;</font><a name='line.650'></a>
0651:     <a name='line.651'></a>
0652:     <font color=#0000FF>int</font> loc<font color=#FF0000>=</font>thing<font color=#FF0000>.</font>x<font color=#FF0000>+</font>thing<font color=#FF0000>.</font>y<font color=#FF0000>*</font>width<font color=#FF0000>;</font><a name='line.652'></a>
0653:     <b><font color=#0000FF>if</font></b> <font color=#FF0000>(</font>objects<font color=#FF0000>[</font>loc<font color=#FF0000>]</font><font color=#FF0000>=</font><font color=#FF0000>=</font>thing<font color=#FF0000>)</font> <font color=#000000>{</font><a name='line.653'></a>
0654:       objects<font color=#FF0000>[</font>loc<font color=#FF0000>]</font><font color=#FF0000>=</font>thing<font color=#FF0000>.</font>next<font color=#FF0000>;</font><a name='line.654'></a>
0655:       thing<font color=#FF0000>.</font>next<font color=#FF0000>=</font><b><font color=#0000FF>null</font></b><font color=#FF0000>;</font><a name='line.655'></a>
0656:       thing<font color=#FF0000>.</font>place<font color=#FF0000>=</font><b><font color=#0000FF>null</font></b><font color=#FF0000>;</font><a name='line.656'></a>
0657:       <b><font color=#0000FF>return</font></b><font color=#FF0000>;</font><a name='line.657'></a>
0658:     <font color=#000000>}</font><a name='line.658'></a>
0659:     <a name='line.659'></a>
0660:     <b><font color=#0000FF>for</font></b> <font color=#FF0000>(</font>Thing head<font color=#FF0000>=</font>objects<font color=#FF0000>[</font>loc<font color=#FF0000>]</font><font color=#FF0000>;</font> head<font color=#FF0000>!</font><font color=#FF0000>=</font><b><font color=#0000FF>null</font></b><font color=#FF0000>;</font> head<font color=#FF0000>=</font>head<font color=#FF0000>.</font>next<font color=#FF0000>)</font> <font color=#000000>{</font><a name='line.660'></a>
0661:       <b><font color=#0000FF>if</font></b> <font color=#FF0000>(</font>head<font color=#FF0000>.</font>next<font color=#FF0000>=</font><font color=#FF0000>=</font>thing<font color=#FF0000>)</font> <font color=#000000>{</font><a name='line.661'></a>
0662:         head<font color=#FF0000>.</font>next<font color=#FF0000>=</font>thing<font color=#FF0000>.</font>next<font color=#FF0000>;</font><a name='line.662'></a>
0663:         thing<font color=#FF0000>.</font>next<font color=#FF0000>=</font><b><font color=#0000FF>null</font></b><font color=#FF0000>;</font><a name='line.663'></a>
0664:         thing<font color=#FF0000>.</font>place<font color=#FF0000>=</font><b><font color=#0000FF>null</font></b><font color=#FF0000>;</font><a name='line.664'></a>
0665:         <b><font color=#0000FF>return</font></b><font color=#FF0000>;</font><a name='line.665'></a>
0666:       <font color=#000000>}</font>  <a name='line.666'></a>
0667:     <font color=#000000>}</font><a name='line.667'></a>
0668:   <font color=#000000>}</font><a name='line.668'></a>
0669:   <a name='line.669'></a>
0670:   <b><font color=#0000FF>public</font></b> <b><font color=#0000FF>final</font></b> Map <b><font color=#000000>getMap</font></b><font color=#FF0000>(</font><font color=#FF0000>)</font> <font color=#000000>{</font><b><font color=#0000FF>return</font></b> <b><font color=#0000FF>this</font></b><font color=#FF0000>;</font><font color=#000000>}</font><a name='line.670'></a>
0671:   <a name='line.671'></a>
0672:   <b><font color=#0000FF>public</font></b> <font color=#0000FF>boolean</font> <b><font color=#000000>isTransparent</font></b><font color=#FF0000>(</font><font color=#0000FF>int</font> x<font color=#FF0000>,</font><font color=#0000FF>int</font> y<font color=#FF0000>)</font> <font color=#000000>{</font><a name='line.672'></a>
0673:     <font color=#0000FF>int</font> i<font color=#FF0000>=</font>x<font color=#FF0000>+</font>y<font color=#FF0000>*</font>width<font color=#FF0000>;</font><a name='line.673'></a>
0674:     <b><font color=#0000FF>if</font></b> <font color=#FF0000>(</font><font color=#FF0000>(</font>x<font color=#FF0000>&lt;</font><font color=#9A1900>0</font><font color=#FF0000>)</font><font color=#FF0000>|</font><font color=#FF0000>|</font><font color=#FF0000>(</font>y<font color=#FF0000>&lt;</font><font color=#9A1900>0</font><font color=#FF0000>)</font><font color=#FF0000>|</font><font color=#FF0000>|</font><font color=#FF0000>(</font>x<font color=#FF0000>&gt;</font><font color=#FF0000>=</font>width<font color=#FF0000>)</font><font color=#FF0000>|</font><font color=#FF0000>|</font><font color=#FF0000>(</font>y<font color=#FF0000>&gt;</font><font color=#FF0000>=</font>height<font color=#FF0000>)</font><font color=#FF0000>)</font> <b><font color=#0000FF>return</font></b> false<font color=#FF0000>;</font><a name='line.674'></a>
0675:     <b><font color=#0000FF>if</font></b> <font color=#FF0000>(</font><font color=#FF0000>(</font>tiles<font color=#FF0000>[</font>i<font color=#FF0000>]</font><font color=#FF0000>&amp;</font>Tile<font color=#FF0000>.</font>TF_TRANSPARENT<font color=#FF0000>)</font><font color=#FF0000>=</font><font color=#FF0000>=</font><font color=#9A1900>0</font><font color=#FF0000>)</font> <b><font color=#0000FF>return</font></b> false<font color=#FF0000>;</font><a name='line.675'></a>
0676:     Thing track<font color=#FF0000>=</font>objects<font color=#FF0000>[</font>i<font color=#FF0000>]</font><font color=#FF0000>;</font><a name='line.676'></a>
0677:     <b><font color=#0000FF>while</font></b> <font color=#FF0000>(</font>track<font color=#FF0000>!</font><font color=#FF0000>=</font><b><font color=#0000FF>null</font></b><font color=#FF0000>)</font> <font color=#000000>{</font><a name='line.677'></a>
0678:       <b><font color=#0000FF>if</font></b> <font color=#FF0000>(</font><font color=#FF0000>!</font>track<font color=#FF0000>.</font><b><font color=#000000>isTransparent</font></b><font color=#FF0000>(</font><font color=#FF0000>)</font><font color=#FF0000>)</font> <b><font color=#0000FF>return</font></b> false<font color=#FF0000>;</font><a name='line.678'></a>
0679:       track<font color=#FF0000>=</font>track<font color=#FF0000>.</font>next<font color=#FF0000>;</font><a name='line.679'></a>
0680:     <font color=#000000>}</font><a name='line.680'></a>
0681:     <b><font color=#0000FF>return</font></b> true<font color=#FF0000>;</font><a name='line.681'></a>
0682:   <font color=#000000>}</font><a name='line.682'></a>
0683:   <a name='line.683'></a>
0684:   <b><font color=#009900>// is location on valid map area</font></b><a name='line.684'></a>
0685:   <b><font color=#0000FF>public</font></b> <b><font color=#0000FF>final</font></b> <font color=#0000FF>boolean</font> <b><font color=#000000>isValid</font></b><font color=#FF0000>(</font><font color=#0000FF>int</font> x<font color=#FF0000>,</font><font color=#0000FF>int</font> y<font color=#FF0000>)</font> <font color=#000000>{</font><a name='line.685'></a>
0686:     <b><font color=#0000FF>return</font></b> <font color=#FF0000>(</font>x<font color=#FF0000>&gt;</font><font color=#FF0000>=</font><font color=#9A1900>0</font><font color=#FF0000>)</font><font color=#FF0000>&amp;</font><font color=#FF0000>&amp;</font><font color=#FF0000>(</font>y<font color=#FF0000>&gt;</font><font color=#FF0000>=</font><font color=#9A1900>0</font><font color=#FF0000>)</font><font color=#FF0000>&amp;</font><font color=#FF0000>&amp;</font><font color=#FF0000>(</font>x<font color=#FF0000>&lt;</font>width<font color=#FF0000>)</font><font color=#FF0000>&amp;</font><font color=#FF0000>&amp;</font><font color=#FF0000>(</font>y<font color=#FF0000>&lt;</font>height<font color=#FF0000>)</font><font color=#FF0000>;</font> <a name='line.686'></a>
0687:   <font color=#000000>}</font><a name='line.687'></a>
0688:   <a name='line.688'></a>
0689:   <b><font color=#009900>// fast integer LOS algorithm</font></b><a name='line.689'></a>
0690:   <b><font color=#0000FF>public</font></b> <b><font color=#0000FF>final</font></b> <font color=#0000FF>boolean</font> <b><font color=#000000>isLOS</font></b><font color=#FF0000>(</font><font color=#0000FF>int</font> x1<font color=#FF0000>,</font> <font color=#0000FF>int</font> y1<font color=#FF0000>,</font> <font color=#0000FF>int</font> x2<font color=#FF0000>,</font><font color=#0000FF>int</font> y2<font color=#FF0000>)</font> <font color=#000000>{</font><a name='line.690'></a>
0691:     <b><font color=#0000FF>if</font></b> <font color=#FF0000>(</font><font color=#FF0000>!</font><font color=#FF0000>(</font><b><font color=#000000>isValid</font></b><font color=#FF0000>(</font>x1<font color=#FF0000>,</font>y1<font color=#FF0000>)</font><font color=#FF0000>&amp;</font><font color=#FF0000>&amp;</font><b><font color=#000000>isValid</font></b><font color=#FF0000>(</font>x2<font color=#FF0000>,</font>y2<font color=#FF0000>)</font><font color=#FF0000>)</font><font color=#FF0000>)</font> <b><font color=#0000FF>return</font></b> false<font color=#FF0000>;</font><a name='line.691'></a>
0692:     <font color=#0000FF>int</font> x<font color=#FF0000>=</font><font color=#FF0000>(</font>x1<font color=#FF0000>&lt;</font><font color=#FF0000>&lt;</font><font color=#9A1900>8</font><font color=#FF0000>)</font><font color=#FF0000>+</font><font color=#9A1900>128</font><font color=#FF0000>;</font><a name='line.692'></a>
0693:     <font color=#0000FF>int</font> y<font color=#FF0000>=</font><font color=#FF0000>(</font>y1<font color=#FF0000>&lt;</font><font color=#FF0000>&lt;</font><font color=#9A1900>8</font><font color=#FF0000>)</font><font color=#FF0000>+</font><font color=#9A1900>128</font><font color=#FF0000>;</font><a name='line.693'></a>
0694:     <font color=#0000FF>int</font> xd<font color=#FF0000>=</font>x2<font color=#FF0000>-</font>x1<font color=#FF0000>;</font><a name='line.694'></a>
0695:     <font color=#0000FF>int</font> yd<font color=#FF0000>=</font>y2<font color=#FF0000>-</font>y1<font color=#FF0000>;</font><a name='line.695'></a>
0696:     <font color=#0000FF>int</font> dx<font color=#FF0000>;</font><a name='line.696'></a>
0697:     <font color=#0000FF>int</font> dy<font color=#FF0000>;</font><a name='line.697'></a>
0698:     <font color=#0000FF>int</font> count<font color=#FF0000>;</font><a name='line.698'></a>
0699:     <b><font color=#0000FF>if</font></b> <font color=#FF0000>(</font>RPG<font color=#FF0000>.</font><b><font color=#000000>abs</font></b><font color=#FF0000>(</font>xd<font color=#FF0000>)</font><font color=#FF0000>&lt;</font><font color=#FF0000>=</font>RPG<font color=#FF0000>.</font><b><font color=#000000>abs</font></b><font color=#FF0000>(</font>yd<font color=#FF0000>)</font><font color=#FF0000>)</font> <font color=#000000>{</font> <a name='line.699'></a>
0700:       <b><font color=#0000FF>if</font></b> <font color=#FF0000>(</font>yd<font color=#FF0000>=</font><font color=#FF0000>=</font><font color=#9A1900>0</font><font color=#FF0000>)</font> <b><font color=#0000FF>return</font></b> true<font color=#FF0000>;</font> <b><font color=#009900>// check for (0,0)</font></b><a name='line.700'></a>
0701:       dx<font color=#FF0000>=</font><font color=#FF0000>(</font>xd<font color=#FF0000>&lt;</font><font color=#FF0000>&lt;</font><font color=#9A1900>8</font><font color=#FF0000>)</font><font color=#FF0000>/</font>RPG<font color=#FF0000>.</font><b><font color=#000000>abs</font></b><font color=#FF0000>(</font>yd<font color=#FF0000>)</font><font color=#FF0000>;</font><a name='line.701'></a>
0702:       dy<font color=#FF0000>=</font>RPG<font color=#FF0000>.</font><b><font color=#000000>sign</font></b><font color=#FF0000>(</font>yd<font color=#FF0000>)</font><font color=#FF0000>&lt;</font><font color=#FF0000>&lt;</font><font color=#9A1900>8</font><font color=#FF0000>;</font><a name='line.702'></a>
0703:       count<font color=#FF0000>=</font>RPG<font color=#FF0000>.</font><b><font color=#000000>abs</font></b><font color=#FF0000>(</font>yd<font color=#FF0000>)</font><font color=#FF0000>;</font><a name='line.703'></a>
0704:     <font color=#000000>}</font> <b><font color=#0000FF>else</font></b> <font color=#000000>{</font><a name='line.704'></a>
0705:       dx<font color=#FF0000>=</font>RPG<font color=#FF0000>.</font><b><font color=#000000>sign</font></b><font color=#FF0000>(</font>xd<font color=#FF0000>)</font><font color=#FF0000>&lt;</font><font color=#FF0000>&lt;</font><font color=#9A1900>8</font><font color=#FF0000>;</font><a name='line.705'></a>
0706:       dy<font color=#FF0000>=</font><font color=#FF0000>(</font>yd<font color=#FF0000>&lt;</font><font color=#FF0000>&lt;</font><font color=#9A1900>8</font><font color=#FF0000>)</font><font color=#FF0000>/</font>RPG<font color=#FF0000>.</font><b><font color=#000000>abs</font></b><font color=#FF0000>(</font>xd<font color=#FF0000>)</font><font color=#FF0000>;</font><a name='line.706'></a>
0707:       count<font color=#FF0000>=</font>RPG<font color=#FF0000>.</font><b><font color=#000000>abs</font></b><font color=#FF0000>(</font>xd<font color=#FF0000>)</font><font color=#FF0000>;</font><a name='line.707'></a>
0708:     <font color=#000000>}</font><a name='line.708'></a>
0709:     <b><font color=#0000FF>while</font></b> <font color=#FF0000>(</font>count<font color=#FF0000>&gt;</font><font color=#9A1900>0</font><font color=#FF0000>)</font> <font color=#000000>{</font><a name='line.709'></a>
0710:       x<font color=#FF0000>+</font><font color=#FF0000>=</font>dx<font color=#FF0000>;</font><a name='line.710'></a>
0711:       y<font color=#FF0000>+</font><font color=#FF0000>=</font>dy<font color=#FF0000>;</font><a name='line.711'></a>
0712:       <b><font color=#0000FF>if</font></b> <font color=#FF0000>(</font><font color=#FF0000>(</font><b><font color=#000000>getTile</font></b><font color=#FF0000>(</font><font color=#FF0000>(</font>x<font color=#FF0000>&gt;</font><font color=#FF0000>&gt;</font><font color=#9A1900>8</font><font color=#FF0000>)</font><font color=#FF0000>,</font><font color=#FF0000>(</font>y<font color=#FF0000>&gt;</font><font color=#FF0000>&gt;</font><font color=#9A1900>8</font><font color=#FF0000>)</font><font color=#FF0000>)</font><font color=#FF0000>&amp;</font>Tile<font color=#FF0000>.</font>TF_TRANSPARENT<font color=#FF0000>)</font><font color=#FF0000>=</font><font color=#FF0000>=</font><font color=#9A1900>0</font><font color=#FF0000>)</font> <b><font color=#0000FF>return</font></b> false<font color=#FF0000>;</font><a name='line.712'></a>
0713:       count<font color=#FF0000>-</font><font color=#FF0000>-</font><font color=#FF0000>;</font><a name='line.713'></a>
0714:     <font color=#000000>}</font><a name='line.714'></a>
0715:     <b><font color=#0000FF>return</font></b> true<font color=#FF0000>;</font><a name='line.715'></a>
0716:   <font color=#000000>}</font><a name='line.716'></a>
0717:   <a name='line.717'></a>
0718:   <b><font color=#009900>// return max visibility range for map</font></b><a name='line.718'></a>
0719:   <b><font color=#0000FF>public</font></b> <font color=#0000FF>int</font> <b><font color=#000000>visibleRange</font></b><font color=#FF0000>(</font><font color=#FF0000>)</font> <font color=#000000>{</font><b><font color=#0000FF>return</font></b> <font color=#9A1900>7</font><font color=#FF0000>;</font><font color=#000000>}</font><a name='line.719'></a>
0720:   <a name='line.720'></a>
0721:   <b><font color=#009900>// calculates all the visible squares for the hero at given position</font></b><a name='line.721'></a>
0722:   <b><font color=#0000FF>public</font></b> <font color=#0000FF>void</font> <b><font color=#000000>calcVisible</font></b><font color=#FF0000>(</font><font color=#0000FF>int</font> x<font color=#FF0000>,</font> <font color=#0000FF>int</font> y<font color=#FF0000>,</font> <font color=#0000FF>int</font> r<font color=#FF0000>)</font> <font color=#000000>{</font><a name='line.722'></a>
0723:     <b><font color=#0000FF>for</font></b><font color=#FF0000>(</font><font color=#0000FF>int</font> i<font color=#FF0000>=</font><font color=#9A1900>0</font><font color=#FF0000>;</font>i<font color=#FF0000>&lt;</font>size<font color=#FF0000>;</font>i<font color=#FF0000>+</font><font color=#FF0000>+</font><font color=#FF0000>)</font> <font color=#000000>{</font><a name='line.723'></a>
0724:       tiles<font color=#FF0000>[</font>i<font color=#FF0000>]</font><font color=#FF0000>&amp;</font><font color=#FF0000>=</font><font color=#FF0000>(</font><font color=#FF0000>~</font>Tile<font color=#FF0000>.</font>TF_VISIBLE<font color=#FF0000>)</font><font color=#FF0000>;</font><a name='line.724'></a>
0725:     <font color=#000000>}</font>    <a name='line.725'></a>
0726:     <b><font color=#000000>setVisible</font></b><font color=#FF0000>(</font>x<font color=#FF0000>,</font>y<font color=#FF0000>)</font><font color=#FF0000>;</font><a name='line.726'></a>
0727:     <a name='line.727'></a>
0728:     <font color=#0000FF>int</font> tx<font color=#FF0000>=</font><font color=#9A1900>0</font><font color=#FF0000>;</font><a name='line.728'></a>
0729:     <font color=#0000FF>int</font> ty<font color=#FF0000>=</font><font color=#9A1900>0</font><font color=#FF0000>;</font><a name='line.729'></a>
0730:     <font color=#0000FF>int</font> px<font color=#FF0000>=</font><font color=#9A1900>0</font><font color=#FF0000>;</font><a name='line.730'></a>
0731:     <font color=#0000FF>int</font> py<font color=#FF0000>=</font><font color=#9A1900>0</font><font color=#FF0000>;</font><a name='line.731'></a>
0732:     <font color=#0000FF>int</font> c<font color=#FF0000>=</font><font color=#9A1900>0</font><font color=#FF0000>;</font><a name='line.732'></a>
0733:     <a name='line.733'></a>
0734:     <font color=#0000FF>boolean</font> c1<font color=#FF0000>;</font><a name='line.734'></a>
0735:     <font color=#0000FF>boolean</font> c2<font color=#FF0000>;</font><a name='line.735'></a>
0736:     <font color=#0000FF>boolean</font> c3<font color=#FF0000>;</font><a name='line.736'></a>
0737:     <font color=#0000FF>boolean</font> c4<font color=#FF0000>;</font><a name='line.737'></a>
0738:     <a name='line.738'></a>
0739:     <b><font color=#0000FF>for</font></b> <font color=#FF0000>(</font><font color=#0000FF>int</font> l<font color=#FF0000>=</font><font color=#FF0000>-</font>LOS_DETAIL<font color=#FF0000>;</font>l<font color=#FF0000>&lt;</font><font color=#FF0000>=</font>LOS_DETAIL<font color=#FF0000>;</font>l<font color=#FF0000>+</font><font color=#FF0000>+</font><font color=#FF0000>)</font> <font color=#000000>{</font><a name='line.739'></a>
0740:       c1<font color=#FF0000>=</font>true<font color=#FF0000>;</font> c2<font color=#FF0000>=</font>true<font color=#FF0000>;</font> c3<font color=#FF0000>=</font>true<font color=#FF0000>;</font> c4<font color=#FF0000>=</font>true<font color=#FF0000>;</font><a name='line.740'></a>
0741:       <a name='line.741'></a>
0742:       <b><font color=#0000FF>for</font></b> <font color=#FF0000>(</font><font color=#0000FF>int</font> d<font color=#FF0000>=</font><font color=#9A1900>1</font><font color=#FF0000>;</font>d<font color=#FF0000>&lt;</font>r<font color=#FF0000>;</font>d<font color=#FF0000>+</font><font color=#FF0000>+</font><font color=#FF0000>)</font> <font color=#000000>{</font><a name='line.742'></a>
0743:         <b><font color=#0000FF>if</font></b> <font color=#FF0000>(</font><font color=#FF0000>(</font>d<font color=#FF0000>*</font>d<font color=#FF0000>+</font><font color=#FF0000>(</font><font color=#FF0000>(</font>d<font color=#FF0000>*</font>l<font color=#FF0000>)</font><font color=#FF0000>/</font>LOS_DETAIL<font color=#FF0000>)</font><font color=#FF0000>*</font><font color=#FF0000>(</font><font color=#FF0000>(</font>d<font color=#FF0000>*</font>l<font color=#FF0000>)</font><font color=#FF0000>/</font>LOS_DETAIL<font color=#FF0000>)</font><font color=#FF0000>)</font><font color=#FF0000>&gt;</font><font color=#FF0000>(</font>r<font color=#FF0000>*</font>r<font color=#FF0000>)</font><font color=#FF0000>)</font> <font color=#000000>{</font><a name='line.743'></a>
0744:           c1 <font color=#FF0000>=</font> c2 <font color=#FF0000>=</font> c3 <font color=#FF0000>=</font> c4 <font color=#FF0000>=</font> false<font color=#FF0000>;</font>  <a name='line.744'></a>
0745:         <font color=#000000>}</font><a name='line.745'></a>
0746:         <a name='line.746'></a>
0747:         <b><font color=#0000FF>if</font></b> <font color=#FF0000>(</font>c1<font color=#FF0000>)</font> <font color=#000000>{</font><a name='line.747'></a>
0748:           tx<font color=#FF0000>=</font>x<font color=#FF0000>+</font>d<font color=#FF0000>;</font> ty<font color=#FF0000>=</font><font color=#FF0000>(</font>LOS_DETAIL<font color=#FF0000>*</font>y<font color=#FF0000>+</font>l<font color=#FF0000>*</font>d<font color=#FF0000>+</font>LOS_DETAIL<font color=#FF0000>/</font><font color=#9A1900>2</font><font color=#FF0000>)</font><font color=#FF0000>/</font>LOS_DETAIL<font color=#FF0000>;</font><a name='line.748'></a>
0749:           <b><font color=#0000FF>if</font></b> <font color=#FF0000>(</font><b><font color=#000000>isTransparent</font></b><font color=#FF0000>(</font>tx<font color=#FF0000>,</font>ty<font color=#FF0000>)</font><font color=#FF0000>)</font> <font color=#000000>{</font><a name='line.749'></a>
0750:             px<font color=#FF0000>=</font>x<font color=#FF0000>+</font>d<font color=#FF0000>-</font><font color=#9A1900>1</font><font color=#FF0000>;</font> py<font color=#FF0000>=</font><font color=#FF0000>(</font>LOS_DETAIL<font color=#FF0000>*</font>y<font color=#FF0000>+</font>l<font color=#FF0000>*</font><font color=#FF0000>(</font>d<font color=#FF0000>-</font><font color=#9A1900>1</font><font color=#FF0000>)</font><font color=#FF0000>+</font>LOS_DETAIL<font color=#FF0000>/</font><font color=#9A1900>2</font><font color=#FF0000>)</font><font color=#FF0000>/</font>LOS_DETAIL<font color=#FF0000>;</font><a name='line.750'></a>
0751:             c<font color=#FF0000>=</font><b><font color=#000000>getTileFull</font></b><font color=#FF0000>(</font>tx<font color=#FF0000>,</font>ty<font color=#FF0000>)</font><font color=#FF0000>|</font>Tile<font color=#FF0000>.</font>TF_VISIBLE<font color=#FF0000>|</font>Tile<font color=#FF0000>.</font>TF_DISCOVERED<font color=#FF0000>;</font><a name='line.751'></a>
0752:             <b><font color=#000000>setTile</font></b><font color=#FF0000>(</font>tx<font color=#FF0000>,</font>ty<font color=#FF0000>,</font>c<font color=#FF0000>)</font><font color=#FF0000>;</font><a name='line.752'></a>
0753:           <font color=#000000>}</font> <b><font color=#0000FF>else</font></b> <font color=#000000>{</font><b><font color=#000000>setVisible</font></b><font color=#FF0000>(</font>tx<font color=#FF0000>,</font>ty<font color=#FF0000>)</font><font color=#FF0000>;</font> c1<font color=#FF0000>=</font>false<font color=#FF0000>;</font><font color=#000000>}</font><a name='line.753'></a>
0754:         <font color=#000000>}</font> <a name='line.754'></a>
0755:         <a name='line.755'></a>
0756:         <b><font color=#0000FF>if</font></b> <font color=#FF0000>(</font>c2<font color=#FF0000>)</font> <font color=#000000>{</font><a name='line.756'></a>
0757:           tx<font color=#FF0000>=</font>x<font color=#FF0000>-</font>d<font color=#FF0000>;</font> ty<font color=#FF0000>=</font><font color=#FF0000>(</font>LOS_DETAIL<font color=#FF0000>*</font>y<font color=#FF0000>+</font>l<font color=#FF0000>*</font>d<font color=#FF0000>+</font>LOS_DETAIL<font color=#FF0000>/</font><font color=#9A1900>2</font><font color=#FF0000>)</font><font color=#FF0000>/</font>LOS_DETAIL<font color=#FF0000>;</font><a name='line.757'></a>
0758:           <b><font color=#0000FF>if</font></b> <font color=#FF0000>(</font><b><font color=#000000>isTransparent</font></b><font color=#FF0000>(</font>tx<font color=#FF0000>,</font>ty<font color=#FF0000>)</font><font color=#FF0000>)</font> <font color=#000000>{</font><a name='line.758'></a>
0759:             px<font color=#FF0000>=</font>x<font color=#FF0000>-</font>d<font color=#FF0000>+</font><font color=#9A1900>1</font><font color=#FF0000>;</font> py<font color=#FF0000>=</font><font color=#FF0000>(</font>LOS_DETAIL<font color=#FF0000>*</font>y<font color=#FF0000>+</font>l<font color=#FF0000>*</font><font color=#FF0000>(</font>d<font color=#FF0000>-</font><font color=#9A1900>1</font><font color=#FF0000>)</font><font color=#FF0000>+</font>LOS_DETAIL<font color=#FF0000>/</font><font color=#9A1900>2</font><font color=#FF0000>)</font><font color=#FF0000>/</font>LOS_DETAIL<font color=#FF0000>;</font><a name='line.759'></a>
0760:             c<font color=#FF0000>=</font><b><font color=#000000>getTileFull</font></b><font color=#FF0000>(</font>tx<font color=#FF0000>,</font>ty<font color=#FF0000>)</font><font color=#FF0000>|</font>Tile<font color=#FF0000>.</font>TF_VISIBLE<font color=#FF0000>|</font>Tile<font color=#FF0000>.</font>TF_DISCOVERED<font color=#FF0000>;</font><a name='line.760'></a>
0761:             <b><font color=#000000>setTile</font></b><font color=#FF0000>(</font>tx<font color=#FF0000>,</font>ty<font color=#FF0000>,</font>c<font color=#FF0000>)</font><font color=#FF0000>;</font><a name='line.761'></a>
0762:           <font color=#000000>}</font> <b><font color=#0000FF>else</font></b> <font color=#000000>{</font><b><font color=#000000>setVisible</font></b><font color=#FF0000>(</font>tx<font color=#FF0000>,</font>ty<font color=#FF0000>)</font><font color=#FF0000>;</font> c2<font color=#FF0000>=</font>false<font color=#FF0000>;</font><font color=#000000>}</font><a name='line.762'></a>
0763:         <font color=#000000>}</font><a name='line.763'></a>
0764:         <a name='line.764'></a>
0765:         <b><font color=#0000FF>if</font></b> <font color=#FF0000>(</font>c3<font color=#FF0000>)</font> <font color=#000000>{</font><a name='line.765'></a>
0766:           ty<font color=#FF0000>=</font>y<font color=#FF0000>+</font>d<font color=#FF0000>;</font> tx<font color=#FF0000>=</font><font color=#FF0000>(</font>LOS_DETAIL<font color=#FF0000>*</font>x<font color=#FF0000>+</font>l<font color=#FF0000>*</font>d<font color=#FF0000>+</font>LOS_DETAIL<font color=#FF0000>/</font><font color=#9A1900>2</font><font color=#FF0000>)</font><font color=#FF0000>/</font>LOS_DETAIL<font color=#FF0000>;</font><a name='line.766'></a>
0767:           <b><font color=#0000FF>if</font></b> <font color=#FF0000>(</font><b><font color=#000000>isTransparent</font></b><font color=#FF0000>(</font>tx<font color=#FF0000>,</font>ty<font color=#FF0000>)</font><font color=#FF0000>)</font> <font color=#000000>{</font><a name='line.767'></a>
0768:             py<font color=#FF0000>=</font>y<font color=#FF0000>+</font>d<font color=#FF0000>-</font><font color=#9A1900>1</font><font color=#FF0000>;</font> px<font color=#FF0000>=</font><font color=#FF0000>(</font>LOS_DETAIL<font color=#FF0000>*</font>x<font color=#FF0000>+</font>l<font color=#FF0000>*</font><font color=#FF0000>(</font>d<font color=#FF0000>-</font><font color=#9A1900>1</font><font color=#FF0000>)</font><font color=#FF0000>+</font>LOS_DETAIL<font color=#FF0000>/</font><font color=#9A1900>2</font><font color=#FF0000>)</font><font color=#FF0000>/</font>LOS_DETAIL<font color=#FF0000>;</font><a name='line.768'></a>
0769:             c<font color=#FF0000>=</font><b><font color=#000000>getTileFull</font></b><font color=#FF0000>(</font>tx<font color=#FF0000>,</font>ty<font color=#FF0000>)</font><font color=#FF0000>|</font>Tile<font color=#FF0000>.</font>TF_VISIBLE<font color=#FF0000>|</font>Tile<font color=#FF0000>.</font>TF_DISCOVERED<font color=#FF0000>;</font><a name='line.769'></a>
0770:             <b><font color=#000000>setTile</font></b><font color=#FF0000>(</font>tx<font color=#FF0000>,</font>ty<font color=#FF0000>,</font>c<font color=#FF0000>)</font><font color=#FF0000>;</font><a name='line.770'></a>
0771:           <font color=#000000>}</font> <b><font color=#0000FF>else</font></b> <font color=#000000>{</font><b><font color=#000000>setVisible</font></b><font color=#FF0000>(</font>tx<font color=#FF0000>,</font>ty<font color=#FF0000>)</font><font color=#FF0000>;</font> c3<font color=#FF0000>=</font>false<font color=#FF0000>;</font><font color=#000000>}</font><a name='line.771'></a>
0772:         <font color=#000000>}</font><a name='line.772'></a>
0773:         <a name='line.773'></a>
0774:         <b><font color=#0000FF>if</font></b> <font color=#FF0000>(</font>c4<font color=#FF0000>)</font> <font color=#000000>{</font><a name='line.774'></a>
0775:           ty<font color=#FF0000>=</font>y<font color=#FF0000>-</font>d<font color=#FF0000>;</font> tx<font color=#FF0000>=</font><font color=#FF0000>(</font>LOS_DETAIL<font color=#FF0000>*</font>x<font color=#FF0000>+</font>l<font color=#FF0000>*</font>d<font color=#FF0000>+</font>LOS_DETAIL<font color=#FF0000>/</font><font color=#9A1900>2</font><font color=#FF0000>)</font><font color=#FF0000>/</font>LOS_DETAIL<font color=#FF0000>;</font><a name='line.775'></a>
0776:           <b><font color=#0000FF>if</font></b> <font color=#FF0000>(</font><b><font color=#000000>isTransparent</font></b><font color=#FF0000>(</font>tx<font color=#FF0000>,</font>ty<font color=#FF0000>)</font><font color=#FF0000>)</font> <font color=#000000>{</font><a name='line.776'></a>
0777:             py<font color=#FF0000>=</font>y<font color=#FF0000>-</font>d<font color=#FF0000>+</font><font color=#9A1900>1</font><font color=#FF0000>;</font> px<font color=#FF0000>=</font><font color=#FF0000>(</font>LOS_DETAIL<font color=#FF0000>*</font>x<font color=#FF0000>+</font>l<font color=#FF0000>*</font><font color=#FF0000>(</font>d<font color=#FF0000>-</font><font color=#9A1900>1</font><font color=#FF0000>)</font><font color=#FF0000>+</font>LOS_DETAIL<font color=#FF0000>/</font><font color=#9A1900>2</font><font color=#FF0000>)</font><font color=#FF0000>/</font>LOS_DETAIL<font color=#FF0000>;</font><a name='line.777'></a>
0778:             c<font color=#FF0000>=</font><b><font color=#000000>getTileFull</font></b><font color=#FF0000>(</font>tx<font color=#FF0000>,</font>ty<font color=#FF0000>)</font><font color=#FF0000>|</font>Tile<font color=#FF0000>.</font>TF_VISIBLE<font color=#FF0000>|</font>Tile<font color=#FF0000>.</font>TF_DISCOVERED<font color=#FF0000>;</font><a name='line.778'></a>
0779:             <b><font color=#000000>setTile</font></b><font color=#FF0000>(</font>tx<font color=#FF0000>,</font>ty<font color=#FF0000>,</font>c<font color=#FF0000>)</font><font color=#FF0000>;</font><a name='line.779'></a>
0780:           <font color=#000000>}</font> <b><font color=#0000FF>else</font></b> <font color=#000000>{</font><b><font color=#000000>setVisible</font></b><font color=#FF0000>(</font>tx<font color=#FF0000>,</font>ty<font color=#FF0000>)</font><font color=#FF0000>;</font> c4<font color=#FF0000>=</font>false<font color=#FF0000>;</font><font color=#000000>}</font><a name='line.780'></a>
0781:         <font color=#000000>}</font><a name='line.781'></a>
0782:       <font color=#000000>}</font>    <a name='line.782'></a>
0783:     <font color=#000000>}</font><a name='line.783'></a>
0784:     <a name='line.784'></a>
0785:     <b><font color=#009900>// blindnes / trueview pass</font></b><a name='line.785'></a>
0786:     <font color=#0000FF>int</font> blinded<font color=#FF0000>=</font>Game<font color=#FF0000>.</font>hero<font color=#FF0000>.</font><b><font color=#000000>getStat</font></b><font color=#FF0000>(</font>RPG<font color=#FF0000>.</font>ST_BLINDED<font color=#FF0000>)</font><font color=#FF0000>;</font><a name='line.786'></a>
0787:     <font color=#0000FF>int</font> trueview<font color=#FF0000>=</font>Game<font color=#FF0000>.</font>hero<font color=#FF0000>.</font><b><font color=#000000>getStat</font></b><font color=#FF0000>(</font>RPG<font color=#FF0000>.</font>ST_TRUEVIEW<font color=#FF0000>)</font><font color=#FF0000>;</font><a name='line.787'></a>
0788:     <b><font color=#0000FF>for</font></b> <font color=#FF0000>(</font><font color=#0000FF>int</font> lx<font color=#FF0000>=</font>x<font color=#FF0000>-</font>r<font color=#FF0000>;</font>lx<font color=#FF0000>&lt;</font><font color=#FF0000>=</font>x<font color=#FF0000>+</font>r<font color=#FF0000>;</font> lx<font color=#FF0000>+</font><font color=#FF0000>+</font><font color=#FF0000>)</font> <b><font color=#0000FF>for</font></b> <font color=#FF0000>(</font><font color=#0000FF>int</font> ly<font color=#FF0000>=</font>y<font color=#FF0000>-</font>r<font color=#FF0000>;</font>ly<font color=#FF0000>&lt;</font><font color=#FF0000>=</font>y<font color=#FF0000>+</font>r<font color=#FF0000>;</font> ly<font color=#FF0000>+</font><font color=#FF0000>+</font><font color=#FF0000>)</font> <font color=#000000>{</font><a name='line.788'></a>
0789:       <b><font color=#0000FF>if</font></b> <font color=#FF0000>(</font><font color=#FF0000>(</font>blinded<font color=#FF0000>&gt;</font><font color=#9A1900>0</font><font color=#FF0000>)</font><font color=#FF0000>&amp;</font><font color=#FF0000>&amp;</font><font color=#FF0000>(</font><font color=#FF0000>(</font>lx<font color=#FF0000>!</font><font color=#FF0000>=</font><font color=#9A1900>0</font><font color=#FF0000>)</font><font color=#FF0000>|</font><font color=#FF0000>|</font><font color=#FF0000>(</font>ly<font color=#FF0000>!</font><font color=#FF0000>=</font><font color=#9A1900>0</font><font color=#FF0000>)</font><font color=#FF0000>)</font><font color=#FF0000>)</font> <font color=#000000>{</font><a name='line.789'></a>
0790:         <font color=#0000FF>int</font> t<font color=#FF0000>=</font><b><font color=#000000>getTileFull</font></b><font color=#FF0000>(</font>lx<font color=#FF0000>,</font>ly<font color=#FF0000>)</font><font color=#FF0000>;</font><a name='line.790'></a>
0791:         <b><font color=#000000>setTile</font></b><font color=#FF0000>(</font>lx<font color=#FF0000>,</font>ly<font color=#FF0000>,</font>t<font color=#FF0000>&amp;</font><font color=#FF0000>(</font><font color=#FF0000>~</font>Tile<font color=#FF0000>.</font>TF_VISIBLE<font color=#FF0000>)</font><font color=#FF0000>)</font><font color=#FF0000>;</font><a name='line.791'></a>
0792:       <font color=#000000>}</font><a name='line.792'></a>
0793:       <b><font color=#0000FF>if</font></b> <font color=#FF0000>(</font><font color=#FF0000>(</font>trueview<font color=#FF0000>&gt;</font><font color=#9A1900>0</font><font color=#FF0000>)</font><font color=#FF0000>&amp;</font><font color=#FF0000>&amp;</font><font color=#FF0000>(</font>trueview<font color=#FF0000>&gt;</font><font color=#FF0000>=</font><font color=#FF0000>(</font><font color=#FF0000>(</font>lx<font color=#FF0000>-</font>x<font color=#FF0000>)</font><font color=#FF0000>*</font><font color=#FF0000>(</font>lx<font color=#FF0000>-</font>x<font color=#FF0000>)</font><font color=#FF0000>+</font><font color=#FF0000>(</font>ly<font color=#FF0000>-</font>y<font color=#FF0000>)</font><font color=#FF0000>*</font><font color=#FF0000>(</font>ly<font color=#FF0000>-</font>y<font color=#FF0000>)</font><font color=#FF0000>)</font><font color=#FF0000>)</font><font color=#FF0000>)</font> <font color=#000000>{</font><a name='line.793'></a>
0794:         <b><font color=#000000>setVisible</font></b><font color=#FF0000>(</font>lx<font color=#FF0000>,</font>ly<font color=#FF0000>)</font><font color=#FF0000>;</font> <a name='line.794'></a>
0795:       <font color=#000000>}</font><a name='line.795'></a>
0796:     <font color=#000000>}</font><a name='line.796'></a>
0797:   <font color=#000000>}</font><a name='line.797'></a>
0798:   <a name='line.798'></a>
0799:   <b><font color=#009900>// Make a square visible</font></b><a name='line.799'></a>
0800:   <b><font color=#0000FF>public</font></b> <font color=#0000FF>void</font> <b><font color=#000000>setVisible</font></b><font color=#FF0000>(</font><font color=#0000FF>int</font> x<font color=#FF0000>,</font> <font color=#0000FF>int</font> y<font color=#FF0000>)</font> <font color=#000000>{</font><a name='line.800'></a>
0801:   <font color=#0000FF>int</font> i<font color=#FF0000>=</font>x<font color=#FF0000>+</font>y<font color=#FF0000>*</font>width<font color=#FF0000>;</font><a name='line.801'></a>
0802:     <b><font color=#0000FF>if</font></b> <font color=#FF0000>(</font><font color=#FF0000>(</font>x<font color=#FF0000>&lt;</font><font color=#9A1900>0</font><font color=#FF0000>)</font><font color=#FF0000>|</font><font color=#FF0000>|</font><font color=#FF0000>(</font>y<font color=#FF0000>&lt;</font><font color=#9A1900>0</font><font color=#FF0000>)</font><font color=#FF0000>|</font><font color=#FF0000>|</font><font color=#FF0000>(</font>x<font color=#FF0000>&gt;</font><font color=#FF0000>=</font>width<font color=#FF0000>)</font><font color=#FF0000>|</font><font color=#FF0000>|</font><font color=#FF0000>(</font>y<font color=#FF0000>&gt;</font><font color=#FF0000>=</font>height<font color=#FF0000>)</font><font color=#FF0000>)</font> <b><font color=#0000FF>return</font></b><font color=#FF0000>;</font><a name='line.802'></a>
0803:     <b><font color=#0000FF>if</font></b> <font color=#FF0000>(</font><font color=#FF0000>(</font>tiles<font color=#FF0000>[</font>i<font color=#FF0000>]</font><font color=#FF0000>&amp;</font>Tile<font color=#FF0000>.</font>TF_VISIBLE<font color=#FF0000>)</font><font color=#FF0000>=</font><font color=#FF0000>=</font><font color=#9A1900>0</font><font color=#FF0000>)</font> <font color=#000000>{</font><a name='line.803'></a>
0804:       tiles<font color=#FF0000>[</font>i<font color=#FF0000>]</font><font color=#FF0000>|</font><font color=#FF0000>=</font>Tile<font color=#FF0000>.</font>TF_VISIBLE<font color=#FF0000>|</font>Tile<font color=#FF0000>.</font>TF_DISCOVERED<font color=#FF0000>;</font><a name='line.804'></a>
0805:       Mobile m<font color=#FF0000>=</font><b><font color=#000000>getMobile</font></b><font color=#FF0000>(</font>x<font color=#FF0000>,</font>y<font color=#FF0000>)</font><font color=#FF0000>;</font><a name='line.805'></a>
0806:       <b><font color=#0000FF>if</font></b> <font color=#FF0000>(</font>m<font color=#FF0000>!</font><font color=#FF0000>=</font><b><font color=#0000FF>null</font></b><font color=#FF0000>)</font> <font color=#000000>{</font><a name='line.806'></a>
0807:         m<font color=#FF0000>.</font><b><font color=#000000>notify</font></b><font color=#FF0000>(</font>AI<font color=#FF0000>.</font>EVENT_VISIBLE<font color=#FF0000>,</font><font color=#9A1900>0</font><font color=#FF0000>,</font><b><font color=#0000FF>null</font></b><font color=#FF0000>)</font><font color=#FF0000>;</font><a name='line.807'></a>
0808:       <font color=#000000>}</font><a name='line.808'></a>
0809:     <font color=#000000>}</font><a name='line.809'></a>
0810:   <font color=#000000>}</font><a name='line.810'></a>
0811: <a name='line.811'></a>
0812:   <b><font color=#009900>// Can the square currently be seen by the hero</font></b><a name='line.812'></a>
0813:   <b><font color=#0000FF>public</font></b> <font color=#0000FF>boolean</font> <b><font color=#000000>isVisible</font></b><font color=#FF0000>(</font><font color=#0000FF>int</font> x<font color=#FF0000>,</font><font color=#0000FF>int</font> y<font color=#FF0000>)</font> <font color=#000000>{</font><a name='line.813'></a>
0814:     <b><font color=#0000FF>return</font></b> <font color=#FF0000>(</font><b><font color=#000000>getTileFlags</font></b><font color=#FF0000>(</font>x<font color=#FF0000>,</font>y<font color=#FF0000>)</font><font color=#FF0000>&amp;</font>Tile<font color=#FF0000>.</font>TF_VISIBLE<font color=#FF0000>)</font><font color=#FF0000>&gt;</font><font color=#9A1900>0</font><font color=#FF0000>;</font>  <a name='line.814'></a>
0815:   <font color=#000000>}</font><a name='line.815'></a>
0816:   <a name='line.816'></a>
0817:   <b><font color=#009900>// has the square been viewed at some point?</font></b><a name='line.817'></a>
0818:   <b><font color=#0000FF>public</font></b> <font color=#0000FF>boolean</font> <b><font color=#000000>isDiscovered</font></b><font color=#FF0000>(</font><font color=#0000FF>int</font> x<font color=#FF0000>,</font><font color=#0000FF>int</font> y<font color=#FF0000>)</font> <font color=#000000>{</font><a name='line.818'></a>
0819:     <b><font color=#0000FF>return</font></b> <font color=#FF0000>(</font><b><font color=#000000>getTileFlags</font></b><font color=#FF0000>(</font>x<font color=#FF0000>,</font>y<font color=#FF0000>)</font><font color=#FF0000>&amp;</font>Tile<font color=#FF0000>.</font>TF_DISCOVERED<font color=#FF0000>)</font><font color=#FF0000>&gt;</font><font color=#9A1900>0</font><font color=#FF0000>;</font>  <a name='line.819'></a>
0820:   <font color=#000000>}</font><a name='line.820'></a>
0821: <a name='line.821'></a>
0822:   <b><font color=#0000FF>public</font></b> <font color=#0000FF>boolean</font> <b><font color=#000000>isEmpty</font></b><font color=#FF0000>(</font><font color=#0000FF>int</font> x<font color=#FF0000>,</font><font color=#0000FF>int</font> y<font color=#FF0000>)</font> <font color=#000000>{</font><a name='line.822'></a>
0823:     <b><font color=#0000FF>return</font></b> <b><font color=#000000>getObjects</font></b><font color=#FF0000>(</font>x<font color=#FF0000>,</font>y<font color=#FF0000>)</font><font color=#FF0000>=</font><font color=#FF0000>=</font><b><font color=#0000FF>null</font></b><font color=#FF0000>;</font>  <a name='line.823'></a>
0824:   <font color=#000000>}</font><a name='line.824'></a>
0825:   <a name='line.825'></a>
0826:   <b><font color=#0000FF>public</font></b> <font color=#0000FF>boolean</font> <b><font color=#000000>isClear</font></b><font color=#FF0000>(</font><font color=#0000FF>int</font> x<font color=#FF0000>,</font><font color=#0000FF>int</font> y<font color=#FF0000>)</font> <font color=#000000>{</font><a name='line.826'></a>
0827:     <b><font color=#0000FF>return</font></b> <b><font color=#000000>isEmpty</font></b><font color=#FF0000>(</font>x<font color=#FF0000>,</font>y<font color=#FF0000>)</font><font color=#FF0000>&amp;</font><font color=#FF0000>&amp;</font><font color=#FF0000>(</font><font color=#FF0000>!</font><b><font color=#000000>isBlocked</font></b><font color=#FF0000>(</font>x<font color=#FF0000>,</font>y<font color=#FF0000>)</font><font color=#FF0000>)</font><font color=#FF0000>;</font>  <a name='line.827'></a>
0828:   <font color=#000000>}</font><a name='line.828'></a>
0829: <a name='line.829'></a>
0830:   <b><font color=#0000FF>public</font></b> Point <b><font color=#000000>tracePath</font></b><font color=#FF0000>(</font><font color=#0000FF>int</font> x1<font color=#FF0000>,</font><font color=#0000FF>int</font> y1<font color=#FF0000>,</font> <font color=#0000FF>int</font> x2<font color=#FF0000>,</font> <font color=#0000FF>int</font> y2<font color=#FF0000>)</font> <font color=#000000>{</font><a name='line.830'></a>
0831:     <font color=#0000FF>int</font> xd<font color=#FF0000>=</font>x2<font color=#FF0000>-</font>x1<font color=#FF0000>;</font> <a name='line.831'></a>
0832:     <font color=#0000FF>int</font> yd<font color=#FF0000>=</font>y2<font color=#FF0000>-</font>y1<font color=#FF0000>;</font><a name='line.832'></a>
0833:     <b><font color=#0000FF>if</font></b> <font color=#FF0000>(</font><font color=#FF0000>(</font>xd<font color=#FF0000>=</font><font color=#FF0000>=</font><font color=#9A1900>0</font><font color=#FF0000>)</font><font color=#FF0000>&amp;</font><font color=#FF0000>&amp;</font><font color=#FF0000>(</font>yd<font color=#FF0000>=</font><font color=#FF0000>=</font><font color=#9A1900>0</font><font color=#FF0000>)</font><font color=#FF0000>)</font> <b><font color=#0000FF>return</font></b> <b><font color=#0000FF>new</font></b> <b><font color=#000000>Point</font></b><font color=#FF0000>(</font>x1<font color=#FF0000>,</font>y1<font color=#FF0000>)</font><font color=#FF0000>;</font><a name='line.833'></a>
0834:     <font color=#0000FF>double</font> d<font color=#FF0000>=</font>Math<font color=#FF0000>.</font><b><font color=#000000>sqrt</font></b><font color=#FF0000>(</font>xd<font color=#FF0000>*</font>xd<font color=#FF0000>+</font>yd<font color=#FF0000>*</font>yd<font color=#FF0000>)</font><font color=#FF0000>;</font><a name='line.834'></a>
0835:     <font color=#0000FF>double</font> dx<font color=#FF0000>=</font>xd<font color=#FF0000>/</font>d<font color=#FF0000>;</font><a name='line.835'></a>
0836:     <font color=#0000FF>double</font> dy<font color=#FF0000>=</font>yd<font color=#FF0000>/</font>d<font color=#FF0000>;</font><a name='line.836'></a>
0837:     <font color=#0000FF>double</font> x <font color=#FF0000>=</font>x1<font color=#FF0000>+</font><font color=#9A1900>0.5+</font>dx<font color=#FF0000>;</font><a name='line.837'></a>
0838:     <font color=#0000FF>double</font> y<font color=#FF0000>=</font> y1<font color=#FF0000>+</font><font color=#9A1900>0.5+</font>dy<font color=#FF0000>;</font><a name='line.838'></a>
0839:     <b><font color=#0000FF>while</font></b> <font color=#FF0000>(</font><font color=#FF0000>(</font><font color=#FF0000>(</font><font color=#FF0000>(</font><font color=#0000FF>int</font><font color=#FF0000>)</font>x<font color=#FF0000>)</font><font color=#FF0000>!</font><font color=#FF0000>=</font>x2<font color=#FF0000>)</font><font color=#FF0000>|</font><font color=#FF0000>|</font><font color=#FF0000>(</font><font color=#FF0000>(</font><font color=#FF0000>(</font><font color=#0000FF>int</font><font color=#FF0000>)</font>y<font color=#FF0000>)</font><font color=#FF0000>!</font><font color=#FF0000>=</font>y2<font color=#FF0000>)</font><font color=#FF0000>)</font> <font color=#000000>{</font><a name='line.839'></a>
0840:       x<font color=#FF0000>=</font>x<font color=#FF0000>+</font>dx<font color=#FF0000>;</font><a name='line.840'></a>
0841:       y<font color=#FF0000>=</font>y<font color=#FF0000>+</font>dy<font color=#FF0000>;</font><a name='line.841'></a>
0842:       <font color=#0000FF>int</font> cx<font color=#FF0000>=</font><font color=#FF0000>(</font><font color=#0000FF>int</font><font color=#FF0000>)</font>x<font color=#FF0000>;</font><a name='line.842'></a>
0843:       <font color=#0000FF>int</font> cy<font color=#FF0000>=</font><font color=#FF0000>(</font><font color=#0000FF>int</font><font color=#FF0000>)</font>y<font color=#FF0000>;</font><a name='line.843'></a>
0844:       <b><font color=#0000FF>if</font></b> <font color=#FF0000>(</font><font color=#FF0000>(</font><b><font color=#000000>getTileFull</font></b><font color=#FF0000>(</font>cx<font color=#FF0000>,</font>cy<font color=#FF0000>)</font><font color=#FF0000>&amp;</font>Tile<font color=#FF0000>.</font>TF_BLOCKED<font color=#FF0000>)</font><font color=#FF0000>!</font><font color=#FF0000>=</font><font color=#9A1900>0</font><font color=#FF0000>)</font> <b><font color=#0000FF>return</font></b> <b><font color=#0000FF>new</font></b> <b><font color=#000000>Point</font></b><font color=#FF0000>(</font><font color=#FF0000>(</font><font color=#0000FF>int</font><font color=#FF0000>)</font><font color=#FF0000>(</font>x<font color=#FF0000>-</font>dx<font color=#FF0000>)</font><font color=#FF0000>,</font><font color=#FF0000>(</font><font color=#0000FF>int</font><font color=#FF0000>)</font><font color=#FF0000>(</font>y<font color=#FF0000>-</font>dy<font color=#FF0000>)</font><font color=#FF0000>)</font><font color=#FF0000>;</font><a name='line.844'></a>
0845:       <b><font color=#0000FF>if</font></b> <font color=#FF0000>(</font><b><font color=#000000>isBlocked</font></b><font color=#FF0000>(</font>cx<font color=#FF0000>,</font>cy<font color=#FF0000>)</font><font color=#FF0000>)</font> <b><font color=#0000FF>return</font></b> <b><font color=#0000FF>new</font></b> <b><font color=#000000>Point</font></b><font color=#FF0000>(</font>cx<font color=#FF0000>,</font>cy<font color=#FF0000>)</font><font color=#FF0000>;</font><a name='line.845'></a>
0846:     <font color=#000000>}</font><a name='line.846'></a>
0847:     <b><font color=#0000FF>return</font></b> <b><font color=#0000FF>new</font></b> <b><font color=#000000>Point</font></b><font color=#FF0000>(</font>x2<font color=#FF0000>,</font>y2<font color=#FF0000>)</font><font color=#FF0000>;</font><a name='line.847'></a>
0848:   <font color=#000000>}</font><a name='line.848'></a>
0849: <a name='line.849'></a>
0850:   <b><font color=#009900>// Does the square contain a solid wall, monster or hard scenery</font></b><a name='line.850'></a>
0851:   <b><font color=#0000FF>public</font></b> <font color=#0000FF>boolean</font> <b><font color=#000000>isBlocked</font></b><font color=#FF0000>(</font><font color=#0000FF>int</font> x<font color=#FF0000>,</font><font color=#0000FF>int</font> y<font color=#FF0000>)</font> <font color=#000000>{</font><a name='line.851'></a>
0852:     <b><font color=#0000FF>if</font></b> <font color=#FF0000>(</font><font color=#FF0000>(</font>x<font color=#FF0000>&lt;</font><font color=#9A1900>0</font><font color=#FF0000>)</font><font color=#FF0000>|</font><font color=#FF0000>|</font><font color=#FF0000>(</font>y<font color=#FF0000>&lt;</font><font color=#9A1900>0</font><font color=#FF0000>)</font><font color=#FF0000>|</font><font color=#FF0000>|</font><font color=#FF0000>(</font>x<font color=#FF0000>&gt;</font><font color=#FF0000>=</font>width<font color=#FF0000>)</font><font color=#FF0000>|</font><font color=#FF0000>|</font><font color=#FF0000>(</font>y<font color=#FF0000>&gt;</font><font color=#FF0000>=</font>height<font color=#FF0000>)</font><font color=#FF0000>)</font> <b><font color=#0000FF>return</font></b> true<font color=#FF0000>;</font><a name='line.852'></a>
0853:     <font color=#0000FF>int</font> i<font color=#FF0000>=</font>x<font color=#FF0000>+</font>y<font color=#FF0000>*</font>width<font color=#FF0000>;</font><a name='line.853'></a>
0854:     <b><font color=#0000FF>if</font></b> <font color=#FF0000>(</font><font color=#FF0000>(</font>tiles<font color=#FF0000>[</font>i<font color=#FF0000>]</font><font color=#FF0000>&amp;</font>Tile<font color=#FF0000>.</font>TF_BLOCKED<font color=#FF0000>)</font><font color=#FF0000>!</font><font color=#FF0000>=</font><font color=#9A1900>0</font><font color=#FF0000>)</font> <b><font color=#0000FF>return</font></b> true<font color=#FF0000>;</font><a name='line.854'></a>
0855:     Thing tracker <font color=#FF0000>=</font> objects<font color=#FF0000>[</font>i<font color=#FF0000>]</font><font color=#FF0000>;</font><a name='line.855'></a>
0856:     <b><font color=#0000FF>while</font></b> <font color=#FF0000>(</font>tracker<font color=#FF0000>!</font><font color=#FF0000>=</font><b><font color=#0000FF>null</font></b><font color=#FF0000>)</font> <font color=#000000>{</font><a name='line.856'></a>
0857:       <b><font color=#0000FF>if</font></b> <font color=#FF0000>(</font>tracker<font color=#FF0000>.</font><b><font color=#000000>isBlocking</font></b><font color=#FF0000>(</font><font color=#FF0000>)</font><font color=#FF0000>)</font> <b><font color=#0000FF>return</font></b> true<font color=#FF0000>;</font>  <a name='line.857'></a>
0858:       tracker<font color=#FF0000>=</font>tracker<font color=#FF0000>.</font>next<font color=#FF0000>;</font><a name='line.858'></a>
0859:     <font color=#000000>}</font><a name='line.859'></a>
0860:     <b><font color=#0000FF>return</font></b> false<font color=#FF0000>;</font>  <a name='line.860'></a>
0861:   <font color=#000000>}</font><a name='line.861'></a>
0862:   <a name='line.862'></a>
0863:   <b><font color=#009900>// return true if a tile is blocked by a sold wall</font></b><a name='line.863'></a>
0864:   <b><font color=#0000FF>public</font></b> <b><font color=#0000FF>final</font></b> <font color=#0000FF>boolean</font> <b><font color=#000000>isTileBlocked</font></b><font color=#FF0000>(</font><font color=#0000FF>int</font> x<font color=#FF0000>,</font> <font color=#0000FF>int</font> y<font color=#FF0000>)</font> <font color=#000000>{</font><a name='line.864'></a>
0865:     <b><font color=#0000FF>if</font></b> <font color=#FF0000>(</font><font color=#FF0000>(</font>x<font color=#FF0000>&lt;</font><font color=#9A1900>0</font><font color=#FF0000>)</font><font color=#FF0000>|</font><font color=#FF0000>|</font><font color=#FF0000>(</font>y<font color=#FF0000>&lt;</font><font color=#9A1900>0</font><font color=#FF0000>)</font><font color=#FF0000>|</font><font color=#FF0000>|</font><font color=#FF0000>(</font>x<font color=#FF0000>&gt;</font><font color=#FF0000>=</font>width<font color=#FF0000>)</font><font color=#FF0000>|</font><font color=#FF0000>|</font><font color=#FF0000>(</font>y<font color=#FF0000>&gt;</font><font color=#FF0000>=</font>height<font color=#FF0000>)</font><font color=#FF0000>)</font> <b><font color=#0000FF>return</font></b> true<font color=#FF0000>;</font><a name='line.865'></a>
0866:     <b><font color=#0000FF>if</font></b> <font color=#FF0000>(</font><font color=#FF0000>(</font>tiles<font color=#FF0000>[</font>x<font color=#FF0000>+</font>y<font color=#FF0000>*</font>width<font color=#FF0000>]</font><font color=#FF0000>&amp;</font>Tile<font color=#FF0000>.</font>TF_BLOCKED<font color=#FF0000>)</font><font color=#FF0000>!</font><font color=#FF0000>=</font><font color=#9A1900>0</font><font color=#FF0000>)</font> <b><font color=#0000FF>return</font></b> true<font color=#FF0000>;</font><a name='line.866'></a>
0867:     <b><font color=#0000FF>return</font></b> false<font color=#FF0000>;</font><a name='line.867'></a>
0868:   <font color=#000000>}</font><a name='line.868'></a>
0869:   <a name='line.869'></a>
0870:   <b><font color=#0000FF>public</font></b> <font color=#0000FF>boolean</font> <b><font color=#000000>isPassable</font></b><font color=#FF0000>(</font><font color=#0000FF>int</font> x<font color=#FF0000>,</font> <font color=#0000FF>int</font> y<font color=#FF0000>)</font> <font color=#000000>{</font><a name='line.870'></a>
0871:     Secret s<font color=#FF0000>=</font><font color=#FF0000>(</font>Secret<font color=#FF0000>)</font><b><font color=#000000>getObject</font></b><font color=#FF0000>(</font>x<font color=#FF0000>,</font>y<font color=#FF0000>,</font>Secret<font color=#FF0000>.</font><b><font color=#0000FF>class</font></b><font color=#FF0000>)</font><font color=#FF0000>;</font><a name='line.871'></a>
0872:     <b><font color=#0000FF>return</font></b> <font color=#FF0000>(</font><font color=#FF0000>!</font><b><font color=#000000>isBlocked</font></b><font color=#FF0000>(</font>x<font color=#FF0000>,</font>y<font color=#FF0000>)</font><font color=#FF0000>|</font><font color=#FF0000>|</font><font color=#FF0000>(</font>s<font color=#FF0000>!</font><font color=#FF0000>=</font><b><font color=#0000FF>null</font></b><font color=#FF0000>)</font><font color=#FF0000>)</font><font color=#FF0000>;</font> <a name='line.872'></a>
0873:   <font color=#000000>}</font><a name='line.873'></a>
0874: <a name='line.874'></a>
0875:   <b><font color=#009900>// get path code</font></b><a name='line.875'></a>
0876:   <b><font color=#0000FF>public</font></b> <font color=#0000FF>int</font> <b><font color=#000000>getPath</font></b><font color=#FF0000>(</font><font color=#0000FF>int</font> x<font color=#FF0000>,</font> <font color=#0000FF>int</font> y<font color=#FF0000>)</font> <font color=#000000>{</font><a name='line.876'></a>
0877:     <b><font color=#0000FF>return</font></b> path<font color=#FF0000>[</font>x<font color=#FF0000>+</font>y<font color=#FF0000>*</font>width<font color=#FF0000>]</font><font color=#FF0000>;</font><a name='line.877'></a>
0878:   <font color=#000000>}</font><a name='line.878'></a>
0879:   <a name='line.879'></a>
0880:   <b><font color=#009900>// map metrics</font></b><a name='line.880'></a>
0881:   <b><font color=#0000FF>public</font></b> <font color=#0000FF>int</font> <b><font color=#000000>getWidth</font></b><font color=#FF0000>(</font><font color=#FF0000>)</font> <font color=#000000>{</font><b><font color=#0000FF>return</font></b> width<font color=#FF0000>;</font><font color=#000000>}</font><a name='line.881'></a>
0882:   <b><font color=#0000FF>public</font></b> <font color=#0000FF>int</font> <b><font color=#000000>getHeight</font></b><font color=#FF0000>(</font><font color=#FF0000>)</font> <font color=#000000>{</font><b><font color=#0000FF>return</font></b> height<font color=#FF0000>;</font><font color=#000000>}</font><a name='line.882'></a>
0883:   <a name='line.883'></a>
0884:   <b><font color=#009900>// get tile type</font></b><a name='line.884'></a>
0885:   <b><font color=#0000FF>public</font></b> <b><font color=#0000FF>final</font></b> <font color=#0000FF>int</font> <b><font color=#000000>getTile</font></b><font color=#FF0000>(</font><font color=#0000FF>int</font> x<font color=#FF0000>,</font> <font color=#0000FF>int</font> y<font color=#FF0000>)</font> <font color=#000000>{</font><a name='line.885'></a>
0886:     <font color=#0000FF>int</font> i<font color=#FF0000>=</font>x<font color=#FF0000>+</font>width<font color=#FF0000>*</font>y<font color=#FF0000>;</font><a name='line.886'></a>
0887:     <b><font color=#0000FF>if</font></b> <font color=#FF0000>(</font><font color=#FF0000>(</font>x<font color=#FF0000>&lt;</font><font color=#9A1900>0</font><font color=#FF0000>)</font><font color=#FF0000>|</font><font color=#FF0000>|</font><font color=#FF0000>(</font>y<font color=#FF0000>&lt;</font><font color=#9A1900>0</font><font color=#FF0000>)</font><font color=#FF0000>|</font><font color=#FF0000>|</font><font color=#FF0000>(</font>x<font color=#FF0000>&gt;</font><font color=#FF0000>=</font>width<font color=#FF0000>)</font><font color=#FF0000>|</font><font color=#FF0000>|</font><font color=#FF0000>(</font>y<font color=#FF0000>&gt;</font><font color=#FF0000>=</font>height<font color=#FF0000>)</font><font color=#FF0000>)</font> <b><font color=#0000FF>return</font></b> <font color=#9A1900>0</font><font color=#FF0000>;</font> <b><font color=#009900>// off-map tiles blank</font></b><a name='line.887'></a>
0888:     <b><font color=#0000FF>return</font></b> tiles<font color=#FF0000>[</font>i<font color=#FF0000>]</font><font color=#FF0000>&amp;</font>Tile<font color=#FF0000>.</font>TF_TYPE<font color=#FF0000>;</font><a name='line.888'></a>
0889:   <font color=#000000>}</font>    <a name='line.889'></a>
0890: <a name='line.890'></a>
0891:   <b><font color=#009900>// get tile including flags</font></b><a name='line.891'></a>
0892:   <b><font color=#0000FF>protected</font></b> <b><font color=#0000FF>final</font></b> <font color=#0000FF>int</font> <b><font color=#000000>getTileFull</font></b><font color=#FF0000>(</font><font color=#0000FF>int</font> x<font color=#FF0000>,</font> <font color=#0000FF>int</font> y<font color=#FF0000>)</font> <font color=#000000>{</font><a name='line.892'></a>
0893:     <font color=#0000FF>int</font> i<font color=#FF0000>=</font>x<font color=#FF0000>+</font>width<font color=#FF0000>*</font>y<font color=#FF0000>;</font><a name='line.893'></a>
0894:     <b><font color=#0000FF>if</font></b> <font color=#FF0000>(</font><font color=#FF0000>(</font>x<font color=#FF0000>&lt;</font><font color=#9A1900>0</font><font color=#FF0000>)</font><font color=#FF0000>|</font><font color=#FF0000>|</font><font color=#FF0000>(</font>y<font color=#FF0000>&lt;</font><font color=#9A1900>0</font><font color=#FF0000>)</font><font color=#FF0000>|</font><font color=#FF0000>|</font><font color=#FF0000>(</font>x<font color=#FF0000>&gt;</font><font color=#FF0000>=</font>width<font color=#FF0000>)</font><font color=#FF0000>|</font><font color=#FF0000>|</font><font color=#FF0000>(</font>y<font color=#FF0000>&gt;</font><font color=#FF0000>=</font>height<font color=#FF0000>)</font><font color=#FF0000>)</font> <b><font color=#0000FF>return</font></b> Tile<font color=#FF0000>.</font>TF_BLOCKED<font color=#FF0000>;</font> <b><font color=#009900>//off-map tiles blocked</font></b><a name='line.894'></a>
0895:     <b><font color=#0000FF>return</font></b> tiles<font color=#FF0000>[</font>i<font color=#FF0000>]</font><font color=#FF0000>;</font><a name='line.895'></a>
0896:   <font color=#000000>}</font>    <a name='line.896'></a>
0897: <a name='line.897'></a>
0898:   <b><font color=#009900>// get Tile.TF_ flags for specified tile</font></b><a name='line.898'></a>
0899:   <b><font color=#0000FF>public</font></b> <b><font color=#0000FF>final</font></b> <font color=#0000FF>int</font> <b><font color=#000000>getTileFlags</font></b><font color=#FF0000>(</font><font color=#0000FF>int</font> x<font color=#FF0000>,</font> <font color=#0000FF>int</font> y<font color=#FF0000>)</font> <font color=#000000>{</font><a name='line.899'></a>
0900:     <font color=#0000FF>int</font> i<font color=#FF0000>=</font>x<font color=#FF0000>+</font>width<font color=#FF0000>*</font>y<font color=#FF0000>;</font><a name='line.900'></a>
0901:     <b><font color=#0000FF>if</font></b> <font color=#FF0000>(</font><font color=#FF0000>(</font>x<font color=#FF0000>&lt;</font><font color=#9A1900>0</font><font color=#FF0000>)</font><font color=#FF0000>|</font><font color=#FF0000>|</font><font color=#FF0000>(</font>y<font color=#FF0000>&lt;</font><font color=#9A1900>0</font><font color=#FF0000>)</font><font color=#FF0000>|</font><font color=#FF0000>|</font><font color=#FF0000>(</font>x<font color=#FF0000>&gt;</font><font color=#FF0000>=</font>width<font color=#FF0000>)</font><font color=#FF0000>|</font><font color=#FF0000>|</font><font color=#FF0000>(</font>y<font color=#FF0000>&gt;</font><font color=#FF0000>=</font>height<font color=#FF0000>)</font><font color=#FF0000>)</font> <b><font color=#0000FF>return</font></b> Tile<font color=#FF0000>.</font>TF_BLOCKED<font color=#FF0000>;</font> <b><font color=#009900>//off-map tiles blocked</font></b><a name='line.901'></a>
0902:     <b><font color=#0000FF>return</font></b> tiles<font color=#FF0000>[</font>i<font color=#FF0000>]</font><font color=#FF0000>&amp;</font><font color=#FF0000>(</font><font color=#FF0000>~</font>Tile<font color=#FF0000>.</font>TF_TYPE<font color=#FF0000>)</font><font color=#FF0000>;</font><a name='line.902'></a>
0903:   <font color=#000000>}</font>    <a name='line.903'></a>
0904:   <a name='line.904'></a>
0905:   <b><font color=#009900>// get linked list of objects in square</font></b><a name='line.905'></a>
0906:   <b><font color=#0000FF>public</font></b> Thing <b><font color=#000000>getObjects</font></b><font color=#FF0000>(</font><font color=#0000FF>int</font> x<font color=#FF0000>,</font> <font color=#0000FF>int</font> y<font color=#FF0000>)</font> <font color=#000000>{</font><a name='line.906'></a>
0907:     <font color=#0000FF>int</font> i<font color=#FF0000>=</font>x<font color=#FF0000>+</font>width<font color=#FF0000>*</font>y<font color=#FF0000>;</font><a name='line.907'></a>
0908:     <b><font color=#0000FF>if</font></b> <font color=#FF0000>(</font><font color=#FF0000>(</font>x<font color=#FF0000>&lt;</font><font color=#9A1900>0</font><font color=#FF0000>)</font><font color=#FF0000>|</font><font color=#FF0000>|</font><font color=#FF0000>(</font>y<font color=#FF0000>&lt;</font><font color=#9A1900>0</font><font color=#FF0000>)</font><font color=#FF0000>|</font><font color=#FF0000>|</font><font color=#FF0000>(</font>x<font color=#FF0000>&gt;</font><font color=#FF0000>=</font>width<font color=#FF0000>)</font><font color=#FF0000>|</font><font color=#FF0000>|</font><font color=#FF0000>(</font>y<font color=#FF0000>&gt;</font><font color=#FF0000>=</font>height<font color=#FF0000>)</font><font color=#FF0000>)</font> <b><font color=#0000FF>return</font></b> <b><font color=#0000FF>null</font></b><font color=#FF0000>;</font><a name='line.908'></a>
0909:     <b><font color=#0000FF>return</font></b> objects<font color=#FF0000>[</font>i<font color=#FF0000>]</font><font color=#FF0000>;</font><a name='line.909'></a>
0910:   <font color=#000000>}</font>    <a name='line.910'></a>
0911:   <a name='line.911'></a>
0912:   <b><font color=#009900>// get object of specified class</font></b><a name='line.912'></a>
0913:   <b><font color=#0000FF>public</font></b> Thing <b><font color=#000000>getObject</font></b><font color=#FF0000>(</font><font color=#0000FF>int</font> x<font color=#FF0000>,</font> <font color=#0000FF>int</font> y<font color=#FF0000>,</font> Class c<font color=#FF0000>)</font> <font color=#000000>{</font><a name='line.913'></a>
0914:     <font color=#0000FF>int</font> i<font color=#FF0000>=</font>x<font color=#FF0000>+</font>width<font color=#FF0000>*</font>y<font color=#FF0000>;</font><a name='line.914'></a>
0915:     <b><font color=#0000FF>if</font></b> <font color=#FF0000>(</font><font color=#FF0000>(</font>x<font color=#FF0000>&lt;</font><font color=#9A1900>0</font><font color=#FF0000>)</font><font color=#FF0000>|</font><font color=#FF0000>|</font><font color=#FF0000>(</font>y<font color=#FF0000>&lt;</font><font color=#9A1900>0</font><font color=#FF0000>)</font><font color=#FF0000>|</font><font color=#FF0000>|</font><font color=#FF0000>(</font>x<font color=#FF0000>&gt;</font><font color=#FF0000>=</font>width<font color=#FF0000>)</font><font color=#FF0000>|</font><font color=#FF0000>|</font><font color=#FF0000>(</font>y<font color=#FF0000>&gt;</font><font color=#FF0000>=</font>height<font color=#FF0000>)</font><font color=#FF0000>)</font> <b><font color=#0000FF>return</font></b> <b><font color=#0000FF>null</font></b><font color=#FF0000>;</font><a name='line.915'></a>
0916:     Thing t<font color=#FF0000>=</font>objects<font color=#FF0000>[</font>i<font color=#FF0000>]</font><font color=#FF0000>;</font><a name='line.916'></a>
0917:     <b><font color=#0000FF>while</font></b> <font color=#FF0000>(</font>t<font color=#FF0000>!</font><font color=#FF0000>=</font><b><font color=#0000FF>null</font></b><font color=#FF0000>)</font> <font color=#000000>{</font><a name='line.917'></a>
0918:       <b><font color=#0000FF>if</font></b> <font color=#FF0000>(</font>c<font color=#FF0000>.</font><b><font color=#000000>isInstance</font></b><font color=#FF0000>(</font>t<font color=#FF0000>)</font><font color=#FF0000>)</font> <b><font color=#0000FF>return</font></b> t<font color=#FF0000>;</font><a name='line.918'></a>
0919:       t<font color=#FF0000>=</font>t<font color=#FF0000>.</font>next<font color=#FF0000>;</font><a name='line.919'></a>
0920:     <font color=#000000>}</font><a name='line.920'></a>
0921:     <b><font color=#0000FF>return</font></b> <b><font color=#0000FF>null</font></b><font color=#FF0000>;</font>    <a name='line.921'></a>
0922:   <font color=#000000>}</font><a name='line.922'></a>
0923: <a name='line.923'></a>
0924:   <b><font color=#009900>// add something to the map, keeping all references updated</font></b><a name='line.924'></a>
0925:   <b><font color=#009900>// final for performance reasons</font></b><a name='line.925'></a>
0926:   <b><font color=#0000FF>protected</font></b> <b><font color=#0000FF>final</font></b> <font color=#0000FF>void</font> <b><font color=#000000>addObject</font></b><font color=#FF0000>(</font>Thing thing<font color=#FF0000>,</font> <font color=#0000FF>int</font> x<font color=#FF0000>,</font> <font color=#0000FF>int</font> y<font color=#FF0000>)</font> <font color=#000000>{</font><a name='line.926'></a>
0927:     <b><font color=#0000FF>if</font></b> <font color=#FF0000>(</font>thing<font color=#FF0000>=</font><font color=#FF0000>=</font><b><font color=#0000FF>null</font></b><font color=#FF0000>)</font> <b><font color=#0000FF>return</font></b><font color=#FF0000>;</font><a name='line.927'></a>
0928:     <b><font color=#0000FF>if</font></b> <font color=#FF0000>(</font><font color=#FF0000>(</font>x<font color=#FF0000>&gt;</font><font color=#FF0000>=</font>width<font color=#FF0000>)</font><font color=#FF0000>|</font><font color=#FF0000>|</font><font color=#FF0000>(</font>x<font color=#FF0000>&lt;</font><font color=#9A1900>0</font><font color=#FF0000>)</font><font color=#FF0000>)</font> <b><font color=#0000FF>return</font></b><font color=#FF0000>;</font><a name='line.928'></a>
0929:     <b><font color=#0000FF>if</font></b> <font color=#FF0000>(</font><font color=#FF0000>(</font>y<font color=#FF0000>&gt;</font><font color=#FF0000>=</font>height<font color=#FF0000>)</font><font color=#FF0000>|</font><font color=#FF0000>|</font><font color=#FF0000>(</font>y<font color=#FF0000>&lt;</font><font color=#9A1900>0</font><font color=#FF0000>)</font><font color=#FF0000>)</font> <b><font color=#0000FF>return</font></b><font color=#FF0000>;</font><a name='line.929'></a>
0930:       <a name='line.930'></a>
0931:     thing<font color=#FF0000>.</font>next<font color=#FF0000>=</font>objects<font color=#FF0000>[</font>x<font color=#FF0000>+</font>y<font color=#FF0000>*</font>width<font color=#FF0000>]</font><font color=#FF0000>;</font>  <a name='line.931'></a>
0932:     objects<font color=#FF0000>[</font>x<font color=#FF0000>+</font>y<font color=#FF0000>*</font>width<font color=#FF0000>]</font><font color=#FF0000>=</font>thing<font color=#FF0000>;</font><a name='line.932'></a>
0933:     thing<font color=#FF0000>.</font>place<font color=#FF0000>=</font><font color=#FF0000>(</font>ThingOwner<font color=#FF0000>)</font><b><font color=#0000FF>this</font></b><font color=#FF0000>;</font><a name='line.933'></a>
0934:     thing<font color=#FF0000>.</font>x<font color=#FF0000>=</font>x<font color=#FF0000>;</font><a name='line.934'></a>
0935:     thing<font color=#FF0000>.</font>y<font color=#FF0000>=</font>y<font color=#FF0000>;</font><a name='line.935'></a>
0936:   <font color=#000000>}</font><a name='line.936'></a>
0937: <a name='line.937'></a>
0938:   <b><font color=#009900>// set tile, including tile flags</font></b><a name='line.938'></a>
0939:   <b><font color=#0000FF>public</font></b> <b><font color=#0000FF>final</font></b> <font color=#0000FF>void</font> <b><font color=#000000>setTile</font></b><font color=#FF0000>(</font><font color=#0000FF>int</font> x<font color=#FF0000>,</font> <font color=#0000FF>int</font> y<font color=#FF0000>,</font> <font color=#0000FF>int</font> t<font color=#FF0000>)</font> <font color=#000000>{</font><a name='line.939'></a>
0940:     <font color=#0000FF>int</font> i<font color=#FF0000>=</font>x<font color=#FF0000>+</font>y<font color=#FF0000>*</font>width<font color=#FF0000>;</font><a name='line.940'></a>
0941:     <b><font color=#0000FF>if</font></b> <font color=#FF0000>(</font><font color=#FF0000>(</font>x<font color=#FF0000>&lt;</font><font color=#9A1900>0</font><font color=#FF0000>)</font><font color=#FF0000>|</font><font color=#FF0000>|</font><font color=#FF0000>(</font>y<font color=#FF0000>&lt;</font><font color=#9A1900>0</font><font color=#FF0000>)</font><font color=#FF0000>|</font><font color=#FF0000>|</font><font color=#FF0000>(</font>x<font color=#FF0000>&gt;</font><font color=#FF0000>=</font>width<font color=#FF0000>)</font><font color=#FF0000>|</font><font color=#FF0000>|</font><font color=#FF0000>(</font>y<font color=#FF0000>&gt;</font><font color=#FF0000>=</font>height<font color=#FF0000>)</font><font color=#FF0000>)</font> <b><font color=#0000FF>return</font></b><font color=#FF0000>;</font><a name='line.941'></a>
0942:     tiles<font color=#FF0000>[</font>i<font color=#FF0000>]</font><font color=#FF0000>=</font>t<font color=#FF0000>;</font><a name='line.942'></a>
0943:   <font color=#000000>}</font>    <a name='line.943'></a>
0944:   <a name='line.944'></a>
0945:   <b><font color=#0000FF>public</font></b> <font color=#0000FF>void</font> <b><font color=#000000>hitSquare</font></b><font color=#FF0000>(</font>Thing m<font color=#FF0000>,</font><font color=#0000FF>int</font> x<font color=#FF0000>,</font> <font color=#0000FF>int</font> y<font color=#FF0000>,</font><font color=#0000FF>boolean</font> touchfloor<font color=#FF0000>)</font> <font color=#000000>{</font><a name='line.945'></a>
0946:     <b><font color=#009900>//Area events and trap logic goes here</font></b><a name='line.946'></a>
0947:     Thing t<font color=#FF0000>=</font><b><font color=#000000>getObjects</font></b><font color=#FF0000>(</font>x<font color=#FF0000>,</font>y<font color=#FF0000>)</font><font color=#FF0000>;</font><a name='line.947'></a>
0948:     <b><font color=#0000FF>while</font></b> <font color=#FF0000>(</font>t<font color=#FF0000>!</font><font color=#FF0000>=</font><b><font color=#0000FF>null</font></b><font color=#FF0000>)</font> <font color=#000000>{</font><a name='line.948'></a>
0949:       <b><font color=#0000FF>if</font></b> <font color=#FF0000>(</font>t <b><font color=#0000FF>instanceof</font></b> Special<font color=#FF0000>)</font> <font color=#000000>{</font><a name='line.949'></a>
0950:         <font color=#FF0000>(</font><font color=#FF0000>(</font>Special<font color=#FF0000>)</font>t<font color=#FF0000>)</font><font color=#FF0000>.</font><b><font color=#000000>enter</font></b><font color=#FF0000>(</font>m<font color=#FF0000>,</font>touchfloor<font color=#FF0000>)</font><font color=#FF0000>;</font>  <a name='line.950'></a>
0951:       <font color=#000000>}</font>  <a name='line.951'></a>
0952:       t<font color=#FF0000>=</font>t<font color=#FF0000>.</font>next<font color=#FF0000>;</font><a name='line.952'></a>
0953:     <font color=#000000>}</font><a name='line.953'></a>
0954:   <font color=#000000>}</font><a name='line.954'></a>
0955:   <a name='line.955'></a>
0956:   <b><font color=#009900>// gets a mobile from given square</font></b><a name='line.956'></a>
0957:   <b><font color=#009900>// returns Mobile or null if none available  </font></b><a name='line.957'></a>
0958:   <b><font color=#0000FF>public</font></b> Mobile <b><font color=#000000>getMobile</font></b><font color=#FF0000>(</font><font color=#0000FF>int</font> x<font color=#FF0000>,</font> <font color=#0000FF>int</font> y<font color=#FF0000>)</font> <font color=#000000>{</font><a name='line.958'></a>
0959:     Thing tracker <font color=#FF0000>=</font> <b><font color=#000000>getObjects</font></b><font color=#FF0000>(</font>x<font color=#FF0000>,</font>y<font color=#FF0000>)</font><font color=#FF0000>;</font><a name='line.959'></a>
0960:     <b><font color=#0000FF>while</font></b> <font color=#FF0000>(</font>tracker<font color=#FF0000>!</font><font color=#FF0000>=</font><b><font color=#0000FF>null</font></b><font color=#FF0000>)</font> <font color=#000000>{</font><a name='line.960'></a>
0961:       <b><font color=#0000FF>if</font></b> <font color=#FF0000>(</font>tracker<font color=#FF0000>.</font><b><font color=#000000>isMobile</font></b><font color=#FF0000>(</font><font color=#FF0000>)</font><font color=#FF0000>)</font> <b><font color=#0000FF>return</font></b> <font color=#FF0000>(</font>Mobile<font color=#FF0000>)</font>tracker<font color=#FF0000>;</font><a name='line.961'></a>
0962:       tracker<font color=#FF0000>=</font>tracker<font color=#FF0000>.</font>next<font color=#FF0000>;</font>  <a name='line.962'></a>
0963:     <font color=#000000>}</font><a name='line.963'></a>
0964:     <b><font color=#0000FF>return</font></b> <b><font color=#0000FF>null</font></b><font color=#FF0000>;</font>  <a name='line.964'></a>
0965:   <font color=#000000>}</font><a name='line.965'></a>
0966: <a name='line.966'></a>
0967:   <b><font color=#009900>// functions to detect/return obvious nearby mobiles</font></b><a name='line.967'></a>
0968:   <b><font color=#0000FF>public</font></b> <font color=#0000FF>int</font> <b><font color=#000000>countNearbyMobiles</font></b><font color=#FF0000>(</font><font color=#0000FF>int</font> x<font color=#FF0000>,</font> <font color=#0000FF>int</font> y<font color=#FF0000>,</font> <font color=#0000FF>int</font> r<font color=#FF0000>)</font> <font color=#000000>{</font><a name='line.968'></a>
0969:     <font color=#0000FF>int</font> count<font color=#FF0000>=</font><font color=#9A1900>0</font><font color=#FF0000>;</font><a name='line.969'></a>
0970:     <b><font color=#0000FF>for</font></b> <font color=#FF0000>(</font><font color=#0000FF>int</font> lx<font color=#FF0000>=</font>x<font color=#FF0000>-</font>r<font color=#FF0000>;</font> lx<font color=#FF0000>&lt;</font><font color=#FF0000>=</font>x<font color=#FF0000>+</font>r<font color=#FF0000>;</font> lx<font color=#FF0000>+</font><font color=#FF0000>+</font><font color=#FF0000>)</font> <b><font color=#0000FF>for</font></b> <font color=#FF0000>(</font><font color=#0000FF>int</font> ly<font color=#FF0000>=</font>y<font color=#FF0000>-</font>r<font color=#FF0000>;</font> ly<font color=#FF0000>&lt;</font><font color=#FF0000>=</font>y<font color=#FF0000>+</font>r<font color=#FF0000>;</font> ly<font color=#FF0000>+</font><font color=#FF0000>+</font><font color=#FF0000>)</font> <font color=#000000>{</font><a name='line.970'></a>
0971:       <b><font color=#0000FF>if</font></b> <font color=#FF0000>(</font><b><font color=#000000>getMobile</font></b><font color=#FF0000>(</font>lx<font color=#FF0000>,</font>ly<font color=#FF0000>)</font><font color=#FF0000>!</font><font color=#FF0000>=</font><b><font color=#0000FF>null</font></b><font color=#FF0000>)</font> count<font color=#FF0000>+</font><font color=#FF0000>+</font><font color=#FF0000>;</font><a name='line.971'></a>
0972:     <font color=#000000>}</font><a name='line.972'></a>
0973:     <b><font color=#0000FF>return</font></b> count<font color=#FF0000>;</font><a name='line.973'></a>
0974:   <font color=#000000>}</font><a name='line.974'></a>
0975:   <a name='line.975'></a>
0976:   <b><font color=#0000FF>public</font></b> Mobile <b><font color=#000000>getNearbyMobile</font></b><font color=#FF0000>(</font><font color=#0000FF>int</font> x<font color=#FF0000>,</font> <font color=#0000FF>int</font> y<font color=#FF0000>,</font> <font color=#0000FF>int</font> r<font color=#FF0000>)</font> <font color=#000000>{</font><a name='line.976'></a>
0977:     <b><font color=#0000FF>for</font></b> <font color=#FF0000>(</font><font color=#0000FF>int</font> lx<font color=#FF0000>=</font>x<font color=#FF0000>-</font>r<font color=#FF0000>;</font> lx<font color=#FF0000>&lt;</font><font color=#FF0000>=</font>x<font color=#FF0000>+</font>r<font color=#FF0000>;</font> lx<font color=#FF0000>+</font><font color=#FF0000>+</font><font color=#FF0000>)</font> <b><font color=#0000FF>for</font></b> <font color=#FF0000>(</font><font color=#0000FF>int</font> ly<font color=#FF0000>=</font>y<font color=#FF0000>-</font>r<font color=#FF0000>;</font> ly<font color=#FF0000>&lt;</font><font color=#FF0000>=</font>y<font color=#FF0000>+</font>r<font color=#FF0000>;</font> ly<font color=#FF0000>+</font><font color=#FF0000>+</font><font color=#FF0000>)</font> <font color=#000000>{</font><a name='line.977'></a>
0978:       <b><font color=#0000FF>if</font></b> <font color=#FF0000>(</font><font color=#FF0000>(</font>lx<font color=#FF0000>=</font><font color=#FF0000>=</font>x<font color=#FF0000>)</font><font color=#FF0000>&amp;</font><font color=#FF0000>&amp;</font><font color=#FF0000>(</font>ly<font color=#FF0000>=</font><font color=#FF0000>=</font>y<font color=#FF0000>)</font><font color=#FF0000>)</font> <b><font color=#0000FF>continue</font></b><font color=#FF0000>;</font><a name='line.978'></a>
0979:       Mobile m<font color=#FF0000>=</font><b><font color=#000000>getMobile</font></b><font color=#FF0000>(</font>lx<font color=#FF0000>,</font>ly<font color=#FF0000>)</font><font color=#FF0000>;</font><a name='line.979'></a>
0980:       <b><font color=#0000FF>if</font></b> <font color=#FF0000>(</font>m<font color=#FF0000>!</font><font color=#FF0000>=</font><b><font color=#0000FF>null</font></b><font color=#FF0000>)</font> <b><font color=#0000FF>return</font></b> m<font color=#FF0000>;</font><a name='line.980'></a>
0981:     <font color=#000000>}</font><a name='line.981'></a>
0982:     <b><font color=#0000FF>return</font></b> <b><font color=#000000>getMobile</font></b><font color=#FF0000>(</font>x<font color=#FF0000>,</font>y<font color=#FF0000>)</font><font color=#FF0000>;</font><a name='line.982'></a>
0983:   <font color=#000000>}</font><a name='line.983'></a>
0984:   <a name='line.984'></a>
0985:   <b><font color=#009900>// do damage in circular area (size r2 = radius squared)</font></b><a name='line.985'></a>
0986:   <b><font color=#0000FF>public</font></b> <font color=#0000FF>void</font> <b><font color=#000000>areaDamage</font></b><font color=#FF0000>(</font><font color=#0000FF>int</font> x<font color=#FF0000>,</font><font color=#0000FF>int</font> y<font color=#FF0000>,</font> <font color=#0000FF>int</font> r2<font color=#FF0000>,</font><font color=#0000FF>int</font> dam<font color=#FF0000>,</font> <font color=#0000FF>int</font> damtype<font color=#FF0000>)</font> <font color=#000000>{</font><a name='line.986'></a>
0987:     <font color=#0000FF>int</font> d<font color=#FF0000>=</font><font color=#9A1900>0</font><font color=#FF0000>;</font><a name='line.987'></a>
0988:     <b><font color=#0000FF>for</font></b> <font color=#FF0000>(</font>d<font color=#FF0000>=</font><font color=#9A1900>0</font><font color=#FF0000>;</font> d<font color=#FF0000>*</font>d<font color=#FF0000>&lt;</font><font color=#FF0000>=</font>r2<font color=#FF0000>;</font>d<font color=#FF0000>+</font><font color=#FF0000>+</font><font color=#FF0000>)</font><font color=#FF0000>;</font><a name='line.988'></a>
0989:     d<font color=#FF0000>=</font>d<font color=#FF0000>-</font><font color=#9A1900>1</font><font color=#FF0000>;</font><a name='line.989'></a>
0990:     Thing<font color=#FF0000>[</font><font color=#FF0000>]</font> things<font color=#FF0000>=</font><b><font color=#000000>getThings</font></b><font color=#FF0000>(</font>x<font color=#FF0000>-</font>d<font color=#FF0000>,</font>y<font color=#FF0000>-</font>d<font color=#FF0000>,</font>x<font color=#FF0000>+</font>d<font color=#FF0000>,</font>y<font color=#FF0000>+</font>d<font color=#FF0000>)</font><font color=#FF0000>;</font><a name='line.990'></a>
0991:     <b><font color=#0000FF>for</font></b> <font color=#FF0000>(</font><font color=#0000FF>int</font> i<font color=#FF0000>=</font><font color=#9A1900>0</font><font color=#FF0000>;</font> i<font color=#FF0000>&lt;</font>things<font color=#FF0000>.</font>length<font color=#FF0000>;</font> i<font color=#FF0000>+</font><font color=#FF0000>+</font><font color=#FF0000>)</font> <font color=#000000>{</font><a name='line.991'></a>
0992:       Thing t<font color=#FF0000>=</font>things<font color=#FF0000>[</font>i<font color=#FF0000>]</font><font color=#FF0000>;</font><a name='line.992'></a>
0993:       <b><font color=#0000FF>if</font></b> <font color=#FF0000>(</font><font color=#FF0000>(</font><font color=#FF0000>(</font>t<font color=#FF0000>.</font>x<font color=#FF0000>-</font>x<font color=#FF0000>)</font><font color=#FF0000>*</font><font color=#FF0000>(</font>t<font color=#FF0000>.</font>x<font color=#FF0000>-</font>x<font color=#FF0000>)</font><font color=#FF0000>+</font><font color=#FF0000>(</font>t<font color=#FF0000>.</font>y<font color=#FF0000>-</font>y<font color=#FF0000>)</font><font color=#FF0000>*</font><font color=#FF0000>(</font>t<font color=#FF0000>.</font>y<font color=#FF0000>-</font>y<font color=#FF0000>)</font><font color=#FF0000>)</font><font color=#FF0000>&lt;</font><font color=#FF0000>=</font>r2<font color=#FF0000>)</font> <font color=#000000>{</font><a name='line.993'></a>
0994:         t<font color=#FF0000>.</font><b><font color=#000000>damageAll</font></b><font color=#FF0000>(</font>RPG<font color=#FF0000>.</font><b><font color=#000000>a</font></b><font color=#FF0000>(</font>dam<font color=#FF0000>)</font><font color=#FF0000>,</font>damtype<font color=#FF0000>)</font><font color=#FF0000>;</font><a name='line.994'></a>
0995:       <font color=#000000>}</font><a name='line.995'></a>
0996:     <font color=#000000>}</font><a name='line.996'></a>
0997:   <font color=#000000>}</font><a name='line.997'></a>
0998:   <a name='line.998'></a>
0999:   <b><font color=#009900>// notify mobiles in an area</font></b><a name='line.999'></a>
1000:   <b><font color=#0000FF>public</font></b> <font color=#0000FF>void</font> <b><font color=#000000>areaNotify</font></b><font color=#FF0000>(</font><b><font color=#0000FF>final</font></b> <font color=#0000FF>int</font> x<font color=#FF0000>,</font> <b><font color=#0000FF>final</font></b> <font color=#0000FF>int</font> y<font color=#FF0000>,</font> <b><font color=#0000FF>final</font></b> <font color=#0000FF>int</font> r<font color=#FF0000>,</font> <font color=#0000FF>int</font> eventtype<font color=#FF0000>,</font> <font color=#0000FF>int</font> ext<font color=#FF0000>,</font> Object o<font color=#FF0000>)</font> <font color=#000000>{</font><a name='line.1000'></a>
1001:     <b><font color=#0000FF>for</font></b> <font color=#FF0000>(</font><font color=#0000FF>int</font> px<font color=#FF0000>=</font>x<font color=#FF0000>-</font>r<font color=#FF0000>;</font> px<font color=#FF0000>&lt;</font><font color=#FF0000>=</font>x<font color=#FF0000>+</font>r<font color=#FF0000>;</font> px<font color=#FF0000>+</font><font color=#FF0000>+</font><font color=#FF0000>)</font> <b><font color=#0000FF>for</font></b> <font color=#FF0000>(</font><font color=#0000FF>int</font> py<font color=#FF0000>=</font>y<font color=#FF0000>-</font>r<font color=#FF0000>;</font> py<font color=#FF0000>&lt;</font><font color=#FF0000>=</font>y<font color=#FF0000>+</font>r<font color=#FF0000>;</font> py<font color=#FF0000>+</font><font color=#FF0000>+</font><font color=#FF0000>)</font> <font color=#000000>{</font><a name='line.1001'></a>
1002:       Mobile m<font color=#FF0000>=</font><b><font color=#000000>getMobile</font></b><font color=#FF0000>(</font>px<font color=#FF0000>,</font>py<font color=#FF0000>)</font><font color=#FF0000>;</font><a name='line.1002'></a>
1003:       <b><font color=#0000FF>if</font></b> <font color=#FF0000>(</font>m<font color=#FF0000>!</font><font color=#FF0000>=</font><b><font color=#0000FF>null</font></b><font color=#FF0000>)</font> m<font color=#FF0000>.</font><b><font color=#000000>notify</font></b><font color=#FF0000>(</font>eventtype<font color=#FF0000>,</font>ext<font color=#FF0000>,</font>o<font color=#FF0000>)</font><font color=#FF0000>;</font>  <a name='line.1003'></a>
1004:     <font color=#000000>}</font>    <a name='line.1004'></a>
1005:   <font color=#000000>}</font><a name='line.1005'></a>
1006:   <a name='line.1006'></a>
1007:   <b><font color=#009900>//Sorts objects in square into correct Z order</font></b><a name='line.1007'></a>
1008:   <b><font color=#009900>//returns head item (lowest Z value)</font></b><a name='line.1008'></a>
1009:   <b><font color=#0000FF>public</font></b> Thing <b><font color=#000000>sortZ</font></b><font color=#FF0000>(</font><font color=#0000FF>int</font> x<font color=#FF0000>,</font> <font color=#0000FF>int</font> y<font color=#FF0000>)</font> <font color=#000000>{</font><a name='line.1009'></a>
1010:     Thing head<font color=#FF0000>=</font><b><font color=#000000>getObjects</font></b><font color=#FF0000>(</font>x<font color=#FF0000>,</font>y<font color=#FF0000>)</font><font color=#FF0000>;</font><a name='line.1010'></a>
1011:     <b><font color=#0000FF>if</font></b> <font color=#FF0000>(</font>head<font color=#FF0000>=</font><font color=#FF0000>=</font><b><font color=#0000FF>null</font></b><font color=#FF0000>)</font> <b><font color=#0000FF>return</font></b> <b><font color=#0000FF>null</font></b><font color=#FF0000>;</font><a name='line.1011'></a>
1012:     <b><font color=#0000FF>return</font></b> objects<font color=#FF0000>[</font>x<font color=#FF0000>+</font>y<font color=#FF0000>*</font>width<font color=#FF0000>]</font><font color=#FF0000>=</font><b><font color=#000000>sortZGetFirst</font></b><font color=#FF0000>(</font>head<font color=#FF0000>)</font><font color=#FF0000>;</font><a name='line.1012'></a>
1013:   <font color=#000000>}</font><a name='line.1013'></a>
1014:   <b><font color=#009900>//utility function for sortZ</font></b><a name='line.1014'></a>
1015:   <b><font color=#0000FF>private</font></b> Thing <b><font color=#000000>sortZGetFirst</font></b><font color=#FF0000>(</font>Thing top<font color=#FF0000>)</font> <font color=#000000>{</font><a name='line.1015'></a>
1016:     <b><font color=#0000FF>if</font></b> <font color=#FF0000>(</font>top<font color=#FF0000>.</font>next<font color=#FF0000>=</font><font color=#FF0000>=</font><b><font color=#0000FF>null</font></b><font color=#FF0000>)</font> <b><font color=#0000FF>return</font></b> top<font color=#FF0000>;</font><a name='line.1016'></a>
1017:     top<font color=#FF0000>.</font>next<font color=#FF0000>=</font><b><font color=#000000>sortZGetFirst</font></b><font color=#FF0000>(</font>top<font color=#FF0000>.</font>next<font color=#FF0000>)</font><font color=#FF0000>;</font><a name='line.1017'></a>
1018:     <a name='line.1018'></a>
1019:     <b><font color=#0000FF>if</font></b> <font color=#FF0000>(</font>top<font color=#FF0000>.</font><b><font color=#000000>getZ</font></b><font color=#FF0000>(</font><font color=#FF0000>)</font><font color=#FF0000>&lt;</font><font color=#FF0000>=</font>top<font color=#FF0000>.</font>next<font color=#FF0000>.</font><b><font color=#000000>getZ</font></b><font color=#FF0000>(</font><font color=#FF0000>)</font><font color=#FF0000>)</font> <font color=#000000>{</font><a name='line.1019'></a>
1020:       <b><font color=#0000FF>return</font></b> top<font color=#FF0000>;</font>  <a name='line.1020'></a>
1021:     <font color=#000000>}</font> <b><font color=#0000FF>else</font></b> <font color=#000000>{</font><a name='line.1021'></a>
1022:       Thing t<font color=#FF0000>=</font>top<font color=#FF0000>.</font>next<font color=#FF0000>;</font><a name='line.1022'></a>
1023:       top<font color=#FF0000>.</font>next<font color=#FF0000>=</font>t<font color=#FF0000>.</font>next<font color=#FF0000>;</font><a name='line.1023'></a>
1024:       t<font color=#FF0000>.</font>next<font color=#FF0000>=</font><b><font color=#000000>sortZGetFirst</font></b><font color=#FF0000>(</font>top<font color=#FF0000>)</font><font color=#FF0000>;</font><a name='line.1024'></a>
1025:       <b><font color=#0000FF>return</font></b> t<font color=#FF0000>;</font>  <a name='line.1025'></a>
1026:     <font color=#000000>}</font><a name='line.1026'></a>
1027:   <font color=#000000>}</font><a name='line.1027'></a>
1028:   <a name='line.1028'></a>
1029:   <b><font color=#009900>// Functions to return array of things in area</font></b><a name='line.1029'></a>
1030:   <a name='line.1030'></a>
1031:   <b><font color=#009900>// return all things on map </font></b><a name='line.1031'></a>
1032:   <b><font color=#0000FF>public</font></b> Thing<font color=#FF0000>[</font><font color=#FF0000>]</font> <b><font color=#000000>getThings</font></b><font color=#FF0000>(</font><font color=#FF0000>)</font> <font color=#000000>{</font><a name='line.1032'></a>
1033:     <b><font color=#0000FF>return</font></b> <b><font color=#000000>getThings</font></b><font color=#FF0000>(</font><font color=#9A1900>0</font><font color=#FF0000>,</font><font color=#9A1900>0</font><font color=#FF0000>,</font>width<font color=#FF0000>-</font><font color=#9A1900>1</font><font color=#FF0000>,</font>height<font color=#FF0000>-</font><font color=#9A1900>1</font><font color=#FF0000>)</font><font color=#FF0000>;</font>  <a name='line.1033'></a>
1034:   <font color=#000000>}</font><a name='line.1034'></a>
1035: <a name='line.1035'></a>
1036:   <b><font color=#009900>// return all things in square</font></b><a name='line.1036'></a>
1037:   <b><font color=#0000FF>public</font></b> Thing<font color=#FF0000>[</font><font color=#FF0000>]</font> <b><font color=#000000>getThings</font></b><font color=#FF0000>(</font><font color=#0000FF>int</font> x<font color=#FF0000>,</font> <font color=#0000FF>int</font> y<font color=#FF0000>)</font> <font color=#000000>{</font><a name='line.1037'></a>
1038:     <b><font color=#0000FF>return</font></b> <b><font color=#000000>getThings</font></b><font color=#FF0000>(</font>x<font color=#FF0000>,</font>y<font color=#FF0000>,</font>x<font color=#FF0000>,</font>y<font color=#FF0000>)</font><font color=#FF0000>;</font>  <a name='line.1038'></a>
1039:   <font color=#000000>}</font><a name='line.1039'></a>
1040:   <a name='line.1040'></a>
1041:   <b><font color=#009900>// return all objects of given class in rectangular area</font></b><a name='line.1041'></a>
1042:   <b><font color=#0000FF>public</font></b> Thing<font color=#FF0000>[</font><font color=#FF0000>]</font> <b><font color=#000000>getObjects</font></b><font color=#FF0000>(</font><font color=#0000FF>int</font> x1<font color=#FF0000>,</font> <font color=#0000FF>int</font> y1<font color=#FF0000>,</font> <font color=#0000FF>int</font> x2<font color=#FF0000>,</font> <font color=#0000FF>int</font> y2<font color=#FF0000>,</font> Class c<font color=#FF0000>)</font> <font color=#000000>{</font><a name='line.1042'></a>
1043:     <font color=#0000FF>int</font> count<font color=#FF0000>=</font><font color=#9A1900>0</font><font color=#FF0000>;</font><a name='line.1043'></a>
1044:     <b><font color=#0000FF>for</font></b> <font color=#FF0000>(</font><font color=#0000FF>int</font> x<font color=#FF0000>=</font>x1<font color=#FF0000>;</font> x<font color=#FF0000>&lt;</font><font color=#FF0000>=</font>x2<font color=#FF0000>;</font> x<font color=#FF0000>+</font><font color=#FF0000>+</font><font color=#FF0000>)</font> <b><font color=#0000FF>for</font></b> <font color=#FF0000>(</font><font color=#0000FF>int</font> y<font color=#FF0000>=</font>y1<font color=#FF0000>;</font> y<font color=#FF0000>&lt;</font><font color=#FF0000>=</font>y2<font color=#FF0000>;</font> y<font color=#FF0000>+</font><font color=#FF0000>+</font><font color=#FF0000>)</font> <font color=#000000>{</font><a name='line.1044'></a>
1045:       Thing tracker<font color=#FF0000>=</font><b><font color=#000000>getObjects</font></b><font color=#FF0000>(</font>x<font color=#FF0000>,</font>y<font color=#FF0000>)</font><font color=#FF0000>;</font><a name='line.1045'></a>
1046:       <b><font color=#0000FF>while</font></b> <font color=#FF0000>(</font>tracker<font color=#FF0000>!</font><font color=#FF0000>=</font><b><font color=#0000FF>null</font></b><font color=#FF0000>)</font> <font color=#000000>{</font><a name='line.1046'></a>
1047:         <b><font color=#0000FF>if</font></b> <font color=#FF0000>(</font>c<font color=#FF0000>.</font><b><font color=#000000>isInstance</font></b><font color=#FF0000>(</font>tracker<font color=#FF0000>)</font><font color=#FF0000>)</font> count<font color=#FF0000>+</font><font color=#FF0000>+</font><font color=#FF0000>;</font><a name='line.1047'></a>
1048:         tracker<font color=#FF0000>=</font>tracker<font color=#FF0000>.</font>next<font color=#FF0000>;</font><a name='line.1048'></a>
1049:       <font color=#000000>}</font><a name='line.1049'></a>
1050:     <font color=#000000>}</font><a name='line.1050'></a>
1051:     <a name='line.1051'></a>
1052:     <b><font color=#0000FF>if</font></b> <font color=#FF0000>(</font>count<font color=#FF0000>=</font><font color=#FF0000>=</font><font color=#9A1900>0</font><font color=#FF0000>)</font> <b><font color=#0000FF>return</font></b> <b><font color=#0000FF>new</font></b> Thing<font color=#FF0000>[</font><font color=#9A1900>0</font><font color=#FF0000>]</font><font color=#FF0000>;</font><a name='line.1052'></a>
1053:     Thing<font color=#FF0000>[</font><font color=#FF0000>]</font> things <font color=#FF0000>=</font> <b><font color=#0000FF>new</font></b> Thing<font color=#FF0000>[</font>count<font color=#FF0000>]</font><font color=#FF0000>;</font><a name='line.1053'></a>
1054:     <a name='line.1054'></a>
1055:     count<font color=#FF0000>=</font><font color=#9A1900>0</font><font color=#FF0000>;</font><a name='line.1055'></a>
1056:     <b><font color=#0000FF>for</font></b> <font color=#FF0000>(</font><font color=#0000FF>int</font> x<font color=#FF0000>=</font>x1<font color=#FF0000>;</font> x<font color=#FF0000>&lt;</font><font color=#FF0000>=</font>x2<font color=#FF0000>;</font> x<font color=#FF0000>+</font><font color=#FF0000>+</font><font color=#FF0000>)</font> <b><font color=#0000FF>for</font></b> <font color=#FF0000>(</font><font color=#0000FF>int</font> y<font color=#FF0000>=</font>y1<font color=#FF0000>;</font> y<font color=#FF0000>&lt;</font><font color=#FF0000>=</font>y2<font color=#FF0000>;</font> y<font color=#FF0000>+</font><font color=#FF0000>+</font><font color=#FF0000>)</font> <font color=#000000>{</font><a name='line.1056'></a>
1057:       Thing tracker<font color=#FF0000>=</font><b><font color=#000000>getObjects</font></b><font color=#FF0000>(</font>x<font color=#FF0000>,</font>y<font color=#FF0000>)</font><font color=#FF0000>;</font><a name='line.1057'></a>
1058:       <b><font color=#0000FF>while</font></b> <font color=#FF0000>(</font>tracker<font color=#FF0000>!</font><font color=#FF0000>=</font><b><font color=#0000FF>null</font></b><font color=#FF0000>)</font> <font color=#000000>{</font><a name='line.1058'></a>
1059:         <b><font color=#0000FF>if</font></b> <font color=#FF0000>(</font>c<font color=#FF0000>.</font><b><font color=#000000>isInstance</font></b><font color=#FF0000>(</font>tracker<font color=#FF0000>)</font><font color=#FF0000>)</font> <font color=#000000>{</font><a name='line.1059'></a>
1060:           things<font color=#FF0000>[</font>count<font color=#FF0000>]</font><font color=#FF0000>=</font>tracker<font color=#FF0000>;</font><a name='line.1060'></a>
1061:           count<font color=#FF0000>+</font><font color=#FF0000>+</font><font color=#FF0000>;</font><a name='line.1061'></a>
1062:         <font color=#000000>}</font><a name='line.1062'></a>
1063:         tracker<font color=#FF0000>=</font>tracker<font color=#FF0000>.</font>next<font color=#FF0000>;</font><a name='line.1063'></a>
1064:       <font color=#000000>}</font><a name='line.1064'></a>
1065:     <font color=#000000>}</font><a name='line.1065'></a>
1066:     <b><font color=#0000FF>return</font></b> things<font color=#FF0000>;</font><a name='line.1066'></a>
1067:   <font color=#000000>}</font><a name='line.1067'></a>
1068:   <a name='line.1068'></a>
1069:   <b><font color=#009900>// return all things in rectangular area</font></b><a name='line.1069'></a>
1070:   <b><font color=#0000FF>public</font></b> Thing<font color=#FF0000>[</font><font color=#FF0000>]</font> <b><font color=#000000>getThings</font></b><font color=#FF0000>(</font><font color=#0000FF>int</font> x1<font color=#FF0000>,</font> <font color=#0000FF>int</font> y1<font color=#FF0000>,</font> <font color=#0000FF>int</font> x2<font color=#FF0000>,</font> <font color=#0000FF>int</font> y2<font color=#FF0000>)</font> <font color=#000000>{</font><a name='line.1070'></a>
1071:     <font color=#0000FF>int</font> count<font color=#FF0000>=</font><font color=#9A1900>0</font><font color=#FF0000>;</font><a name='line.1071'></a>
1072:     <b><font color=#0000FF>for</font></b> <font color=#FF0000>(</font><font color=#0000FF>int</font> x<font color=#FF0000>=</font>x1<font color=#FF0000>;</font> x<font color=#FF0000>&lt;</font><font color=#FF0000>=</font>x2<font color=#FF0000>;</font> x<font color=#FF0000>+</font><font color=#FF0000>+</font><font color=#FF0000>)</font> <b><font color=#0000FF>for</font></b> <font color=#FF0000>(</font><font color=#0000FF>int</font> y<font color=#FF0000>=</font>y1<font color=#FF0000>;</font> y<font color=#FF0000>&lt;</font><font color=#FF0000>=</font>y2<font color=#FF0000>;</font> y<font color=#FF0000>+</font><font color=#FF0000>+</font><font color=#FF0000>)</font> <font color=#000000>{</font><a name='line.1072'></a>
1073:       Thing tracker<font color=#FF0000>=</font><b><font color=#000000>getObjects</font></b><font color=#FF0000>(</font>x<font color=#FF0000>,</font>y<font color=#FF0000>)</font><font color=#FF0000>;</font><a name='line.1073'></a>
1074:       <b><font color=#0000FF>while</font></b> <font color=#FF0000>(</font>tracker<font color=#FF0000>!</font><font color=#FF0000>=</font><b><font color=#0000FF>null</font></b><font color=#FF0000>)</font> <font color=#000000>{</font><a name='line.1074'></a>
1075:         count<font color=#FF0000>+</font><font color=#FF0000>+</font><font color=#FF0000>;</font><a name='line.1075'></a>
1076:         tracker<font color=#FF0000>=</font>tracker<font color=#FF0000>.</font>next<font color=#FF0000>;</font><a name='line.1076'></a>
1077:       <font color=#000000>}</font><a name='line.1077'></a>
1078:     <font color=#000000>}</font><a name='line.1078'></a>
1079:     <a name='line.1079'></a>
1080:     <b><font color=#0000FF>if</font></b> <font color=#FF0000>(</font>count<font color=#FF0000>=</font><font color=#FF0000>=</font><font color=#9A1900>0</font><font color=#FF0000>)</font> <b><font color=#0000FF>return</font></b> <b><font color=#0000FF>new</font></b> Thing<font color=#FF0000>[</font><font color=#9A1900>0</font><font color=#FF0000>]</font><font color=#FF0000>;</font><a name='line.1080'></a>
1081:     Thing<font color=#FF0000>[</font><font color=#FF0000>]</font> things <font color=#FF0000>=</font> <b><font color=#0000FF>new</font></b> Thing<font color=#FF0000>[</font>count<font color=#FF0000>]</font><font color=#FF0000>;</font><a name='line.1081'></a>
1082:     <a name='line.1082'></a>
1083:     count<font color=#FF0000>=</font><font color=#9A1900>0</font><font color=#FF0000>;</font><a name='line.1083'></a>
1084:     <b><font color=#0000FF>for</font></b> <font color=#FF0000>(</font><font color=#0000FF>int</font> x<font color=#FF0000>=</font>x1<font color=#FF0000>;</font> x<font color=#FF0000>&lt;</font><font color=#FF0000>=</font>x2<font color=#FF0000>;</font> x<font color=#FF0000>+</font><font color=#FF0000>+</font><font color=#FF0000>)</font> <b><font color=#0000FF>for</font></b> <font color=#FF0000>(</font><font color=#0000FF>int</font> y<font color=#FF0000>=</font>y1<font color=#FF0000>;</font> y<font color=#FF0000>&lt;</font><font color=#FF0000>=</font>y2<font color=#FF0000>;</font> y<font color=#FF0000>+</font><font color=#FF0000>+</font><font color=#FF0000>)</font> <font color=#000000>{</font><a name='line.1084'></a>
1085:       Thing tracker<font color=#FF0000>=</font><b><font color=#000000>getObjects</font></b><font color=#FF0000>(</font>x<font color=#FF0000>,</font>y<font color=#FF0000>)</font><font color=#FF0000>;</font><a name='line.1085'></a>
1086:       <b><font color=#0000FF>while</font></b> <font color=#FF0000>(</font>tracker<font color=#FF0000>!</font><font color=#FF0000>=</font><b><font color=#0000FF>null</font></b><font color=#FF0000>)</font> <font color=#000000>{</font><a name='line.1086'></a>
1087:         things<font color=#FF0000>[</font>count<font color=#FF0000>]</font><font color=#FF0000>=</font>tracker<font color=#FF0000>;</font><a name='line.1087'></a>
1088:         count<font color=#FF0000>+</font><font color=#FF0000>+</font><font color=#FF0000>;</font><a name='line.1088'></a>
1089:         tracker<font color=#FF0000>=</font>tracker<font color=#FF0000>.</font>next<font color=#FF0000>;</font><a name='line.1089'></a>
1090:       <font color=#000000>}</font><a name='line.1090'></a>
1091:     <font color=#000000>}</font><a name='line.1091'></a>
1092:     <b><font color=#0000FF>return</font></b> things<font color=#FF0000>;</font><a name='line.1092'></a>
1093:   <font color=#000000>}</font><a name='line.1093'></a>
1094:   <a name='line.1094'></a>
1095:   <b><font color=#009900>// execute map action for &lt;time&gt; ticks</font></b><a name='line.1095'></a>
1096:   <b><font color=#009900>// this calls all monster, trap and item actions</font></b><a name='line.1096'></a>
1097:   <b><font color=#0000FF>public</font></b> <font color=#0000FF>void</font> <b><font color=#000000>action</font></b><font color=#FF0000>(</font><font color=#0000FF>int</font> time<font color=#FF0000>)</font> <font color=#000000>{</font><a name='line.1097'></a>
1098:     Thing<font color=#FF0000>[</font><font color=#FF0000>]</font> things <font color=#FF0000>=</font> <b><font color=#000000>getThings</font></b><font color=#FF0000>(</font><font color=#FF0000>)</font><font color=#FF0000>;</font><a name='line.1098'></a>
1099:     <a name='line.1099'></a>
1100:     <b><font color=#0000FF>for</font></b> <font color=#FF0000>(</font><font color=#0000FF>int</font> i<font color=#FF0000>=</font><font color=#9A1900>0</font><font color=#FF0000>;</font> i<font color=#FF0000>&lt;</font>things<font color=#FF0000>.</font>length<font color=#FF0000>;</font> i<font color=#FF0000>+</font><font color=#FF0000>+</font><font color=#FF0000>)</font> <font color=#000000>{</font><a name='line.1100'></a>
1101:       Thing t<font color=#FF0000>=</font>things<font color=#FF0000>[</font>i<font color=#FF0000>]</font><font color=#FF0000>;</font><a name='line.1101'></a>
1102:       <b><font color=#009900>// note: place could theoretically change (e.g. dead)</font></b><a name='line.1102'></a>
1103:       <b><font color=#0000FF>if</font></b> <font color=#FF0000>(</font><font color=#FF0000>(</font>t <b><font color=#0000FF>instanceof</font></b> Active<font color=#FF0000>)</font><font color=#FF0000>&amp;</font><font color=#FF0000>&amp;</font><font color=#FF0000>(</font>t<font color=#FF0000>.</font>place<font color=#FF0000>=</font><font color=#FF0000>=</font><b><font color=#0000FF>this</font></b><font color=#FF0000>)</font><font color=#FF0000>)</font> <font color=#000000>{</font><a name='line.1103'></a>
1104:         Active m<font color=#FF0000>=</font><font color=#FF0000>(</font>Active<font color=#FF0000>)</font> t<font color=#FF0000>;</font><a name='line.1104'></a>
1105:         m<font color=#FF0000>.</font><b><font color=#000000>action</font></b><font color=#FF0000>(</font>time<font color=#FF0000>)</font><font color=#FF0000>;</font><a name='line.1105'></a>
1106:       <font color=#000000>}</font> <a name='line.1106'></a>
1107:     <font color=#000000>}</font>    <a name='line.1107'></a>
1108:   <font color=#000000>}</font><a name='line.1108'></a>
1109:   <a name='line.1109'></a>
1110:   <b><font color=#009900>// get portal for specific square</font></b><a name='line.1110'></a>
1111:   <b><font color=#0000FF>public</font></b> Portal <b><font color=#000000>getPortal</font></b><font color=#FF0000>(</font><font color=#0000FF>int</font> tx<font color=#FF0000>,</font><font color=#0000FF>int</font> ty<font color=#FF0000>)</font> <font color=#000000>{</font><a name='line.1111'></a>
1112:     Portal p<font color=#FF0000>=</font><font color=#FF0000>(</font>Portal<font color=#FF0000>)</font><b><font color=#000000>getObject</font></b><font color=#FF0000>(</font>tx<font color=#FF0000>,</font>ty<font color=#FF0000>,</font>Portal<font color=#FF0000>.</font><b><font color=#0000FF>class</font></b><font color=#FF0000>)</font><font color=#FF0000>;</font><a name='line.1112'></a>
1113:     <b><font color=#0000FF>if</font></b> <font color=#FF0000>(</font>p<font color=#FF0000>!</font><font color=#FF0000>=</font><b><font color=#0000FF>null</font></b><font color=#FF0000>)</font> <b><font color=#0000FF>return</font></b> p<font color=#FF0000>;</font><a name='line.1113'></a>
1114:     <a name='line.1114'></a>
1115:     <b><font color=#0000FF>if</font></b> <font color=#FF0000>(</font>entrance <b><font color=#0000FF>instanceof</font></b> EdgePortal<font color=#FF0000>)</font> <font color=#000000>{</font><a name='line.1115'></a>
1116:       EdgePortal e<font color=#FF0000>=</font><font color=#FF0000>(</font>EdgePortal<font color=#FF0000>)</font>entrance<font color=#FF0000>;</font><a name='line.1116'></a>
1117:       <b><font color=#0000FF>if</font></b> <font color=#FF0000>(</font>e<font color=#FF0000>.</font><b><font color=#000000>isEdge</font></b><font color=#FF0000>(</font>tx<font color=#FF0000>,</font>ty<font color=#FF0000>)</font><font color=#FF0000>)</font> <b><font color=#0000FF>return</font></b> e<font color=#FF0000>;</font><a name='line.1117'></a>
1118:     <font color=#000000>}</font><a name='line.1118'></a>
1119:      <a name='line.1119'></a>
1120:     <b><font color=#0000FF>if</font></b> <font color=#FF0000>(</font>exit <b><font color=#0000FF>instanceof</font></b> EdgePortal<font color=#FF0000>)</font> <font color=#000000>{</font><a name='line.1120'></a>
1121:       EdgePortal e<font color=#FF0000>=</font><font color=#FF0000>(</font>EdgePortal<font color=#FF0000>)</font>exit<font color=#FF0000>;</font><a name='line.1121'></a>
1122:       <b><font color=#0000FF>if</font></b> <font color=#FF0000>(</font>e<font color=#FF0000>.</font><b><font color=#000000>isEdge</font></b><font color=#FF0000>(</font>tx<font color=#FF0000>,</font>ty<font color=#FF0000>)</font><font color=#FF0000>)</font> <b><font color=#0000FF>return</font></b> e<font color=#FF0000>;</font><a name='line.1122'></a>
1123:     <font color=#000000>}</font> <a name='line.1123'></a>
1124:     <a name='line.1124'></a>
1125:     <b><font color=#009900>// no portal here</font></b><a name='line.1125'></a>
1126:     <b><font color=#0000FF>return</font></b> <b><font color=#0000FF>null</font></b><font color=#FF0000>;</font><a name='line.1126'></a>
1127:   <font color=#000000>}</font><a name='line.1127'></a>
1128:   <a name='line.1128'></a>
1129:   <b><font color=#009900>// exit map from specified location</font></b><a name='line.1129'></a>
1130:   <b><font color=#0000FF>public</font></b> <font color=#0000FF>void</font> <b><font color=#000000>exitMap</font></b><font color=#FF0000>(</font><font color=#0000FF>int</font> tx<font color=#FF0000>,</font> <font color=#0000FF>int</font> ty<font color=#FF0000>)</font> <font color=#000000>{</font><a name='line.1130'></a>
1131:     Hero h<font color=#FF0000>=</font>Game<font color=#FF0000>.</font>hero<font color=#FF0000>;</font><a name='line.1131'></a>
1132:     Portal p<font color=#FF0000>=</font><b><font color=#000000>getPortal</font></b><font color=#FF0000>(</font>tx<font color=#FF0000>,</font>ty<font color=#FF0000>)</font><font color=#FF0000>;</font><a name='line.1132'></a>
1133:     <a name='line.1133'></a>
1134:     <b><font color=#009900>// use default portal</font></b><a name='line.1134'></a>
1135:     <b><font color=#0000FF>if</font></b> <font color=#FF0000>(</font><font color=#FF0000>(</font>p<font color=#FF0000>=</font><font color=#FF0000>=</font><b><font color=#0000FF>null</font></b><font color=#FF0000>)</font><font color=#FF0000>&amp;</font><font color=#FF0000>&amp;</font><b><font color=#000000>canExit</font></b><font color=#FF0000>(</font><font color=#FF0000>)</font><font color=#FF0000>)</font> p<font color=#FF0000>=</font>entrance<font color=#FF0000>;</font><a name='line.1135'></a>
1136:     <a name='line.1136'></a>
1137:     <b><font color=#0000FF>if</font></b> <font color=#FF0000>(</font>p<font color=#FF0000>!</font><font color=#FF0000>=</font><b><font color=#0000FF>null</font></b><font color=#FF0000>)</font> <font color=#000000>{</font><a name='line.1137'></a>
1138:       p<font color=#FF0000>.</font><b><font color=#000000>travel</font></b><font color=#FF0000>(</font>h<font color=#FF0000>)</font><font color=#FF0000>;</font><a name='line.1138'></a>
1139:     <font color=#000000>}</font> <a name='line.1139'></a>
1140:   <font color=#000000>}</font><a name='line.1140'></a>
1141:   <a name='line.1141'></a>
1142:   <a name='line.1142'></a>
1143:   <b><font color=#009900>// set the message for this particular map</font></b><a name='line.1143'></a>
1144:   <b><font color=#0000FF>public</font></b> String <b><font color=#000000>getEnterMessage</font></b><font color=#FF0000>(</font><font color=#FF0000>)</font> <font color=#000000>{</font><a name='line.1144'></a>
1145:     <b><font color=#0000FF>return</font></b> <font color=#808080>"Welcome to The Tyrant's dungeon!"</font><font color=#FF0000>;</font>  <a name='line.1145'></a>
1146:   <font color=#000000>}</font><a name='line.1146'></a>
1147: <a name='line.1147'></a>
1148:   <b><font color=#009900>// Level name for display on status panel</font></b><a name='line.1148'></a>
1149:   <b><font color=#0000FF>public</font></b> String <b><font color=#000000>getLevelName</font></b><font color=#FF0000>(</font><font color=#FF0000>)</font> <font color=#000000>{</font><a name='line.1149'></a>
1150:     <b><font color=#0000FF>return</font></b> <font color=#808080>"The Tyrant's Dungeon"</font><font color=#FF0000>;</font>  <a name='line.1150'></a>
1151:   <font color=#000000>}</font><a name='line.1151'></a>
1152: <a name='line.1152'></a>
1153: <font color=#000000>}</font></tt><a name='line.1153'></a>
</pre><a name='line.1154'></a>
</body><a name='line.1155'></a>
</html><a name='line.1156'></a>
